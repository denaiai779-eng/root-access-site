<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Root Access — Week 1 Thursday (Interactive)</title>
<script src="https://cdn.jsdelivr.net/npm/localforage@1.10.0/dist/localforage.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563EB">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@400;500;600;700;800&family=Patrick+Hand&family=Quicksand:wght@400;500;600;700&family=Fredoka:wght@400;500;600;700&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }

:root {
    --math-primary: #2563EB;
    --math-light: #EFF6FF;
    --math-medium: #BFDBFE;
    --math-dark: #1E40AF;
    --science-primary: #059669;
    --science-light: #ECFDF5;
    --science-medium: #A7F3D0;
    --science-dark: #065F46;
    --social-primary: #EA580C;
    --social-light: #FFF7ED;
    --social-medium: #FED7AA;
    --social-dark: #9A3412;
    --ela-primary: #7C3AED;
    --ela-light: #F5F3FF;
    --ela-medium: #DDD6FE;
    --ela-dark: #5B21B6;
    --warmup-primary: #0891B2;
    --warmup-light: #ECFEFF;
    --warmup-medium: #A5F3FC;
    --warmup-dark: #155E75;
    --challenge-primary: #F59E0B;
    --challenge-light: #FFFBEB;
    --challenge-medium: #FDE68A;
    --challenge-dark: #92400E;
    --correct: #059669;
    --incorrect: #DC2626;
    --neutral: #64748B;
}

body {
    font-family: 'Quicksand', sans-serif;
    font-size: 16px;
    line-height: 1.6;
    color: #333;
    background: #f0f4f8;
    padding-bottom: 80px;
}

/* === TOP NAV BAR === */
.top-bar {
    position: sticky;
    top: 0;
    z-index: 100;
    background: white;
    border-bottom: 3px solid var(--math-primary);
    padding: 10px 20px;
    display: flex;
    align-items: center;
    gap: 12px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
}
.top-bar .logo {
    font-family: 'Baloo 2', cursive;
    font-weight: 800;
    font-size: 18px;
    color: var(--math-primary);
    white-space: nowrap;
    text-decoration: none;
}
.top-bar .logo:hover { opacity: 0.8; }
.student-name-area input {
    font-family: 'Quicksand', sans-serif;
    font-size: 14px;
    font-weight: 600;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 4px 10px;
    width: 120px;
    color: #333;
}
.student-name-area input:focus { border-color: var(--math-primary); outline: none; }
.xp-display {
    font-family: 'Fredoka', sans-serif;
    font-size: 14px;
    font-weight: 700;
    color: var(--challenge-dark);
    background: var(--challenge-light);
    border: 2px solid var(--challenge-medium);
    padding: 3px 12px;
    border-radius: 10px;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 4px;
}
.xp-display .xp-num { color: var(--challenge-primary); }
.progress-wrap {
    flex: 1;
    display: flex;
    align-items: center;
    gap: 8px;
    min-width: 80px;
}
.progress-bar-outer {
    flex: 1;
    height: 12px;
    background: #e2e8f0;
    border-radius: 6px;
    overflow: hidden;
}
.progress-bar-inner {
    height: 100%;
    background: linear-gradient(90deg, var(--math-primary), var(--ela-primary));
    border-radius: 6px;
    transition: width 0.4s ease;
    width: 0%;
}
.progress-text {
    font-family: 'Fredoka', sans-serif;
    font-size: 13px;
    font-weight: 600;
    color: var(--neutral);
    white-space: nowrap;
}
.save-status {
    font-family: 'Fredoka', sans-serif;
    font-size: 11px;
    color: var(--correct);
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.3s;
}
.save-status.show { opacity: 1; }

/* === SECTION NAV === */
.section-nav {
    position: sticky;
    top: 52px;
    z-index: 99;
    background: white;
    border-bottom: 1px solid #e2e8f0;
    padding: 6px 20px;
    display: flex;
    gap: 6px;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
.section-nav button {
    font-family: 'Fredoka', sans-serif;
    font-size: 12px;
    font-weight: 500;
    border: 2px solid #e2e8f0;
    border-radius: 16px;
    padding: 4px 14px;
    background: white;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
    color: #555;
}
.section-nav button:hover { border-color: #94a3b8; }
.section-nav button.completed { border-color: var(--correct); color: var(--correct); background: #ecfdf5; }

/* === VIEW PASSAGE BUTTON === */
.view-passage-btn {
    font-family: 'Fredoka', sans-serif;
    font-size: 12px;
    font-weight: 600;
    border: 2px solid var(--ela-primary);
    border-radius: 16px;
    padding: 4px 14px;
    background: white;
    color: var(--ela-dark);
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
    margin-left: auto;
    display: flex;
    align-items: center;
    gap: 4px;
}
.view-passage-btn:hover { background: var(--ela-primary); color: white; }
.view-passage-btn.popup-open { background: var(--ela-primary); color: white; }

/* === MOBILE PASSAGE DRAWER === */
.passage-drawer-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    z-index: 200;
}
.passage-drawer-overlay.open { display: block; }
.passage-drawer {
    position: absolute;
    top: 0; right: 0; bottom: 0;
    width: 85%;
    max-width: 400px;
    background: white;
    overflow-y: auto;
    transform: translateX(100%);
    transition: transform 0.3s ease;
    box-shadow: -4px 0 20px rgba(0,0,0,0.15);
}
.passage-drawer-overlay.open .passage-drawer { transform: translateX(0); }
.passage-drawer-header {
    position: sticky;
    top: 0;
    background: linear-gradient(135deg, var(--ela-light) 0%, #EDE9FE 100%);
    padding: 12px 16px;
    border-bottom: 2.5px solid var(--ela-primary);
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 1;
}
.passage-drawer-header span {
    font-family: 'Baloo 2', cursive;
    font-size: 16px;
    font-weight: 700;
    color: var(--ela-dark);
}
.passage-drawer-close {
    font-size: 22px;
    background: none;
    border: none;
    cursor: pointer;
    color: var(--ela-dark);
    padding: 0 4px;
    line-height: 1;
}

/* === MAIN CONTENT === */
.main-content {
    max-width: 820px;
    margin: 0 auto;
    padding: 0 20px;
}

/* === DAY HEADER === */
.day-header {
    margin: 0 -20px;
    padding: 32px 40px 24px;
    background: linear-gradient(135deg, #2563EB 0%, #3B82F6 50%, #60A5FA 100%);
    color: white;
    position: relative;
    overflow: hidden;
}
.day-header::after {
    content: '';
    position: absolute;
    top: -40px;
    right: -40px;
    width: 160px;
    height: 160px;
    background: rgba(255,255,255,0.08);
    border-radius: 50%;
}
.day-header h1 {
    font-family: 'Baloo 2', cursive;
    font-size: 36px;
    font-weight: 800;
    margin: 0;
    position: relative;
    z-index: 1;
}
.day-header .day-meta {
    font-family: 'Fredoka', sans-serif;
    font-size: 14px;
    color: rgba(255,255,255,0.85);
    font-weight: 500;
    margin-top: 4px;
    position: relative;
    z-index: 1;
}
.day-schedule {
    margin-top: 14px;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    position: relative;
    z-index: 1;
}
.day-schedule .block {
    font-family: 'Fredoka', sans-serif;
    font-size: 12px;
    font-weight: 500;
    background: rgba(255,255,255,0.18);
    padding: 4px 12px;
    border-radius: 12px;
    color: rgba(255,255,255,0.9);
}

/* === SECTION WRAPPER === */
.subject-section {
    margin: 28px 0;
    background: white;
    border-radius: 20px;
    padding: 24px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
}

/* === XP REWARD TOAST === */
.xp-toast {
    position: fixed;
    top: 70px;
    right: 20px;
    background: linear-gradient(135deg, #FFFBEB, #FEF3C7);
    border: 3px solid var(--challenge-primary);
    border-radius: 14px;
    padding: 12px 20px;
    font-family: 'Baloo 2', cursive;
    font-size: 18px;
    font-weight: 700;
    color: var(--challenge-dark);
    z-index: 200;
    transform: translateX(120%);
    transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
    box-shadow: 0 4px 16px rgba(245, 158, 11, 0.3);
}
.xp-toast.show { transform: translateX(0); }
.xp-toast .xp-amount { color: var(--challenge-primary); font-size: 22px; }

/* === SUBJECT BANNER === */
.subject-banner {
    padding: 14px 20px;
    border-radius: 16px;
    margin-bottom: 16px;
    border: 3px solid;
    display: flex;
    align-items: center;
    gap: 12px;
}
.subject-banner .icon { font-size: 24px; }
.subject-banner .title-group { flex: 1; }
.subject-banner h2 {
    font-family: 'Baloo 2', cursive;
    font-size: 22px;
    font-weight: 700;
    margin: 0;
    line-height: 1.2;
}
.subject-banner .time-badge {
    font-family: 'Fredoka', sans-serif;
    font-size: 12px;
    font-weight: 500;
    padding: 3px 10px;
    border-radius: 10px;
    background: rgba(255,255,255,0.7);
}

.banner-warmup { background: var(--warmup-light); border-color: var(--warmup-primary); }
.banner-warmup h2 { color: var(--warmup-dark); }
.banner-warmup .time-badge { color: var(--warmup-dark); }
.banner-reading { background: var(--ela-light); border-color: var(--ela-primary); }
.banner-reading h2 { color: var(--ela-dark); }
.banner-reading .time-badge { color: var(--ela-dark); }
.banner-math { background: var(--math-light); border-color: var(--math-primary); }
.banner-math h2 { color: var(--math-dark); }
.banner-math .time-badge { color: var(--math-dark); }
.banner-grammar { background: var(--ela-light); border-color: var(--ela-primary); }
.banner-grammar h2 { color: var(--ela-dark); }
.banner-grammar .time-badge { color: var(--ela-dark); }
.banner-science { background: var(--science-light); border-color: var(--science-primary); }
.banner-science h2 { color: var(--science-dark); }
.banner-science .time-badge { color: var(--science-dark); }

.banner-social { background: var(--social-light); border-color: var(--social-primary); }
.banner-social h2 { color: var(--social-dark); }
.banner-social .time-badge { color: var(--social-dark); }

/* === GOAL BOX === */
.goal-box {
    font-size: 14px;
    font-weight: 500;
    color: #555;
    padding: 10px 16px;
    background: #f8f9fa;
    border: 2px dashed #ddd;
    border-radius: 10px;
    margin-bottom: 18px;
    font-style: italic;
}
.goal-box strong { color: #333; font-style: normal; }

/* === READING PASSAGE === */
.passage-box {
    border: 2.5px solid var(--ela-primary);
    border-radius: 16px;
    overflow: hidden;
    margin: 16px 0;
}
.passage-header {
    background: linear-gradient(135deg, var(--ela-light) 0%, #EDE9FE 100%);
    padding: 10px 18px;
    border-bottom: 2.5px solid var(--ela-primary);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 8px;
}
.passage-title {
    font-family: 'Baloo 2', cursive;
    font-size: 18px;
    font-weight: 700;
    color: var(--ela-dark);
}
.passage-meta {
    font-family: 'Fredoka', sans-serif;
    font-size: 11px;
    color: var(--ela-dark);
    background: var(--ela-medium);
    padding: 3px 10px;
    border-radius: 8px;
    font-weight: 500;
}
.read-aloud-btn {
    font-family: 'Fredoka', sans-serif;
    font-size: 12px;
    font-weight: 600;
    border: 2px solid var(--ela-primary);
    border-radius: 8px;
    padding: 4px 12px;
    background: white;
    color: var(--ela-dark);
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 4px;
}
.read-aloud-btn:hover { background: var(--ela-primary); color: white; }
.read-aloud-btn.playing { background: var(--ela-primary); color: white; }
.passage-body {
    padding: 18px 20px;
    font-family: 'Lora', Georgia, serif;
    font-size: 16px;
    line-height: 1.85;
    color: #2d2d2d;
}
.passage-body p { margin-bottom: 14px; text-indent: 24px; }
.passage-body p:first-child { text-indent: 0; }
.passage-body p.reading-highlight { background: #FEF3C7; border-radius: 4px; margin: -2px -4px; padding: 2px 4px; }

/* === TEXT HIGHLIGHTING TOOL === */
.highlight-toolbar {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 8px 18px;
    background: #F8FAFC;
    border-bottom: 2px solid var(--ela-primary);
    flex-wrap: wrap;
}
.highlight-toolbar-label {
    font-family: 'Fredoka', sans-serif;
    font-size: 12px;
    font-weight: 600;
    color: var(--ela-dark);
    margin-right: 4px;
}
.hl-btn {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 3px solid transparent;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
}
.hl-btn:hover { transform: scale(1.15); }
.hl-btn.active { border-color: #1e293b; box-shadow: 0 0 0 2px white, 0 0 0 4px #1e293b; transform: scale(1.15); }
.hl-btn-yellow { background: #FDE68A; }
.hl-btn-green { background: #A7F3D0; }
.hl-btn-pink { background: #FBCFE8; }
.hl-btn-eraser {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid #cbd5e1;
    background: white;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    margin-left: 4px;
}
.hl-btn-eraser:hover { border-color: #ef4444; background: #fef2f2; }
.hl-btn-eraser.active { border-color: #ef4444; background: #fef2f2; box-shadow: 0 0 0 2px white, 0 0 0 4px #ef4444; }
.hl-count {
    font-family: 'Fredoka', sans-serif;
    font-size: 11px;
    color: #64748b;
    margin-left: auto;
}
.hl-count strong { color: var(--ela-dark); }
mark.hl-yellow { background: #FDE68A; border-radius: 3px; padding: 0 1px; cursor: pointer; }
mark.hl-green { background: #A7F3D0; border-radius: 3px; padding: 0 1px; cursor: pointer; }
mark.hl-pink { background: #FBCFE8; border-radius: 3px; padding: 0 1px; cursor: pointer; }
.passage-body.eraser-mode mark { cursor: crosshair; opacity: 0.7; }
.passage-body.eraser-mode mark:hover { opacity: 0.4; text-decoration: line-through; }
.passage-body.hl-active { cursor: text; }
.passage-body.hl-active::selection, .passage-body.hl-active *::selection {
    background: var(--hl-sel-color, #FDE68A);
}
.hl-legend {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 4px;
}
.hl-legend-item {
    display: flex;
    align-items: center;
    gap: 4px;
    font-family: 'Quicksand', sans-serif;
    font-size: 11px;
    color: #475569;
}
.hl-legend-swatch {
    width: 14px;
    height: 14px;
    border-radius: 3px;
    display: inline-block;
}
.active-reading-tip {
    background: linear-gradient(135deg, #EDE9FE 0%, #F3E8FF 100%);
    border: 2px solid var(--ela-primary);
    border-radius: 14px;
    padding: 18px 20px;
    margin: 16px 0;
}
.active-reading-tip h3 {
    font-family: 'Baloo 2', cursive;
    font-size: 18px;
    color: var(--ela-dark);
    margin: 0 0 8px;
}
.active-reading-tip p {
    font-family: 'Quicksand', sans-serif;
    font-size: 14px;
    color: #4c1d95;
    margin: 0 0 8px;
    line-height: 1.5;
}
.active-reading-tip p:last-child { margin-bottom: 0; }
.hl-color-key {
    display: inline-block;
    padding: 1px 8px;
    border-radius: 4px;
    font-weight: 600;
    font-size: 13px;
}
.hl-strategy-card {
    background: white;
    border: 2px solid var(--ela-medium);
    border-radius: 12px;
    padding: 12px 16px;
    margin: 10px 0;
}
.hl-strategy-card h4 {
    font-family: 'Fredoka', sans-serif;
    font-size: 14px;
    font-weight: 600;
    margin: 0 0 6px;
    display: flex;
    align-items: center;
    gap: 6px;
}
.hl-strategy-card p {
    font-family: 'Quicksand', sans-serif;
    font-size: 13px;
    color: #475569;
    margin: 0 0 6px;
    line-height: 1.5;
}
.hl-strategy-card p:last-child { margin-bottom: 0; }
.hl-strategy-card .hl-example {
    font-family: 'Lora', Georgia, serif;
    font-size: 13px;
    color: #334155;
    padding: 6px 10px;
    border-radius: 6px;
    margin-top: 6px;
    line-height: 1.6;
    border-left: 3px solid;
}
.hl-example-yellow { background: #FEF9C3; border-color: #CA8A04; }
.hl-example-green { background: #ECFDF5; border-color: #059669; }
.hl-example-pink { background: #FDF2F8; border-color: #DB2777; }
.hl-ask {
    font-family: 'Patrick Hand', cursive;
    font-size: 15px;
    color: #6b21a8;
    font-style: italic;
    margin: 4px 0;
}
.hl-try-it {
    background: #7C3AED;
    color: white;
    font-family: 'Fredoka', sans-serif;
    font-size: 13px;
    font-weight: 600;
    padding: 10px 16px;
    border-radius: 10px;
    margin-top: 12px;
    text-align: center;
    line-height: 1.5;
}

/* === GUIDED PRACTICE === */
.guided-practice {
    background: linear-gradient(135deg, #F0FDF4 0%, #ECFDF5 100%);
    border: 2.5px solid var(--science-primary);
    border-radius: 16px;
    padding: 20px;
    margin: 20px 0;
}
.guided-practice-header {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 12px;
}
.guided-practice-header h3 {
    font-family: 'Baloo 2', cursive;
    font-size: 18px;
    color: var(--science-dark);
    margin: 0;
}
.guided-practice-header .gp-badge {
    font-family: 'Fredoka', sans-serif;
    font-size: 11px;
    font-weight: 600;
    background: var(--science-primary);
    color: white;
    padding: 3px 10px;
    border-radius: 8px;
}
.gp-intro {
    font-family: 'Quicksand', sans-serif;
    font-size: 14px;
    color: #065F46;
    line-height: 1.5;
    margin-bottom: 14px;
}
.gp-step {
    background: white;
    border: 2px solid var(--science-medium);
    border-radius: 12px;
    padding: 14px 16px;
    margin-bottom: 12px;
    position: relative;
}
.gp-step-number {
    position: absolute;
    top: -10px;
    left: 14px;
    background: var(--science-primary);
    color: white;
    font-family: 'Fredoka', sans-serif;
    font-size: 12px;
    font-weight: 700;
    width: 22px;
    height: 22px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}
.gp-step h4 {
    font-family: 'Fredoka', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: var(--science-dark);
    margin: 2px 0 6px;
}
.gp-step p {
    font-family: 'Quicksand', sans-serif;
    font-size: 13px;
    color: #334155;
    margin: 0 0 6px;
    line-height: 1.5;
}
.gp-step p:last-child { margin-bottom: 0; }
.gp-tchart {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0;
    border: 2.5px solid var(--science-primary);
    border-radius: 12px;
    overflow: hidden;
    margin: 10px 0;
}
.gp-tchart-header {
    font-family: 'Fredoka', sans-serif;
    font-size: 13px;
    font-weight: 700;
    text-align: center;
    padding: 8px;
    color: white;
    background: var(--science-primary);
}
.gp-tchart-header:first-child { border-right: 2px solid rgba(255,255,255,0.3); }
.gp-tchart-cell {
    padding: 8px 10px;
    border-top: 2px solid var(--science-medium);
    min-height: 44px;
}
.gp-tchart-cell:nth-child(odd) { border-right: 2px solid var(--science-medium); }
.gp-tchart-cell input {
    width: 100%;
    border: none;
    border-bottom: 2px dashed var(--science-medium);
    background: transparent;
    font-family: 'Patrick Hand', cursive;
    font-size: 15px;
    color: #1e293b;
    padding: 4px 0;
    outline: none;
}
.gp-tchart-cell input:focus { border-bottom-color: var(--science-primary); }
.gp-tchart-cell input::placeholder { color: #94a3b8; font-style: italic; }
.gp-sentence-starter {
    font-family: 'Patrick Hand', cursive;
    font-size: 16px;
    color: #065F46;
    background: #D1FAE5;
    border: 2px dashed var(--science-primary);
    border-radius: 10px;
    padding: 10px 14px;
    margin: 10px 0 0;
    line-height: 1.5;
}
.gp-sentence-starter span {
    color: #9CA3AF;
    font-style: italic;
}

/* === VOCAB HIGHLIGHT === */
.vocab-highlight {
    background: #FEF3C7;
    padding: 1px 6px;
    border-radius: 4px;
    font-weight: 500;
    cursor: pointer;
    position: relative;
    border-bottom: 2px dashed var(--challenge-primary);
    transition: background 0.2s;
}
.vocab-highlight:hover, .vocab-highlight.tapped { background: #FDE68A; }
.vocab-tooltip {
    display: none;
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: #1e293b;
    color: white;
    font-family: 'Quicksand', sans-serif;
    font-size: 13px;
    padding: 8px 14px;
    border-radius: 10px;
    max-width: 300px;
    white-space: normal;
    z-index: 50;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    margin-bottom: 6px;
    line-height: 1.4;
    pointer-events: none;
}
.vocab-highlight:hover .vocab-tooltip,
.vocab-highlight.tapped .vocab-tooltip { display: block; }
.vocab-tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-top-color: #1e293b;
}

/* === VOCAB BOX === */
.vocab-box {
    border: 2px solid var(--challenge-primary);
    border-radius: 12px;
    overflow: hidden;
    margin: 14px 0;
}
.vocab-box-header {
    background: var(--challenge-light);
    padding: 8px 16px;
    font-family: 'Fredoka', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: var(--challenge-dark);
    border-bottom: 2px solid var(--challenge-primary);
}
.vocab-entry {
    padding: 10px 16px;
    border-bottom: 1.5px solid #f0f0f0;
    display: flex;
    gap: 12px;
    align-items: baseline;
}
.vocab-entry:last-child { border-bottom: none; }
.vocab-word {
    font-family: 'Fredoka', sans-serif;
    font-weight: 600;
    color: var(--ela-dark);
    min-width: 110px;
}
.vocab-def { font-size: 14px; color: #555; }

/* === INTERACTIVE INPUTS === */
.answer-input {
    font-family: 'Patrick Hand', cursive;
    font-size: 18px;
    border: none;
    border-bottom: 3px solid var(--math-primary);
    padding: 4px 8px;
    min-width: 100px;
    background: transparent;
    color: #333;
    outline: none;
    transition: border-color 0.3s;
}
.answer-input:focus { border-bottom-color: var(--ela-primary); }
.answer-input.correct { border-bottom-color: var(--correct); color: var(--correct); }
.answer-input.incorrect { border-bottom-color: var(--incorrect); color: var(--incorrect); }
.answer-input.short { min-width: 60px; width: 80px; }
.answer-input.medium { min-width: 120px; width: 160px; }
.answer-input.long { min-width: 200px; width: 100%; }

.answer-textarea {
    font-family: 'Patrick Hand', cursive;
    font-size: 17px;
    width: 100%;
    min-height: 70px;
    border: 2.5px dashed #ccc;
    border-radius: 10px;
    padding: 10px 14px;
    resize: vertical;
    background: #fafafa;
    color: #333;
    outline: none;
    line-height: 1.6;
    transition: border-color 0.3s;
}
.answer-textarea:focus { border-color: var(--ela-primary); background: white; }
.answer-textarea.has-content { border-color: var(--correct); border-style: solid; }

/* Word count badge */
.word-count {
    font-family: 'Fredoka', sans-serif;
    font-size: 11px;
    color: #999;
    text-align: right;
    margin-top: 2px;
}
.word-count.good { color: var(--correct); }

/* === PLACE VALUE CHART === */
.pv-chart {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin: 12px 0 18px;
    border: 2.5px solid #e0e0e0;
    border-radius: 14px;
    overflow: hidden;
}
.pv-chart th {
    background: var(--math-primary);
    color: white;
    font-family: 'Fredoka', sans-serif;
    font-weight: 600;
    font-size: 13px;
    text-align: center;
    padding: 10px 14px;
}
.pv-chart td {
    padding: 8px;
    border-bottom: 2px solid #f0f0f0;
    border-right: 2px solid #f0f0f0;
    text-align: center;
    background: white;
}
.pv-chart td:last-child { border-right: none; }
.pv-chart tr:last-child td { border-bottom: none; }
.pv-chart input {
    font-family: 'Fredoka', sans-serif;
    font-size: 20px;
    font-weight: 700;
    width: 50px;
    text-align: center;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    padding: 6px;
    color: var(--math-dark);
    outline: none;
}
.pv-chart input:focus { border-color: var(--math-primary); }
.pv-chart input.correct { border-color: var(--correct); background: #ecfdf5; }
.pv-chart input.incorrect { border-color: var(--incorrect); background: #fef2f2; }

/* === QUESTION NUMBERS === */
.q-number, .m-number, .g-number {
    font-family: 'Fredoka', sans-serif;
    font-weight: 700;
    font-size: 13px;
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    margin-right: 8px;
    vertical-align: middle;
    flex-shrink: 0;
}
.q-number { background: var(--ela-primary); }
.m-number { background: var(--math-primary); }
.g-number { background: var(--ela-primary); }

.q-label {
    font-family: 'Fredoka', sans-serif;
    font-size: 10px;
    font-weight: 500;
    color: #999;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    margin-left: 36px;
    margin-bottom: 2px;
}

/* === QUESTIONS === */
.question {
    margin-bottom: 20px;
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
}
.question:last-child { border-bottom: none; }
.problem-text {
    font-size: 15px;
    line-height: 1.6;
    margin-bottom: 8px;
    font-weight: 500;
}
.problem-text strong { font-weight: 700; color: #1a1a1a; }
.q-text { font-size: 15px; line-height: 1.6; margin-bottom: 8px; font-weight: 500; }

/* === MATH LESSON BOX === */
.math-lesson-box {
    background: var(--math-light);
    border: 2px solid var(--math-medium);
    border-radius: 14px;
    padding: 18px 20px;
    margin: 14px 0;
}
.math-lesson-box h3 {
    font-family: 'Baloo 2', cursive;
    font-size: 18px;
    font-weight: 700;
    color: var(--math-dark);
    margin-bottom: 10px;
}
.math-lesson-box p { font-size: 15px; margin-bottom: 8px; line-height: 1.6; }
.math-example {
    background: white;
    border: 2px solid var(--math-medium);
    border-radius: 10px;
    padding: 14px 16px;
    margin: 10px 0;
}
.math-example .label {
    font-family: 'Fredoka', sans-serif;
    font-size: 11px;
    font-weight: 600;
    color: var(--math-primary);
    text-transform: uppercase;
    margin-bottom: 4px;
}

/* === GRAMMAR === */
.grammar-rule-box {
    background: var(--ela-light);
    border: 2.5px solid var(--ela-primary);
    border-radius: 14px;
    padding: 18px 20px;
    margin: 14px 0;
}
.grammar-rule-box h3 {
    font-family: 'Baloo 2', cursive;
    font-size: 18px;
    font-weight: 700;
    color: var(--ela-dark);
    margin-bottom: 10px;
}
.grammar-rule {
    background: white;
    border: 2px solid var(--ela-medium);
    border-radius: 10px;
    padding: 12px 16px;
    margin: 10px 0;
}
.grammar-rule .rule-label {
    font-family: 'Fredoka', sans-serif;
    font-size: 11px;
    font-weight: 600;
    color: var(--ela-primary);
    text-transform: uppercase;
    margin-bottom: 4px;
}
.grammar-example {
    font-family: 'Lora', serif;
    font-size: 15px;
    margin: 6px 0;
    padding-left: 12px;
    border-left: 3px solid var(--ela-medium);
}
.grammar-correct { color: var(--correct); }
.grammar-incorrect { color: #DC2626; text-decoration: line-through; }

/* === S/F TOGGLE === */
.sf-toggle {
    display: inline-flex;
    gap: 4px;
    margin-left: 10px;
    vertical-align: middle;
}
.sf-toggle button {
    font-family: 'Fredoka', sans-serif;
    font-size: 14px;
    font-weight: 700;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    border: 3px solid #e2e8f0;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
    color: #555;
}
.sf-toggle button:hover { border-color: var(--ela-primary); }
.sf-toggle button.selected { border-color: var(--ela-primary); background: var(--ela-primary); color: white; }
.sf-toggle button.correct-answer { border-color: var(--correct); background: var(--correct); color: white; }
.sf-toggle button.wrong-answer { border-color: var(--incorrect); background: #fef2f2; color: var(--incorrect); }

/* === FIX THE SENTENCE === */
.fix-sentence-box {
    background: #FFF7ED;
    border: 2px solid #EA580C;
    border-radius: 12px;
    padding: 14px 18px;
    margin: 12px 0;
}
.fix-sentence-box .label {
    font-family: 'Fredoka', sans-serif;
    font-size: 11px;
    font-weight: 600;
    color: var(--social-dark);
    text-transform: uppercase;
    margin-bottom: 8px;
}
.fix-sentence-original {
    font-family: 'Patrick Hand', cursive;
    font-size: 18px;
    color: #555;
    margin-bottom: 10px;
    line-height: 1.8;
}
.fix-error {
    /* No visual hint — student must find the errors themselves */
}
.fix-results {
    margin-top: 14px;
}
.fix-result-item {
    font-family: 'Quicksand', sans-serif;
    font-size: 14px;
    padding: 8px 12px;
    border-radius: 10px;
    margin-bottom: 8px;
    line-height: 1.5;
    display: flex;
    align-items: flex-start;
    gap: 8px;
}
.fix-result-item .fix-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
.fix-result-item.found { background: #ECFDF5; border: 1.5px solid #A7F3D0; }
.fix-result-item.missed { background: #FEF2F2; border: 1.5px solid #FECACA; }
.fix-result-item .fix-wrong { text-decoration: line-through; color: var(--incorrect); font-weight: 600; }
.fix-result-item .fix-right { color: var(--correct); font-weight: 700; }
.fix-result-item .fix-rule { font-size: 12px; color: #6B7280; font-style: italic; display: block; margin-top: 2px; }
.fix-score {
    font-family: 'Fredoka', sans-serif;
    font-size: 15px;
    font-weight: 600;
    text-align: center;
    padding: 10px;
    border-radius: 10px;
    margin-top: 10px;
}
.fix-score.perfect { background: #ECFDF5; color: var(--correct); border: 2px solid #A7F3D0; }
.fix-score.good { background: var(--challenge-light); color: var(--challenge-dark); border: 2px solid var(--challenge-medium); }
.fix-score.needs-work { background: #FEF2F2; color: var(--incorrect); border: 2px solid #FECACA; }

/* === SPELLING === */
.spelling-box {
    border: 2.5px solid var(--warmup-primary);
    border-radius: 14px;
    overflow: visible;
    margin: 14px 0;
}
.spelling-header {
    background: var(--warmup-light);
    padding: 10px 18px;
    font-family: 'Baloo 2', cursive;
    font-size: 16px;
    font-weight: 700;
    color: var(--warmup-dark);
    border-bottom: 2.5px solid var(--warmup-primary);
}
.spelling-content { padding: 14px 18px; }
.spelling-words {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin: 8px 0;
}
.spelling-word {
    font-family: 'Fredoka', sans-serif;
    font-size: 14px;
    font-weight: 500;
    background: white;
    border: 2px solid var(--warmup-medium);
    padding: 6px 14px;
    border-radius: 10px;
    color: var(--warmup-dark);
    cursor: pointer;
    transition: all 0.2s;
    user-select: none;
}
.spelling-word:hover { background: var(--warmup-light); border-color: var(--warmup-primary); transform: scale(1.05); }
.spelling-word:active { transform: scale(0.95); }
.spelling-word .prefix { color: var(--warmup-primary); font-weight: 700; text-decoration: underline; }

/* Spelling practice grid */
.spelling-practice {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-top: 12px;
}
.spelling-practice-item {
    display: flex;
    align-items: center;
    gap: 8px;
}
.spelling-practice-item .sp-num {
    font-family: 'Fredoka', sans-serif;
    font-size: 12px;
    font-weight: 600;
    color: #999;
    min-width: 20px;
}
.spelling-practice-item input {
    font-family: 'Patrick Hand', cursive;
    font-size: 16px;
    flex: 1;
    border: none;
    border-bottom: 2.5px dashed var(--warmup-medium);
    padding: 4px 6px;
    background: transparent;
    outline: none;
    color: #333;
}
.spelling-practice-item input:focus { border-bottom-color: var(--warmup-primary); }
.spelling-practice-item input.correct { border-bottom-color: var(--correct); color: var(--correct); border-bottom-style: solid; }
.spelling-practice-item input.incorrect { border-bottom-color: var(--incorrect); color: var(--incorrect); border-bottom-style: solid; }

/* === SUBSECTION PILL === */
.subsection-pill {
    font-family: 'Fredoka', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: white;
    background: #64748B;
    padding: 6px 18px;
    border-radius: 20px;
    display: inline-block;
    margin: 18px 0 12px;
}
.subsection-pill.math { background: var(--math-primary); }
.subsection-pill.ela { background: var(--ela-primary); }
.subsection-pill.science { background: var(--science-primary); }
.subsection-pill.social { background: var(--social-primary); }

/* === CHALLENGE BOX === */
.challenge-box {
    border: 3px solid var(--challenge-primary);
    border-radius: 16px;
    overflow: hidden;
    margin: 22px 0;
}
.challenge-header {
    background: linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%);
    padding: 12px 20px;
    font-family: 'Baloo 2', cursive;
    font-weight: 700;
    font-size: 18px;
    color: var(--challenge-dark);
    border-bottom: 3px solid var(--challenge-primary);
}
.challenge-content { padding: 16px 20px; }

/* === EXPERIMENT BOX === */
.experiment-box {
    border: 2.5px solid var(--science-primary);
    border-radius: 14px;
    overflow: hidden;
    margin: 14px 0;
}
.experiment-header {
    background: var(--science-light);
    padding: 10px 18px;
    font-family: 'Baloo 2', cursive;
    font-size: 16px;
    font-weight: 700;
    color: var(--science-dark);
    border-bottom: 2.5px solid var(--science-primary);
}
.experiment-content { padding: 14px 18px; }
.print-experiment-tip {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 10px;
    padding: 8px 18px;
    background: #f0fdf4;
    border-bottom: 1px solid #d1fae5;
    font-size: 13px;
    color: #065f46;
    font-weight: 500;
}
.print-experiment-tip button {
    font-family: 'Fredoka', sans-serif;
    font-size: 12px;
    font-weight: 600;
    padding: 5px 14px;
    border-radius: 8px;
    border: 2px solid var(--science-primary);
    background: white;
    color: var(--science-dark);
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.2s;
}
.print-experiment-tip button:hover { background: var(--science-light); }
.materials-list {
    background: #f8f9fa;
    border-radius: 10px;
    padding: 12px 16px;
    margin: 8px 0;
}
.materials-list h4 {
    font-family: 'Fredoka', sans-serif;
    font-size: 13px;
    font-weight: 600;
    color: var(--science-dark);
    text-transform: uppercase;
    margin-bottom: 6px;
}
.materials-list li { font-size: 14px; margin-bottom: 3px; }
.materials-list ul { padding-left: 20px; }

/* === DATA TABLE === */
.data-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    margin: 12px 0 18px;
    border: 2.5px solid var(--science-primary);
    border-radius: 14px;
    overflow: hidden;
}
.data-table th {
    background: var(--science-primary);
    color: white;
    font-family: 'Fredoka', sans-serif;
    font-weight: 600;
    font-size: 13px;
    text-align: center;
    padding: 10px 12px;
}
.data-table td {
    padding: 8px;
    border-bottom: 2px solid #f0f0f0;
    border-right: 2px solid #f0f0f0;
    text-align: center;
    background: white;
}
.data-table td:last-child { border-right: none; }
.data-table tr:last-child td { border-bottom: none; }
.data-table input {
    font-family: 'Patrick Hand', cursive;
    font-size: 16px;
    width: 100%;
    text-align: center;
    border: 2px solid #e2e8f0;
    border-radius: 6px;
    padding: 4px;
    outline: none;
}
.data-table input:focus { border-color: var(--science-primary); }

/* === CHECK ANSWERS BUTTON === */
.check-btn {
    font-family: 'Fredoka', sans-serif;
    font-size: 15px;
    font-weight: 600;
    padding: 10px 24px;
    border-radius: 12px;
    border: none;
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 12px;
}
.check-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
.check-btn:active { transform: translateY(0); }
.check-btn.math-check { background: var(--math-primary); color: white; }
.check-btn.ela-check { background: var(--ela-primary); color: white; }
.check-btn.science-check { background: var(--science-primary); color: white; }
.check-btn.warmup-check { background: var(--warmup-primary); color: white; }

/* === FEEDBACK === */
.feedback {
    font-family: 'Fredoka', sans-serif;
    font-size: 13px;
    font-weight: 500;
    padding: 6px 12px;
    border-radius: 8px;
    margin-top: 6px;
    display: none;
}
.feedback.correct { display: block; background: #ecfdf5; color: var(--correct); border: 1.5px solid var(--science-medium); }
.feedback.incorrect { display: block; background: #fef2f2; color: var(--incorrect); border: 1.5px solid #fecaca; }
.feedback.hint { display: block; background: var(--challenge-light); color: var(--challenge-dark); border: 1.5px solid var(--challenge-medium); }

/* === RETYPE MODE === */
.retype-mode {
    border-bottom-color: var(--challenge-dark) !important;
    border-bottom-style: solid !important;
    color: var(--challenge-dark) !important;
    background: #FFFBEB !important;
    animation: retypePulse 1.5s ease-in-out infinite;
}
@keyframes retypePulse {
    0%, 100% { box-shadow: 0 2px 0 var(--challenge-dark); }
    50% { box-shadow: 0 2px 8px rgba(245, 158, 11, 0.4); }
}
.retype-hint {
    font-family: 'Fredoka', sans-serif;
    font-size: 13px;
    font-weight: 500;
    color: var(--challenge-dark);
    background: var(--challenge-light);
    border: 1.5px solid var(--challenge-medium);
    padding: 6px 12px;
    border-radius: 8px;
    margin-top: 4px;
    display: block;
}
.retype-hint strong { color: #B45309; font-size: 15px; }
.spelling-practice-item .retype-hint { margin-top: 2px; font-size: 12px; }
.spelling-practice-item input.retype-mode { border-bottom-color: var(--challenge-dark) !important; color: var(--challenge-dark) !important; }
.xp-toast.half .xp-toast-label::after { content: ' (helped)'; font-size: 11px; opacity: 0.7; }

/* === READING LOG === */
.reading-log-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0;
    border: 2.5px solid #94a3b8;
    border-radius: 14px;
    overflow: hidden;
    margin-top: 8px;
}
.reading-log-table th {
    background: #475569;
    color: white;
    font-family: 'Fredoka', sans-serif;
    font-weight: 600;
    font-size: 13px;
    padding: 10px 12px;
    text-align: left;
}
.reading-log-table td { padding: 8px; background: white; }
.reading-log-table input,
.reading-log-table textarea {
    font-family: 'Patrick Hand', cursive;
    font-size: 16px;
    width: 100%;
    border: 2px solid #e2e8f0;
    border-radius: 6px;
    padding: 6px 8px;
    outline: none;
}
.reading-log-table input:focus,
.reading-log-table textarea:focus { border-color: #475569; }

/* === TIMER === */
.timer-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 12px 0;
    padding: 10px 16px;
    background: #f8fafc;
    border-radius: 10px;
    border: 2px solid #e2e8f0;
}
.timer-display {
    font-family: 'Fredoka', sans-serif;
    font-size: 28px;
    font-weight: 700;
    color: #334155;
    min-width: 80px;
}
.timer-btn {
    font-family: 'Fredoka', sans-serif;
    font-size: 13px;
    font-weight: 600;
    padding: 6px 16px;
    border-radius: 8px;
    border: 2px solid #e2e8f0;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
    color: #555;
}
.timer-btn:hover { border-color: #94a3b8; }
.timer-btn.active { background: var(--correct); color: white; border-color: var(--correct); }

/* === SECTION COMPLETE === */
.section-complete {
    text-align: center;
    padding: 16px;
    margin-top: 16px;
    background: #ecfdf5;
    border-radius: 12px;
    border: 2px solid var(--science-medium);
    display: none;
}
.section-complete.show { display: block; }
.section-complete .emoji { font-size: 32px; }
.section-complete .msg {
    font-family: 'Baloo 2', cursive;
    font-size: 18px;
    font-weight: 700;
    color: var(--correct);
    margin-top: 4px;
}

/* === RUBRIC FEEDBACK === */
.rubric-result {
    margin: 8px 0;
    padding: 10px 14px;
    border-radius: 10px;
    border: 2px solid #e2e8f0;
    background: #f8fafc;
    font-family: 'Quicksand', sans-serif;
    font-size: 14px;
}
.rubric-result.rubric-mastery { border-color: var(--science-medium); background: var(--science-light); }
.rubric-result.rubric-proficient { border-color: var(--math-medium); background: var(--math-light); }
.rubric-result.rubric-developing { border-color: var(--challenge-medium); background: var(--challenge-light); }
.rubric-result.rubric-beginning { border-color: var(--social-medium); background: var(--social-light); }
.rubric-result.rubric-empty { display: none; }
.rubric-header {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 4px;
}
.rubric-icon { font-size: 18px; }
.rubric-level {
    font-family: 'Fredoka', sans-serif;
    font-weight: 600;
    font-size: 14px;
}
.rubric-strengths {
    color: var(--correct);
    font-weight: 600;
    font-size: 13px;
    margin-bottom: 2px;
}
.rubric-tips {
    color: #555;
    font-size: 13px;
    line-height: 1.5;
}
.review-btn {
    font-family: 'Fredoka', sans-serif;
    font-size: 14px;
    font-weight: 600;
    padding: 10px 24px;
    border-radius: 10px;
    border: 2px solid var(--ela-primary);
    background: var(--ela-light);
    color: var(--ela-dark);
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 12px;
}
.review-btn:hover { background: var(--ela-primary); color: white; }
.section-encouragement {
    text-align: center;
    padding: 14px 18px;
    border-radius: 12px;
    margin-top: 16px;
    font-family: 'Fredoka', sans-serif;
    font-size: 15px;
    font-weight: 600;
    line-height: 1.5;
}
.encourage-mastery { background: var(--science-light); border: 2px solid var(--science-medium); color: var(--science-dark); }
.encourage-good { background: var(--math-light); border: 2px solid var(--math-medium); color: var(--math-dark); }
.encourage-growing { background: var(--challenge-light); border: 2px solid var(--challenge-medium); color: var(--challenge-dark); }
.encourage-start { background: #f8fafc; border: 2px solid #e2e8f0; color: #555; }

/* === OCR SCANNER MODAL === */
.ocr-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    z-index: 300;
    align-items: center;
    justify-content: center;
}
.ocr-modal.open { display: flex; }
.ocr-box {
    background: white;
    border-radius: 20px;
    padding: 24px;
    max-width: 500px;
    width: 92%;
    max-height: 90vh;
    overflow-y: auto;
    box-shadow: 0 12px 40px rgba(0,0,0,0.3);
}
.ocr-box h3 {
    font-family: 'Baloo 2', cursive;
    font-size: 20px;
    font-weight: 700;
    color: var(--math-dark);
    margin-bottom: 12px;
    text-align: center;
}
.ocr-capture-area {
    border: 3px dashed #cbd5e1;
    border-radius: 14px;
    padding: 24px;
    text-align: center;
    background: #f8fafc;
    margin-bottom: 14px;
    cursor: pointer;
    transition: all 0.2s;
}
.ocr-capture-area:hover { border-color: var(--math-primary); background: var(--math-light); }
.ocr-capture-area .ocr-icon { font-size: 40px; margin-bottom: 8px; }
.ocr-capture-area .ocr-label {
    font-family: 'Fredoka', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: #555;
}
.ocr-preview img {
    max-width: 100%;
    border-radius: 10px;
    border: 2px solid #e2e8f0;
    margin-bottom: 12px;
}
.ocr-progress {
    text-align: center;
    padding: 16px;
    display: none;
}
.ocr-progress.show { display: block; }
.ocr-progress-bar {
    width: 100%;
    height: 8px;
    background: #e2e8f0;
    border-radius: 4px;
    overflow: hidden;
    margin: 8px 0;
}
.ocr-progress-fill {
    height: 100%;
    background: var(--math-primary);
    border-radius: 4px;
    transition: width 0.3s;
    width: 0%;
}
.ocr-progress-text {
    font-family: 'Fredoka', sans-serif;
    font-size: 13px;
    color: #555;
}
.ocr-result-area {
    display: none;
}
.ocr-result-area.show { display: block; }
.ocr-result-text {
    font-family: 'Patrick Hand', cursive;
    font-size: 16px;
    width: 100%;
    min-height: 80px;
    border: 2px solid #e2e8f0;
    border-radius: 10px;
    padding: 10px 14px;
    resize: vertical;
    outline: none;
}
.ocr-result-text:focus { border-color: var(--math-primary); }
.ocr-confidence {
    font-family: 'Fredoka', sans-serif;
    font-size: 12px;
    color: #888;
    margin-top: 4px;
    text-align: right;
}
.ocr-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 14px;
}
.ocr-actions button {
    font-family: 'Fredoka', sans-serif;
    font-size: 14px;
    font-weight: 600;
    padding: 10px 24px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.2s;
    border: none;
}
.ocr-btn-save { background: var(--correct); color: white; }
.ocr-btn-save:hover { opacity: 0.9; }
.ocr-btn-cancel { background: #f1f5f9; color: #555; border: 2px solid #e2e8f0 !important; }
.ocr-btn-cancel:hover { border-color: #999 !important; }
.ocr-btn-retake { background: var(--math-light); color: var(--math-dark); border: 2px solid var(--math-medium) !important; }

.scan-btn {
    font-family: 'Fredoka', sans-serif;
    font-size: 12px;
    font-weight: 600;
    padding: 4px 12px;
    border-radius: 8px;
    border: 1.5px solid var(--science-medium);
    background: var(--science-light);
    color: var(--science-dark);
    cursor: pointer;
    transition: all 0.2s;
    margin-left: 6px;
}
.scan-btn:hover { background: var(--science-primary); color: white; }

/* === CONFETTI OVERLAY === */
.celebration-overlay {
    position: fixed;
    inset: 0;
    z-index: 1000;
    display: none;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.4);
    backdrop-filter: blur(4px);
}
.celebration-overlay.show { display: flex; }
.celebration-card {
    background: white;
    border-radius: 24px;
    padding: 40px 48px;
    text-align: center;
    box-shadow: 0 20px 60px rgba(0,0,0,0.2);
    animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    max-width: 440px;
}
@keyframes popIn {
    0% { transform: scale(0.5); opacity: 0; }
    100% { transform: scale(1); opacity: 1; }
}
.celebration-card .big-emoji { font-size: 64px; }
.celebration-card h2 {
    font-family: 'Baloo 2', cursive;
    font-size: 32px;
    font-weight: 800;
    color: var(--math-dark);
    margin: 8px 0 4px;
}
.celebration-card .sub {
    font-family: 'Fredoka', sans-serif;
    font-size: 16px;
    color: #666;
    margin-bottom: 8px;
}
.celebration-card .xp-earned {
    font-family: 'Baloo 2', cursive;
    font-size: 28px;
    font-weight: 800;
    color: var(--challenge-primary);
    margin: 12px 0;
}
.celebration-card button {
    font-family: 'Fredoka', sans-serif;
    font-size: 16px;
    font-weight: 600;
    padding: 12px 32px;
    border-radius: 12px;
    border: none;
    background: var(--math-primary);
    color: white;
    cursor: pointer;
    margin-top: 12px;
    transition: all 0.2s;
}
.celebration-card button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(37,99,235,0.3); }

/* confetti canvas */
#confettiCanvas {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 999;
    pointer-events: none;
}

/* === RESPONSIVE === */
@media (max-width: 768px) {
    .top-bar { padding: 8px 12px; gap: 8px; flex-wrap: wrap; }
    .top-bar .logo { font-size: 15px; }
    .student-name-area input { width: 90px; font-size: 13px; }
    .xp-display { font-size: 12px; padding: 2px 8px; }
    .section-nav { padding: 4px 12px; }
    .main-content { padding: 0 12px; }
    .subject-section { padding: 16px; margin: 16px 0; }
    .day-header { padding: 20px 24px 16px; margin: 0 -12px; }
    .day-header h1 { font-size: 28px; }
    .subject-banner h2 { font-size: 18px; }
    .passage-body { font-size: 15px; padding: 14px 16px; }
    .highlight-toolbar { padding: 6px 12px; gap: 4px; }
    .hl-btn, .hl-btn-eraser { width: 24px; height: 24px; }
    .active-reading-tip { padding: 12px 14px; }
    .active-reading-tip h3 { font-size: 15px; }
    .active-reading-tip p { font-size: 13px; }
    .hl-strategy-card { padding: 10px 12px; }
    .hl-strategy-card h4 { font-size: 13px; }
    .hl-strategy-card p { font-size: 12px; }
    .hl-strategy-card .hl-example { font-size: 12px; }
    .hl-try-it { font-size: 12px; padding: 8px 12px; }
    .guided-practice { padding: 14px; }
    .gp-step { padding: 10px 12px; }
    .gp-tchart-cell input { font-size: 14px; }
    .pv-chart input { width: 40px; font-size: 18px; }
    .vocab-tooltip { max-width: 200px; font-size: 12px; }
    .spelling-practice { grid-template-columns: 1fr; }
}

@media (max-width: 480px) {
    .top-bar { flex-direction: column; align-items: stretch; }
    .progress-wrap { order: 3; }
    .day-schedule .block { font-size: 10px; padding: 3px 8px; }
}

/* === PAGE-BASED NAVIGATION === */
.subject-section { display: none; }
.subject-section.active-page {
    display: block;
    animation: pageFadeIn 0.3s ease;
}
@keyframes pageFadeIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Per-subject active nav colors */
.section-nav button.active[data-section="warmup"] { border-color: var(--warmup-primary); color: var(--warmup-primary); background: var(--warmup-light); }
.section-nav button.active[data-section="reading"] { border-color: var(--ela-primary); color: var(--ela-primary); background: var(--ela-light); }
.section-nav button.active[data-section="math"] { border-color: var(--math-primary); color: var(--math-primary); background: var(--math-light); }
.section-nav button.active[data-section="grammar"] { border-color: var(--ela-primary); color: var(--ela-primary); background: var(--ela-light); }
.section-nav button.active[data-section="social"] { border-color: var(--social-primary); color: var(--social-primary); background: var(--social-light); }
.section-nav button.active[data-section="readinglog"] { border-color: #475569; color: #475569; background: #F8FAFC; }

/* Completed section checkmark */
.section-nav button.completed::before { content: '\2713 '; font-weight: 700; }

/* Page navigation footer */
.page-nav-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    max-width: 820px;
    margin: 24px auto 0;
    padding: 0 20px 20px;
}
.page-nav-btn {
    font-family: 'Fredoka', sans-serif;
    font-size: 15px;
    font-weight: 600;
    padding: 10px 24px;
    border-radius: 12px;
    border: 2.5px solid var(--math-primary);
    background: white;
    color: var(--math-primary);
    cursor: pointer;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 6px;
}
.page-nav-btn:hover { background: var(--math-light); transform: translateY(-1px); }
.page-nav-btn:disabled { opacity: 0.35; cursor: default; transform: none; }
.page-nav-btn.next-btn { background: var(--math-primary); color: white; }
.page-nav-btn.next-btn:hover { background: var(--math-dark); }
.page-nav-btn.next-btn:disabled { background: #94a3b8; border-color: #94a3b8; }
.page-indicator {
    font-family: 'Fredoka', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: var(--neutral);
}

/* Guided practice cards (purple, for grammar) */
.guided-card {
    background: white;
    border: 2px solid var(--ela-medium);
    border-radius: 12px;
    padding: 14px 16px;
    margin-bottom: 12px;
    position: relative;
}
.guided-card .gc-label {
    font-family: 'Fredoka', sans-serif;
    font-size: 11px;
    font-weight: 600;
    color: var(--ela-primary);
    text-transform: uppercase;
    margin-bottom: 4px;
}
.guided-card .gc-fragment {
    font-family: 'Lora', serif;
    font-size: 15px;
    color: #DC2626;
    text-decoration: line-through;
    margin: 6px 0;
}
.guided-card .gc-check {
    font-family: 'Quicksand', sans-serif;
    font-size: 13px;
    color: #475569;
    margin: 6px 0;
    padding-left: 12px;
    border-left: 3px solid var(--ela-medium);
}
.guided-card .gc-fixed {
    font-family: 'Lora', serif;
    font-size: 15px;
    color: var(--correct);
    font-weight: 600;
    margin: 6px 0;
}
.gc-arrow {
    font-size: 16px;
    text-align: center;
    color: var(--ela-primary);
    margin: 4px 0;
}

/* Science scaffold boxes */
.scaffold-box {
    background: var(--science-light);
    border: 2px dashed var(--science-primary);
    border-radius: 12px;
    padding: 14px 18px;
    margin: 14px 0;
}
.scaffold-box h4 {
    font-family: 'Fredoka', sans-serif;
    font-size: 14px;
    font-weight: 600;
    color: var(--science-dark);
    margin-bottom: 6px;
}
.scaffold-box p {
    font-family: 'Quicksand', sans-serif;
    font-size: 14px;
    color: #065F46;
    line-height: 1.5;
    margin-bottom: 6px;
}
.scaffold-box p:last-child { margin-bottom: 0; }
.scaffold-box .sentence-frame {
    font-family: 'Patrick Hand', cursive;
    font-size: 16px;
    color: #065F46;
    background: #D1FAE5;
    border: 2px dashed var(--science-primary);
    border-radius: 10px;
    padding: 10px 14px;
    margin-top: 8px;
    line-height: 1.6;
}
.scaffold-box .sentence-frame span {
    color: #9CA3AF;
    font-style: italic;
}

/* Fragment hint injected by selectSF */
.fragment-hint {
    font-family: 'Fredoka', sans-serif;
    font-size: 12px;
    font-weight: 500;
    color: var(--ela-dark);
    background: var(--ela-light);
    border: 1.5px solid var(--ela-medium);
    padding: 6px 12px;
    border-radius: 8px;
    margin-top: 6px;
    display: block;
}

/* === PRINT TOOLBAR === */
.print-toolbar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    z-index: 200;
    padding: 12px 16px;
    background: white;
    border-top: 2px solid #e2e8f0;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.12);
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    flex-wrap: wrap;
}
.print-toolbar label {
    font-family: 'Fredoka', sans-serif;
    font-size: 13px;
    font-weight: 600;
    color: #555;
}
.print-mode-btn {
    font-family: 'Fredoka', sans-serif;
    font-size: 13px;
    font-weight: 600;
    padding: 6px 16px;
    border-radius: 8px;
    border: 2px solid #e2e8f0;
    background: white;
    cursor: pointer;
    transition: all 0.2s;
    color: #555;
}
.print-mode-btn:hover { border-color: var(--math-primary); }
.print-mode-btn.active { background: var(--math-primary); color: white; border-color: var(--math-primary); }

/* Completed on paper checkbox */
.paper-checkbox {
    display: flex;
    align-items: center;
    gap: 6px;
    margin-top: 8px;
    padding: 6px 10px;
    background: #f8fafc;
    border-radius: 8px;
    border: 1.5px dashed #cbd5e1;
    cursor: pointer;
}
.paper-checkbox input { width: 18px; height: 18px; accent-color: var(--correct); cursor: pointer; }
.paper-checkbox span {
    font-family: 'Fredoka', sans-serif;
    font-size: 12px;
    font-weight: 600;
    color: #64748B;
}
.paper-checkbox.checked { background: var(--science-light); border-color: var(--science-medium); }
.paper-checkbox.checked span { color: var(--science-dark); }

@media print {
    .top-bar, .section-nav, .check-btn, .timer-bar, .sf-toggle button, .read-aloud-btn, .xp-toast, .celebration-overlay, #confettiCanvas, .page-nav-footer, .view-passage-btn, .passage-drawer-overlay, .print-toolbar, .review-btn, .rubric-result, .section-encouragement, .paper-checkbox, .print-experiment-tip { display: none !important; }
    body { background: white; padding: 0; font-size: 14px; }
    .subject-section { display: block !important; box-shadow: none; border: 1px solid #ddd; page-break-inside: avoid; margin: 0; }
    .day-header { display: block !important; }
    .answer-input { border-bottom: 2px solid #333 !important; background: transparent !important; }
    .answer-textarea { border: 1.5px solid #333 !important; background: transparent !important; min-height: 60px; }
    .subject-banner { page-break-after: avoid; }
    .section-complete { display: none !important; }
    .xp-display { display: none !important; }
    .student-name-area { display: none !important; }

    /* Blank worksheet mode — hide student answers */
    body.print-blank .answer-input { color: transparent !important; }
    body.print-blank .answer-textarea { color: transparent !important; }
    body.print-blank .sf-toggle .selected { background: transparent !important; color: transparent !important; border-color: #ccc !important; }
    body.print-blank .pv-input { color: transparent !important; }
    body.print-blank .feedback { display: none !important; }
    body.print-blank .fix-result-item { display: none !important; }
    body.print-blank mark[class^="hl-"] { background: transparent !important; }
    body.print-blank .guided-practice .gp-tchart-cell input { color: transparent !important; }
    body.print-blank .data-table input { color: transparent !important; }

    /* Portfolio mode — show all answers */
    body.print-portfolio .answer-input { color: #333 !important; font-weight: 600; }
    body.print-portfolio .answer-textarea { color: #333 !important; }
}
</style>
</head>
<body>

<!-- CONFETTI CANVAS -->
<canvas id="confettiCanvas"></canvas>

<!-- XP TOAST -->
<div class="xp-toast" id="xpToast">
    <span class="xp-amount" id="xpToastAmount">+50</span> <span class="xp-toast-label">XP earned!</span>
</div>

<!-- CELEBRATION OVERLAY -->
<div class="celebration-overlay" id="celebrationOverlay">
    <div class="celebration-card">
        <div class="big-emoji">&#x1F389;</div>
        <h2>Day Complete!</h2>
        <div class="sub" id="celebrationName">Amazing work!</div>
        <div class="xp-earned" id="celebrationXP">300 XP Earned!</div>
        <button onclick="closeCelebration()">Back to Hub</button>
    </div>
</div>

<!-- OCR SCANNER MODAL -->
<div class="ocr-modal" id="ocrModal">
    <div class="ocr-box">
        <h3>&#x1F4F7; Scan Paper Worksheet</h3>
        <div class="ocr-capture-area" id="ocrCaptureArea" onclick="document.getElementById('ocrFileInput').click();">
            <div class="ocr-icon">&#x1F4F8;</div>
            <div class="ocr-label">Tap to take a photo or choose an image</div>
            <input type="file" id="ocrFileInput" accept="image/*" capture="environment" style="display:none;" onchange="handleOCRFile(this)">
        </div>
        <div class="ocr-preview" id="ocrPreview" style="display:none;"></div>
        <div class="ocr-progress" id="ocrProgress">
            <div class="ocr-progress-text" id="ocrProgressText">Scanning...</div>
            <div class="ocr-progress-bar"><div class="ocr-progress-fill" id="ocrProgressFill"></div></div>
        </div>
        <div class="ocr-result-area" id="ocrResultArea">
            <p style="font-family:'Fredoka',sans-serif; font-size:13px; font-weight:600; color:#555; margin-bottom:6px;">Scanned text (you can edit before saving):</p>
            <textarea class="ocr-result-text" id="ocrResultText"></textarea>
            <div class="ocr-confidence" id="ocrConfidence"></div>
            <div id="ocrUpgradeHint" style="display:none; margin-top:8px; padding:10px 14px; background:#FFFBEB; border:1.5px solid #FDE68A; border-radius:10px; font-family:'Quicksand',sans-serif; font-size:13px; color:#92400E;">
                <strong>Tip:</strong> For cleaner results with handwriting, try the <strong>AI Scan</strong> add-on ($1.99/mo).
            </div>
        </div>
        <div class="ocr-actions">
            <button class="ocr-btn-cancel" onclick="closeOCRModal()">Cancel</button>
            <button class="ocr-btn-retake" id="ocrRetakeBtn" style="display:none;" onclick="retakeOCR()">Retake</button>
            <button class="ocr-btn-save" id="ocrSaveBtn" style="display:none;" onclick="saveOCRResult()">Save to Worksheet</button>
        </div>
    </div>
</div>

<!-- TOP BAR -->
<div class="top-bar">
    <a class="logo" href="interactive-hub.html" title="Back to Hub">&larr; Root Access</a>
    <div class="student-name-area">
        <input type="text" id="studentName" placeholder="Your name" aria-label="Student name">
    </div>
    <div class="xp-display">&#x2B50; <span class="xp-num" id="xpTotal">0</span> XP</div>
    <div class="progress-wrap">
        <div class="progress-bar-outer">
            <div class="progress-bar-inner" id="progressBar"></div>
        </div>
        <span class="progress-text" id="progressText">0%</span>
    </div>
    <span class="save-status" id="saveStatus">Saved</span>
</div>

<!-- SECTION NAV -->
<div class="section-nav" id="sectionNav">
    <button onclick="showPage('warmup')" data-section="warmup">Warm-Up</button>
    <button onclick="showPage('reading')" data-section="reading">Reading</button>
    <button onclick="showPage('math')" data-section="math">Math</button>
    <button onclick="showPage('grammar')" data-section="grammar">Language Arts</button>
    <button onclick="showPage('social')" data-section="social">Social Studies</button>
    <button onclick="showPage('readinglog')" data-section="readinglog">Reading Log</button>
    <button class="view-passage-btn" id="viewPassageBtn" onclick="openPassagePopup()">&#x1F4D6; View Passage</button>
    <button class="view-passage-btn" style="background: var(--math-light); color: var(--math-dark); border-color: var(--math-medium);" onclick="togglePrintToolbar()">&#x1F5A8; Print</button>
</div>

<!-- PRINT TOOLBAR -->
<div class="print-toolbar" id="printToolbar" style="display:none;">
    <label>Print Mode:</label>
    <button class="print-mode-btn active" onclick="setPrintMode('blank', this)">Blank Worksheet</button>
    <button class="print-mode-btn" onclick="setPrintMode('portfolio', this)">Student Portfolio</button>
    <button class="print-mode-btn" onclick="window.print()" style="background:var(--math-primary); color:white; border-color:var(--math-primary);">Print Now</button>
    <button class="print-mode-btn" onclick="togglePrintToolbar()" style="background:#fee2e2; color:#dc2626; border-color:#fca5a5;">Close</button>
</div>

<!-- MOBILE PASSAGE DRAWER -->
<div class="passage-drawer-overlay" id="passageDrawerOverlay">
    <div class="passage-drawer" id="passageDrawer">
        <div class="passage-drawer-header">
            <span id="drawerPassageTitle">Reading Passage</span>
            <button class="passage-drawer-close" onclick="closePassageDrawer()">&times;</button>
        </div>
        <div class="passage-body" id="drawerPassageBody"></div>
    </div>
</div>

<!-- MAIN CONTENT -->
<div class="main-content">

<!-- DAY HEADER -->
<div class="day-header">
    <h1>Thursday</h1>
    <div class="day-meta">Week 1: Boot Sequence &bull; Day 4 of 5</div>
    <div style="font-family: 'Fredoka', sans-serif; font-size: 11px; color: rgba(255,255,255,0.6); margin-top: 10px; position: relative; z-index: 1;">Sample Daily Schedule (do these in any order!)</div>
    <div class="day-schedule">
        <span class="block">Warm-Up (15 min)</span>
        <span class="block">Reading (40 min)</span>
        <span class="block">Math (45 min)</span>
        <span class="block">Language Arts (30 min)</span>
        <span class="block">Social Studies (40 min)</span>
    </div>
</div>

<!-- ============================================ -->
<!-- BLOCK 1: MORNING WARM-UP -->
<!-- ============================================ -->
<div class="subject-section" id="section-warmup" data-xp="50">
    <div class="subject-banner banner-warmup">
        <div class="icon">&#x2600;</div>
        <div class="title-group"><h2>Morning Warm-Up</h2></div>
        <div class="time-badge">15 min</div>
    </div>

    <div class="goal-box">
        <strong>Today's Goal:</strong> Review comparing and ordering numbers, practice sentence editing, and work on this week's spelling pattern.
    </div>

    <p class="problem-text" style="margin-bottom: 4px;"><strong>Quick Math (comparing numbers from Wednesday):</strong></p>
    <p style="font-family: 'Quicksand', sans-serif; font-size: 13px; color: #777; margin-bottom: 12px;">Use what you know about place value to compare and order these numbers.</p>

    <div class="question">
        <p class="problem-text"><span class="m-number">1</span> Which is greater: <strong>47,832</strong> or <strong>47,823</strong>? Write &gt; or &lt;
        <input type="text" class="answer-input short" data-answer=">" data-section="warmup" data-attempts="0" placeholder="?" style="width:50px; text-align:center;"></p>
        <div class="feedback" id="warmup-q1-fb"></div>
    </div>
    <div class="question">
        <p class="problem-text"><span class="m-number">2</span> Put these in order from least to greatest: <strong>15,209 &emsp; 15,902 &emsp; 15,029</strong></p>
        <p class="problem-text"><input type="text" class="answer-input short" data-answer="15029" data-section="warmup" data-attempts="0" placeholder="least" data-alt-answers="15,029"> &lt;
        <input type="text" class="answer-input short" data-answer="15209" data-section="warmup" data-attempts="0" placeholder="middle" data-alt-answers="15,209"> &lt;
        <input type="text" class="answer-input short" data-answer="15902" data-section="warmup" data-attempts="0" placeholder="greatest" data-alt-answers="15,902"></p>
        <div class="feedback" id="warmup-q2-fb"></div>
    </div>
    <div class="question">
        <p class="problem-text"><span class="m-number">3</span> On a number line from 6,000 to 7,000, Point A is at 30% of the way. What number is Point A?
        <input type="text" class="answer-input short" data-answer="6300" data-section="warmup" data-attempts="0" placeholder="?" data-alt-answers="6,300"></p>
        <p class="problem-text">Is it greater or less than 6,500?
        <input type="text" class="answer-input short" data-answer="less" data-section="warmup" data-attempts="0" placeholder="greater or less?"></p>
        <div class="feedback" id="warmup-q3-fb"></div>
    </div>

    <button class="check-btn warmup-check" onclick="checkWarmupMath()">Check My Answers</button>

    <!-- Fix the Sentence -->
    <div class="fix-sentence-box" style="margin-top: 20px;">
        <div class="label">&#x1F527; Fix the Sentence &mdash; find and fix all the errors!</div>
        <p style="font-family: 'Quicksand', sans-serif; font-size: 13px; color: #888; margin: 0 0 8px;">This sentence has <strong>5 errors</strong>. Rewrite it correctly below. Then click &ldquo;Check My Fixes&rdquo; to see how you did!</p>
        <p style="font-family: 'Fredoka', sans-serif; font-size: 12px; font-weight: 500; color: var(--warmup-dark); background: var(--warmup-light); border: 1.5px solid var(--warmup-medium); border-radius: 8px; padding: 6px 12px; margin: 0 0 10px;">&#x1F50D; <strong>Look for:</strong> capitalization errors, missing punctuation, and spelling mistakes</p>
        <div class="fix-sentence-original"><span class="fix-error">the</span> <span class="fix-error">anishinaabe</span> people including the <span class="fix-error">ojibwe</span> <span class="fix-error">odawa</span> and <span class="fix-error">potawatomi</span> have lived in michigan for thousands of years</div>
        <textarea class="answer-textarea" id="fix-sentence-input" data-section="warmup" placeholder="Rewrite the corrected sentence here..." rows="2"></textarea>
        <div id="fix-sentence-results" class="fix-results"></div>
        <button class="check-btn warmup-check" onclick="checkFixSentence()" style="margin-top: 8px;">Check My Fixes</button>
    </div>

    <!-- Spelling Preview -->
    <div class="spelling-box" style="margin-top: 20px;">
        <div class="spelling-header">&#x1F4DD; This Week's Spelling Words</div>
        <div class="spelling-content">
            <p class="problem-text"><strong>Pattern:</strong> Words with the prefix <em>un-</em> (meaning "not" or "opposite of")</p>
            <div style="font-family: 'Quicksand', sans-serif; font-size: 13px; color: var(--warmup-dark); background: #E0F2FE; border: 2px solid var(--warmup-medium); border-radius: 10px; padding: 10px 14px; margin: 6px 0 10px;">
                <strong style="font-family: 'Fredoka', sans-serif; color: var(--warmup-primary);">&#x1F4A1; Prefix Power:</strong> <strong><em>un-</em></strong> means <strong>"not"</strong> or <strong>"the opposite of."</strong> When you add <em>un-</em> to a word, it flips the meaning!<br>
                <span style="color: #555;">Example: <em>known</em> (you know it) &rarr; <em>unknown</em> (you don't know it)</span>
            </div>
            <p class="problem-text" style="font-size: 13px; color: #777; margin-bottom: 8px;">Click any word to hear it spoken aloud!</p>
            <div class="spelling-words">
                <span class="spelling-word" onclick="speakWord(this)"><span class="prefix">un</span>known</span>
                <span class="spelling-word" onclick="speakWord(this)"><span class="prefix">un</span>usual</span>
                <span class="spelling-word" onclick="speakWord(this)"><span class="prefix">un</span>familiar</span>
                <span class="spelling-word" onclick="speakWord(this)"><span class="prefix">un</span>certain</span>
                <span class="spelling-word" onclick="speakWord(this)"><span class="prefix">un</span>cover</span>
                <span class="spelling-word" onclick="speakWord(this)"><span class="prefix">un</span>able</span>
                <span class="spelling-word" onclick="speakWord(this)"><span class="prefix">un</span>even</span>
                <span class="spelling-word" onclick="speakWord(this)"><span class="prefix">un</span>likely</span>
                <span class="spelling-word" onclick="speakWord(this)"><span class="prefix">un</span>seen</span>
                <span class="spelling-word" onclick="speakWord(this)"><span class="prefix">un</span>finished</span>
                <span class="spelling-word" onclick="speakWord(this)">peninsula</span>
                <span class="spelling-word" onclick="speakWord(this)">energy</span>
            </div>
            <p class="problem-text" style="margin-top: 12px;"><strong>Today's activity — Word Pyramids:</strong> Build each word one letter at a time in your head, then type the complete word below!</p>
            <div class="spelling-practice" id="spellingPractice">
                <div class="spelling-practice-item"><span class="sp-num">1.</span><input type="text" data-spell="unknown" data-section="warmup" placeholder="..."></div>
                <div class="spelling-practice-item"><span class="sp-num">2.</span><input type="text" data-spell="unusual" data-section="warmup" placeholder="..."></div>
                <div class="spelling-practice-item"><span class="sp-num">3.</span><input type="text" data-spell="unfamiliar" data-section="warmup" placeholder="..."></div>
                <div class="spelling-practice-item"><span class="sp-num">4.</span><input type="text" data-spell="uncertain" data-section="warmup" placeholder="..."></div>
                <div class="spelling-practice-item"><span class="sp-num">5.</span><input type="text" data-spell="uncover" data-section="warmup" placeholder="..."></div>
                <div class="spelling-practice-item"><span class="sp-num">6.</span><input type="text" data-spell="unable" data-section="warmup" placeholder="..."></div>
                <div class="spelling-practice-item"><span class="sp-num">7.</span><input type="text" data-spell="uneven" data-section="warmup" placeholder="..."></div>
                <div class="spelling-practice-item"><span class="sp-num">8.</span><input type="text" data-spell="unlikely" data-section="warmup" placeholder="..."></div>
                <div class="spelling-practice-item"><span class="sp-num">9.</span><input type="text" data-spell="unseen" data-section="warmup" placeholder="..."></div>
                <div class="spelling-practice-item"><span class="sp-num">10.</span><input type="text" data-spell="unfinished" data-section="warmup" placeholder="..."></div>
                <div class="spelling-practice-item"><span class="sp-num">11.</span><input type="text" data-spell="peninsula" data-section="warmup" placeholder="..."></div>
                <div class="spelling-practice-item"><span class="sp-num">12.</span><input type="text" data-spell="energy" data-section="warmup" placeholder="..."></div>
            </div>
        </div>
    </div>

    <div class="section-complete" id="warmup-complete">
        <div class="emoji">&#x1F31F;</div>
        <div class="msg">Warm-Up Complete! +50 XP</div>
    </div>
</div>

<!-- ============================================ -->
<!-- BLOCK 2: READING -->
<!-- ============================================ -->
<div class="subject-section" id="section-reading" data-xp="60">
    <div class="subject-banner banner-reading">
        <div class="icon">&#x1F4DA;</div>
        <div class="title-group"><h2>Reading</h2></div>
        <div class="time-badge">40 min</div>
    </div>

    <div class="goal-box">
        <strong>Today's Goal:</strong> Read a nonfiction passage about the Anishinaabe people. Identify the main idea and supporting details. Use text evidence and think critically about why Indigenous place names matter.
    </div>

    <div class="passage-box">
        <div class="passage-header">
            <span class="passage-title">People of the Three Fires</span>
            <span class="passage-meta">Nonfiction &bull; 420 words</span>
            <button class="read-aloud-btn" id="readAloudBtn" onclick="toggleReadAloud()">&#x1F50A; Read Aloud</button>
        </div>
        <div class="highlight-toolbar" id="highlightToolbar">
            <span class="highlight-toolbar-label">Highlighter:</span>
            <button class="hl-btn hl-btn-yellow" data-hl-color="yellow" onclick="setHighlightColor('yellow')" title="Main ideas &amp; key facts"></button>
            <button class="hl-btn hl-btn-green" data-hl-color="green" onclick="setHighlightColor('green')" title="Details &amp; evidence"></button>
            <button class="hl-btn hl-btn-pink" data-hl-color="pink" onclick="setHighlightColor('pink')" title="New words &amp; questions"></button>
            <button class="hl-btn-eraser" id="hlEraser" onclick="toggleEraser()" title="Erase highlights">&#x2715;</button>
            <span class="hl-count" id="hlCount"></span>
        </div>
        <div class="passage-body" id="passageBody">
            <p>Long before Michigan became a state, the Anishinaabe people made their home on this land. The Anishinaabe are not one single group but three related nations: the Ojibwe (also called Chippewa), the Odawa (also called Ottawa), and the Potawatomi. Together, they formed the Council of Three Fires, a powerful <span class="vocab-highlight" tabindex="0">confederacy<span class="vocab-tooltip">A group of people, states, or nations joined together for a common purpose</span></span> in which each nation had a special role. The Ojibwe were known as the Keepers of the Faith. The Odawa were the Keepers of the Trade. The Potawatomi were the Keepers of the Fire. This <span class="vocab-highlight" tabindex="0">alliance<span class="vocab-tooltip">An agreement between groups to work together and help each other</span></span> helped the three nations support one another, settle disagreements peacefully, and protect their shared homeland.</p>

            <p>The Anishinaabe understood the land and water deeply because they lived closely with the natural world through every <span class="vocab-highlight" tabindex="0">seasonal<span class="vocab-tooltip">Having to do with the seasons of the year; changing as the seasons change</span></span> change. In spring, which they call Ziigwan, families traveled to sugar maple groves to tap trees and boil the sap into maple sugar. This was one of the most important times of the year. When summer, or Niibin, arrived, communities moved to the shores of lakes and rivers to fish, gather berries, and tend gardens of corn, beans, and squash.</p>

            <p>Fall brought the wild rice <span class="vocab-highlight" tabindex="0">harvest<span class="vocab-tooltip">The time when crops or wild foods are gathered; the act of collecting food from the land</span></span>. During Dagwaagin, families canoed into shallow lakes and knocked ripe rice grains into their boats. Wild rice, called manoomin, was so valuable that it was treated as a gift from the Creator. Then, in winter, or Biboon, families gathered together in sheltered camps. Elders told stories that passed down history, science, and values to younger generations. This cycle of moving with the seasons is called the Seasonal Round.</p>

            <p>The Anishinaabe were expert scientists and engineers long before those words existed. They knew which plants could heal sickness. They built birch bark canoes light enough for one person to carry yet strong enough to cross the Great Lakes. They managed forests by using controlled burns to keep the land healthy. Their knowledge was not written in books but was carried in memory, language, and ceremony, passed carefully from one generation to the next.</p>

            <p>Today, Anishinaabe people are still here. Twelve federally recognized tribal nations exist in Michigan right now, and they exercise <span class="vocab-highlight" tabindex="0">sovereignty<span class="vocab-tooltip">The right of a group or nation to govern itself and make its own decisions</span></span>, the right to govern themselves. Many of the place names we use every day come from Anishinaabe languages. Michigan comes from <em>michi-gami</em>, meaning "great water." Detroit comes from the French word for strait, but the Anishinaabe called the river <em>Waawiiyaatanong</em>. Mackinac comes from <em>Michilimackinac</em>, meaning "Great Turtle." These names are living reminders that this land has been known and cared for since long before it appeared on any European map.</p>
        </div>
    </div>

    <!-- Vocabulary -->
    <div class="vocab-box">
        <div class="vocab-box-header">&#x1F4D6; Words to Know</div>
        <div class="vocab-entry"><div class="vocab-word">confederacy</div><div class="vocab-def">A group of people, states, or nations joined together for a common purpose</div></div>
        <div class="vocab-entry"><div class="vocab-word">alliance</div><div class="vocab-def">An agreement between groups to work together and help each other</div></div>
        <div class="vocab-entry"><div class="vocab-word">seasonal</div><div class="vocab-def">Having to do with the seasons of the year; changing as the seasons change</div></div>
        <div class="vocab-entry"><div class="vocab-word">harvest</div><div class="vocab-def">The time when crops or wild foods are gathered; the act of collecting food from the land</div></div>
        <div class="vocab-entry"><div class="vocab-word">sovereignty</div><div class="vocab-def">The right of a group or nation to govern itself and make its own decisions</div></div>
    </div>

    <!-- Active Reading Strategy Mini-Lesson -->
    <div class="active-reading-tip">
        <h3>Active Reading Strategy: Highlight the Text!</h3>
        <p>Good readers don't just read — they <strong>mark up the text</strong> while they read. Highlighting helps your brain decide what's important and remember it later. Here's how to do it:</p>

        <!-- YELLOW: Main Ideas -->
        <div class="hl-strategy-card">
            <h4><span class="hl-color-key" style="background:#FDE68A;">Yellow</span> Main Ideas &amp; Key Facts</h4>
            <p class="hl-ask">"What is this paragraph mostly about?"</p>
            <p>Main ideas tell you the <strong>big picture</strong> — what the whole paragraph or section is really saying.</p>
            <div class="hl-example hl-example-yellow">
                <strong>Example from the passage:</strong> "The Anishinaabe are not one single group but three related nations" &mdash; this tells you the big idea about who the Anishinaabe are.
            </div>
        </div>

        <!-- GREEN: Details & Evidence -->
        <div class="hl-strategy-card">
            <h4><span class="hl-color-key" style="background:#A7F3D0;">Green</span> Supporting Details &amp; Evidence</h4>
            <p class="hl-ask">"What facts, numbers, or examples support the main idea?"</p>
            <p>Details are the <strong>proof</strong>. Look for specific numbers, names, places, dates, or descriptions the author uses to back up their point.</p>
            <div class="hl-example hl-example-green">
                <strong>Example from the passage:</strong> "The Ojibwe were known as the Keepers of the Faith. The Odawa were the Keepers of the Trade." &mdash; these details show each nation's specific role.
            </div>
        </div>

        <!-- PINK: Questions & New Words -->
        <div class="hl-strategy-card">
            <h4><span class="hl-color-key" style="background:#FBCFE8;">Pink</span> New Words &amp; Questions</h4>
            <p class="hl-ask">"What surprises me, confuses me, or do I want to know more about?"</p>
            <p>Mark anything that makes you stop and think. Words you've never seen before. Facts that surprise you.</p>
            <div class="hl-example hl-example-pink">
                <strong>Example from the passage:</strong> "manoomin" and "sovereignty" &mdash; you might wonder: what do these words mean? Why are they important?
            </div>
        </div>

        <div class="hl-try-it">
            Scroll back up to the passage and try it! Pick a color, then drag to select text.<br>
            Goal: Find at least <strong>3 main ideas</strong> (yellow) and <strong>3 details</strong> (green) before answering the questions below.
        </div>
    </div>

    <!-- Comprehension Questions -->
    <div class="subject-banner banner-reading" style="margin-top: 24px; margin-bottom: 16px;">
        <div class="icon">&#x2753;</div>
        <div class="title-group"><h2>Comprehension Check</h2></div>
    </div>

    <div class="question">
        <div class="q-label">Main Idea</div>
        <p class="q-text"><span class="q-number">1</span> What is the main idea of this passage? Write it in one or two sentences.</p>
        <textarea class="answer-textarea" data-section="reading" data-track-words="true" data-rubric-type="main-idea" data-rubric-keywords="Anishinaabe,Three Fires,Ojibwe,Odawa,Potawatomi,land,Michigan,seasons,knowledge" data-rubric-min-words="8" placeholder="Write the main idea here..." rows="2"></textarea>
        <div class="word-count">0 words</div>
    </div>
    <div class="question">
        <div class="q-label">Text Evidence</div>
        <p class="q-text"><span class="q-number">2</span> The passage says the Anishinaabe "understood the land and water deeply." What specific examples from the text support this claim? List at least two.</p>
        <textarea class="answer-textarea" data-section="reading" data-track-words="true" data-rubric-type="text-evidence" data-rubric-keywords="maple,sugar,fish,rice,canoes,plants,heal,burns,forest,seasonal,garden,corn,beans" data-rubric-min-words="10" placeholder="Find at least two examples..." rows="3"></textarea>
        <div class="word-count">0 words</div>
    </div>
    <!-- Q3: GUIDED PRACTICE — Sequence -->
    <div class="guided-practice" id="guidedPractice">
        <div class="guided-practice-header">
            <span style="font-size: 24px;">&#x1F91D;</span>
            <h3>Let's Practice Together!</h3>
            <span class="gp-badge">Guided</span>
        </div>
        <p class="gp-intro">Question 3 asks you to put the <strong>Seasonal Round</strong> in order — that means finding what happened in each season. Let's walk through this step by step.</p>

        <!-- Step 1: Find the information -->
        <div class="gp-step">
            <div class="gp-step-number">1</div>
            <h4>Find It in the Text</h4>
            <p>Go back to <strong>Paragraphs 2 and 3</strong> of the passage. Look for the four seasons and what the Anishinaabe did during each one. Use your <span class="hl-color-key" style="background:#A7F3D0;">green</span> highlighter to mark each season's activities.</p>
        </div>

        <!-- Step 2: Organize -->
        <div class="gp-step">
            <div class="gp-step-number">2</div>
            <h4>Organize What You Found</h4>
            <p>Fill in the chart — one season per row:</p>
            <div class="gp-tchart" style="grid-template-columns: 1fr 2fr;">
                <div class="gp-tchart-header">Season</div>
                <div class="gp-tchart-header">What They Did</div>
                <div class="gp-tchart-cell" style="font-weight:600;">Spring (Ziigwan)</div>
                <div class="gp-tchart-cell"><input type="text" data-section="reading" placeholder="What did they do in spring?" /></div>
                <div class="gp-tchart-cell" style="font-weight:600;">Summer (Niibin)</div>
                <div class="gp-tchart-cell"><input type="text" data-section="reading" placeholder="What did they do in summer?" /></div>
                <div class="gp-tchart-cell" style="font-weight:600;">Fall (Dagwaagin)</div>
                <div class="gp-tchart-cell"><input type="text" data-section="reading" placeholder="What did they do in fall?" /></div>
                <div class="gp-tchart-cell" style="font-weight:600;">Winter (Biboon)</div>
                <div class="gp-tchart-cell"><input type="text" data-section="reading" placeholder="What did they do in winter?" /></div>
            </div>
        </div>

        <!-- Step 3: Build your answer -->
        <div class="gp-step">
            <div class="gp-step-number">3</div>
            <h4>Build Your Answer</h4>
            <p>Use your chart to write a complete answer that lists all four seasons in order:</p>
            <div class="gp-sentence-starter">
                "The Seasonal Round started in spring when the Anishinaabe __________. In summer, they __________. During fall, __________. Finally, in winter, __________."
            </div>
        </div>

        <!-- The actual answer box -->
        <div class="question" style="margin-top: 14px; margin-bottom: 0;">
            <div class="q-label">Sequence / Chronology</div>
            <p class="q-text"><span class="q-number">3</span> List the four activities of the Seasonal Round in order, starting with spring. What did the Anishinaabe do during each season?</p>
            <textarea class="answer-textarea" data-section="reading" data-track-words="true" data-rubric-type="explain" data-rubric-keywords="spring,Ziigwan,maple,sugar,summer,Niibin,fish,garden,fall,Dagwaagin,rice,winter,Biboon,stories,seasonal" data-rubric-min-words="20" data-rubric-structure="names-both" placeholder="Use your chart and sentence starter to write your answer..." rows="4"></textarea>
            <div class="word-count">0 words</div>
        </div>
    </div>
    <div class="question">
        <div class="q-label">Vocabulary in Context</div>
        <p class="q-text"><span class="q-number">4</span> The passage says the Three Fires was a "confederacy." Based on how it is used in the text, what does <em>confederacy</em> mean? What clues in the sentence help you figure it out?</p>
        <textarea class="answer-textarea" data-section="reading" data-track-words="true" data-rubric-type="vocabulary" data-rubric-keywords="confederacy,group,joined,together,nations,alliance,role,support,purpose,common" data-rubric-min-words="8" placeholder="What clues help you understand the word?" rows="2"></textarea>
        <div class="word-count">0 words</div>
    </div>
    <div class="question">
        <div class="q-label">Author's Purpose</div>
        <p class="q-text"><span class="q-number">5</span> Why does the author include the sentence "Today, Anishinaabe people are still here"? What is the author trying to make sure readers understand?</p>
        <textarea class="answer-textarea" data-section="reading" data-track-words="true" data-rubric-type="authors-purpose" data-rubric-keywords="still,here,today,alive,present,not gone,history,continue,exist,tribal,sovereignty" data-rubric-min-words="10" placeholder="Why did the author write this?" rows="3"></textarea>
        <div class="word-count">0 words</div>
    </div>
    <div class="question">
        <div class="q-label">Critical Thinking</div>
        <p class="q-text"><span class="q-number">6</span> Why is it important that Anishinaabe place names like Michigan, Detroit, and Mackinac are still used today? What do these names tell us?</p>
        <textarea class="answer-textarea" data-section="reading" data-track-words="true" data-rubric-type="inference" data-rubric-keywords="names,place,history,remember,respect,Indigenous,Anishinaabe,language,before,European,important,land,connection" data-rubric-min-words="10" placeholder="Why are these place names important?" rows="3"></textarea>
        <div class="word-count">0 words</div>
    </div>

    <button class="review-btn" onclick="reviewSection('reading')">&#x1F4CB; Review My Reading Work</button>
    <label class="paper-checkbox" onclick="togglePaper(this)"><input type="checkbox" data-section="reading" data-paper="true"><span>Completed on paper</span></label>

    <div class="section-complete" id="reading-complete">
        <div class="emoji">&#x1F4DA;</div>
        <div class="msg">Reading Complete! +60 XP</div>
    </div>
</div>

<!-- ============================================ -->
<!-- BLOCK 3: MATH -->
<!-- ============================================ -->
<div class="subject-section" id="section-math" data-xp="80">
    <div class="subject-banner banner-math">
        <div class="icon">&#x1F4D0;</div>
        <div class="title-group"><h2>Math: Expanded Form &amp; Word Form</h2></div>
        <div class="time-badge">45 min</div>
    </div>

    <div class="goal-box">
        <strong>Today's Goal:</strong> Write numbers in three forms — standard form, expanded form, and word form. Learn the rules for writing numbers as words.
    </div>

    <div class="math-lesson-box">
        <h3>Expanded Form and Word Form</h3>
        <p>Every number can be written in <strong>three different ways</strong>. Each way tells us the same amount, just in a different format.</p>

        <div class="math-example">
            <div class="label">The Three Forms</div>
            <p><strong>Standard Form:</strong> 26,372</p>
            <p><strong>Expanded Form:</strong> 20,000 + 6,000 + 300 + 70 + 2</p>
            <p><strong>Word Form:</strong> twenty-six thousand, three hundred seventy-two</p>
        </div>

        <p><strong>Standard form</strong> is the way we usually write numbers, using digits and commas.</p>
        <p><strong>Expanded form</strong> breaks the number apart to show the value of every digit. Think of it as "opening up" the number so you can see what each piece is worth.</p>
        <p><strong>Word form</strong> is the number written using words, the same way you would say it out loud.</p>

        <div class="math-example">
            <div class="label">Rules for Word Form</div>
            <p><strong>Rule 1:</strong> Use a <strong>hyphen (-)</strong> for numbers from twenty-one through ninety-nine.</p>
            <p style="padding-left: 16px; color: #555;">Examples: thirty-four, fifty-eight, ninety-one</p>
            <p><strong>Rule 2:</strong> Put a <strong>comma</strong> after the word "thousand."</p>
            <p style="padding-left: 16px; color: #555;">Example: eight thousand, two hundred fourteen</p>
            <p><strong>Rule 3:</strong> Do <strong>NOT</strong> use the word "and" in standard math word form.</p>
            <p style="padding-left: 16px; color: var(--science-dark);">&#x2705; five thousand, three hundred twelve</p>
            <p style="padding-left: 16px; color: #DC2626;">&#x274C; five thousand, three hundred <em>and</em> twelve</p>
        </div>

        <div class="math-example">
            <div class="label">Another Example</div>
            <p>The number <strong>40,508</strong>:</p>
            <p><strong>Expanded Form:</strong> 40,000 + 500 + 8</p>
            <p style="color: #555;">(Notice: there are 0 thousands and 0 tens, so we skip them in expanded form.)</p>
            <p><strong>Word Form:</strong> forty thousand, five hundred eight</p>
        </div>
    </div>

    <div class="guided-practice" id="math-guided-wrap" style="border-color: var(--math-primary); background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);">
        <div class="guided-practice-header">
            <span style="font-size: 24px;">&#x1F91D;</span>
            <h3 style="color: var(--math-dark);">Let's Practice Together!</h3>
            <span class="gp-badge" style="background: var(--math-primary);">Guided</span>
        </div>
        <p class="gp-intro" style="color: #1E40AF;">We'll work through these step by step. Follow along — the steps will teach you <em>how</em> to think about each problem, not just the answer.</p>

    <div id="math-guided">
        <!-- GUIDED PROBLEM 1: All Three Forms -->
        <div class="gp-step" style="border-color: var(--math-medium);">
            <div class="gp-step-number" style="background: var(--math-primary);">1</div>
            <h4 style="color: var(--math-dark);">Writing All Three Forms</h4>
            <p>The Mackinac Bridge is <strong>26,372 feet</strong> long. Let's write this number in all three forms.</p>

            <p><strong>Step A:</strong> The standard form is already given: <strong>26,372</strong></p>

            <p><strong>Step B:</strong> Break it into expanded form. What is each digit worth?</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin: 8px 0;">
                <p class="problem-text" style="margin:0;">2 &times; 10,000 = <input type="text" class="answer-input short" data-answer="20000" data-section="math" placeholder="?" data-alt-answers="20,000"></p>
                <p class="problem-text" style="margin:0;">6 &times; 1,000 = <input type="text" class="answer-input short" data-answer="6000" data-section="math" placeholder="?" data-alt-answers="6,000"></p>
                <p class="problem-text" style="margin:0;">3 &times; 100 = <input type="text" class="answer-input short" data-answer="300" data-section="math" placeholder="?"></p>
                <p class="problem-text" style="margin:0;">7 &times; 10 = <input type="text" class="answer-input short" data-answer="70" data-section="math" placeholder="?"></p>
                <p class="problem-text" style="margin:0;">2 &times; 1 = <input type="text" class="answer-input short" data-answer="2" data-section="math" placeholder="?"></p>
            </div>
            <p class="problem-text">Expanded Form: <input type="text" class="answer-input long" data-answer="20000+6000+300+70+2" data-section="math" placeholder="_____ + _____ + _____ + _____ + _____" data-alt-answers="20,000+6,000+300+70+2|20000 + 6000 + 300 + 70 + 2|20,000 + 6,000 + 300 + 70 + 2"></p>

            <p><strong>Step C:</strong> Now write the word form. Remember the rules: hyphen for 21-99, comma after "thousand," no "and."</p>
            <p class="problem-text">Word Form: <input type="text" class="answer-input long" data-answer="twenty-six thousand, three hundred seventy-two" data-section="math" placeholder="Write the number in words..." data-alt-answers="twenty-six thousand three hundred seventy-two"></p>

            <div class="math-example" style="margin-top: 10px;">
                <div class="label">Check yourself</div>
                <p style="margin:0;">Did you use a hyphen in "twenty-six" and "seventy-two"? Did you put a comma after "thousand"? Did you avoid the word "and"? If yes — great job!</p>
            </div>
        </div>

        <!-- GUIDED PROBLEM 2: Zeros in Expanded Form -->
        <div class="gp-step" style="border-color: var(--math-medium);">
            <div class="gp-step-number" style="background: var(--math-primary);">2</div>
            <h4 style="color: var(--math-dark);">Handling Zeros</h4>
            <p>The Great Lakes hold about <strong>84,000</strong> cubic kilometers of water. Write this in expanded form and word form.</p>

            <p><strong>Step A:</strong> Look at each digit. Some are zero! In expanded form, we <strong>skip</strong> places that have a zero.</p>
            <table class="pv-chart">
                <tr><th>Ten-Thousands</th><th>Thousands</th><th>Hundreds</th><th>Tens</th><th>Ones</th></tr>
                <tr>
                    <td><input type="text" class="pv-input" data-answer="8" data-section="math" maxlength="1"></td>
                    <td><input type="text" class="pv-input" data-answer="4" data-section="math" maxlength="1"></td>
                    <td><input type="text" class="pv-input" data-answer="0" data-section="math" maxlength="1"></td>
                    <td><input type="text" class="pv-input" data-answer="0" data-section="math" maxlength="1"></td>
                    <td><input type="text" class="pv-input" data-answer="0" data-section="math" maxlength="1"></td>
                </tr>
            </table>

            <p><strong>Step B:</strong> Expanded Form (only non-zero digits):</p>
            <p class="problem-text">84,000 = <input type="text" class="answer-input long" data-answer="80000+4000" data-section="math" placeholder="_____ + _____" data-alt-answers="80,000+4,000|80000 + 4000|80,000 + 4,000"></p>

            <p><strong>Step C:</strong> Word Form:</p>
            <p class="problem-text"><input type="text" class="answer-input long" data-answer="eighty-four thousand" data-section="math" placeholder="Write in words..."></p>

            <div class="math-example" style="margin-top: 10px;">
                <div class="label">Notice</div>
                <p style="margin:0;">When a number ends in zeros, the word form is short! No hundreds, tens, or ones to write. Just "eighty-four thousand" — done.</p>
            </div>
        </div>

        <!-- GUIDED PROBLEM 3: Five-Digit Number -->
        <div class="gp-step" style="border-color: var(--math-medium);">
            <div class="gp-step-number" style="background: var(--math-primary);">3</div>
            <h4 style="color: var(--math-dark);">A Bigger Number</h4>
            <p>The city of Traverse City, Michigan has a population of about <strong>15,678</strong> people. Write this in expanded form and word form.</p>

            <p><strong>Step A:</strong> Break apart each digit's value:</p>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px; margin: 8px 0;">
                <p class="problem-text" style="margin:0;">1 &times; 10,000 = <input type="text" class="answer-input short" data-answer="10000" data-section="math" placeholder="?" data-alt-answers="10,000"></p>
                <p class="problem-text" style="margin:0;">5 &times; 1,000 = <input type="text" class="answer-input short" data-answer="5000" data-section="math" placeholder="?" data-alt-answers="5,000"></p>
                <p class="problem-text" style="margin:0;">6 &times; 100 = <input type="text" class="answer-input short" data-answer="600" data-section="math" placeholder="?"></p>
                <p class="problem-text" style="margin:0;">7 &times; 10 = <input type="text" class="answer-input short" data-answer="70" data-section="math" placeholder="?"></p>
                <p class="problem-text" style="margin:0;">8 &times; 1 = <input type="text" class="answer-input short" data-answer="8" data-section="math" placeholder="?"></p>
            </div>

            <p><strong>Step B:</strong> Write the expanded form:</p>
            <p class="problem-text">15,678 = <input type="text" class="answer-input long" data-answer="10000+5000+600+70+8" data-section="math" placeholder="_____ + _____ + _____ + _____ + _____" data-alt-answers="10,000+5,000+600+70+8|10000 + 5000 + 600 + 70 + 8|10,000 + 5,000 + 600 + 70 + 8"></p>

            <p><strong>Step C:</strong> Write the word form:</p>
            <p class="problem-text"><input type="text" class="answer-input long" data-answer="fifteen thousand, six hundred seventy-eight" data-section="math" placeholder="Write in words..." data-alt-answers="fifteen thousand six hundred seventy-eight"></p>

            <div class="math-example" style="margin-top: 10px;">
                <div class="label">Word form tip</div>
                <p style="margin:0;">Say the number out loud: "fifteen thousand, six hundred seventy-eight." That's exactly how you write it! Don't forget the hyphen in "seventy-eight."</p>
            </div>
        </div>
    </div>

    <button class="check-btn math-check" onclick="checkSection('math-guided')">Check Guided Practice</button>
    <div class="feedback" id="math-guided-fb"></div>
    </div>

    <div class="subsection-pill math">On Your Own</div>
    <div id="math-independent">
        <div class="question">
            <p class="problem-text"><span class="m-number">1</span> Write <strong>53,019</strong> in expanded form and word form.</p>
            <p class="problem-text">Expanded Form: <input type="text" class="answer-input long" data-answer="50000+3000+10+9" data-section="math" placeholder="_____ + _____ + _____ + _____" data-alt-answers="50,000+3,000+10+9|50000 + 3000 + 10 + 9|50,000 + 3,000 + 10 + 9"></p>
            <p class="problem-text">Word Form: <input type="text" class="answer-input long" data-answer="fifty-three thousand, nineteen" data-section="math" placeholder="Write in words..." data-alt-answers="fifty-three thousand nineteen"></p>
        </div>
        <div class="question">
            <p class="problem-text"><span class="m-number">2</span> Write the word form as a number in standard form: <strong>twelve thousand, four hundred sixty-five</strong></p>
            <p class="problem-text">Standard Form: <input type="text" class="answer-input medium" data-answer="12465" data-section="math" placeholder="?" data-alt-answers="12,465"></p>
        </div>
        <div class="question">
            <p class="problem-text"><span class="m-number">3</span> Fill in the missing forms.</p>
            <table class="pv-chart" style="margin: 10px 0;">
                <tr><th>Standard Form</th><th>Expanded Form</th><th>Word Form</th></tr>
                <tr>
                    <td style="text-align:center; font-weight:700;">7,240</td>
                    <td><input type="text" class="answer-input" data-answer="7000+200+40" data-section="math" placeholder="expanded..." style="width:100%;" data-alt-answers="7,000+200+40|7000 + 200 + 40|7,000 + 200 + 40"></td>
                    <td><input type="text" class="answer-input" data-answer="seven thousand, two hundred forty" data-section="math" placeholder="word form..." style="width:100%;" data-alt-answers="seven thousand two hundred forty"></td>
                </tr>
                <tr>
                    <td><input type="text" class="answer-input" data-answer="31652" data-section="math" placeholder="standard..." style="width:100%; text-align:center;" data-alt-answers="31,652"></td>
                    <td style="text-align:center; font-weight:700; font-size:12px;">30,000 + 1,000 + 600 + 50 + 2</td>
                    <td><input type="text" class="answer-input" data-answer="thirty-one thousand, six hundred fifty-two" data-section="math" placeholder="word form..." style="width:100%;" data-alt-answers="thirty-one thousand six hundred fifty-two"></td>
                </tr>
                <tr>
                    <td><input type="text" class="answer-input" data-answer="68903" data-section="math" placeholder="standard..." style="width:100%; text-align:center;" data-alt-answers="68,903"></td>
                    <td><input type="text" class="answer-input" data-answer="60000+8000+900+3" data-section="math" placeholder="expanded..." style="width:100%;" data-alt-answers="60,000+8,000+900+3|60000 + 8000 + 900 + 3|60,000 + 8,000 + 900 + 3"></td>
                    <td style="font-weight:700; font-size:12px;">sixty-eight thousand, nine hundred three</td>
                </tr>
            </table>
        </div>
        <div class="question">
            <p class="problem-text"><span class="m-number">4</span> A student wrote the word form of 90,470 as "ninety thousand, four hundred and seventy." What mistake did the student make? Write the correct word form.</p>
            <textarea class="answer-textarea" data-section="math" data-rubric-type="explain" data-rubric-keywords="and,should not,remove,no and,rule,ninety thousand,four hundred seventy" data-rubric-min-words="5" placeholder="What's wrong? Write the correct version..." rows="2"></textarea>
        </div>
        <div class="question">
            <p class="problem-text"><span class="m-number">5</span> The expanded form is: <strong>60,000 + 2,000 + 80 + 5</strong>. Write it in standard form and word form.</p>
            <p class="problem-text">Standard Form: <input type="text" class="answer-input medium" data-answer="62085" data-section="math" placeholder="?" data-alt-answers="62,085"></p>
            <p class="problem-text">Word Form: <input type="text" class="answer-input long" data-answer="sixty-two thousand, eighty-five" data-section="math" placeholder="Write in words..." data-alt-answers="sixty-two thousand eighty-five"></p>
        </div>
    </div>

    <button class="check-btn math-check" onclick="checkSection('math-independent')">Check My Answers</button>
    <div class="feedback" id="math-independent-fb"></div>

    <div class="challenge-box">
        <div class="challenge-header">&#x2B50; Challenge Problem</div>
        <div class="challenge-content">
            <p class="problem-text"><strong>Mystery Number:</strong> Use the clues to figure out what number I am.</p>
            <ul style="padding-left: 20px; margin: 8px 0;">
                <li>I am a 4-digit number.</li>
                <li>My expanded form has a <strong>0 in the hundreds place</strong> (there is no hundreds value).</li>
                <li>My thousands digit is the largest single-digit odd number.</li>
                <li>My tens digit is half of my thousands digit (round down).</li>
                <li>My ones digit is the same as my tens digit.</li>
                <li>When you write me in word form, you need exactly one hyphen.</li>
            </ul>
            <p class="problem-text">Standard Form: <input type="text" class="answer-input medium" data-answer="9044" data-section="math" placeholder="?" data-alt-answers="9,044"></p>
            <p class="problem-text">Expanded Form: <input type="text" class="answer-input long" data-answer="9000+40+4" data-section="math" placeholder="_____ + _____ + _____" data-alt-answers="9,000+40+4|9000 + 40 + 4|9,000 + 40 + 4"></p>
            <p class="problem-text">Word Form: <input type="text" class="answer-input long" data-answer="nine thousand, forty-four" data-section="math" placeholder="Write in words..." data-alt-answers="nine thousand forty-four"></p>
        </div>
    </div>

    <button class="review-btn" onclick="reviewSection('math')" style="border-color:var(--math-primary);background:var(--math-light);color:var(--math-dark);">&#x1F4CB; Review My Math Work</button>
    <label class="paper-checkbox" onclick="togglePaper(this)"><input type="checkbox" data-section="math" data-paper="true"><span>Completed on paper</span></label>

    <div class="section-complete" id="math-complete">
        <div class="emoji">&#x1F4D0;</div>
        <div class="msg">Math Complete! +80 XP</div>
    </div>
</div>

<!-- ============================================ -->
<!-- BLOCK 4: LANGUAGE ARTS -->
<!-- ============================================ -->
<div class="subject-section" id="section-grammar" data-xp="60">
    <div class="subject-banner banner-grammar">
        <div class="icon">&#x270D;&#xFE0F;</div>
        <div class="title-group"><h2>Language Arts</h2></div>
        <div class="time-badge">30 min</div>
    </div>

    <div class="grammar-rule-box">
        <h3>Grammar: Commas in a Series</h3>
        <p class="problem-text">When you list <strong>three or more items</strong> in a sentence, you need to separate them with <strong>commas</strong>. This is called a <strong>series</strong> (or a list).</p>
        <p class="problem-text">Put a comma after each item in the list <strong>except the very last one</strong>, which gets the word "and" (or "or") before it.</p>

        <div class="grammar-rule">
            <div class="rule-label">The Rule</div>
            <p class="grammar-example"><strong>Item 1<span style="color: var(--social-primary);">,</span> Item 2<span style="color: var(--social-primary);">,</span> and Item 3</strong></p>
        </div>

        <div class="grammar-rule">
            <div class="rule-label">Examples</div>
            <p class="grammar-example"><span class="grammar-correct">&#x2705; The Ojibwe<strong>,</strong> Odawa<strong>,</strong> and Potawatomi formed the Three Fires Confederacy.</span></p>
            <p class="grammar-example"><span class="grammar-correct">&#x2705; Michigan is known for its lakes<strong>,</strong> forests<strong>,</strong> and sand dunes.</span></p>
            <p class="grammar-example"><span class="grammar-incorrect">&#x274C; Michigan is known for its lakes forests and sand dunes.</span> (missing commas!)</p>
        </div>

        <div class="grammar-rule">
            <div class="rule-label">The Oxford Comma</div>
            <p class="problem-text">Notice the comma that comes <strong>right before the word "and"</strong> in a list? That comma has a special name: the <strong>Oxford comma</strong> (also called the serial comma). Some writers skip it, but using it helps avoid confusion.</p>
            <p class="grammar-example"><span class="grammar-correct">&#x2705; I love my parents<strong>,</strong> Batman<strong>,</strong> and Superman.</span> (3 separate things)</p>
            <p class="grammar-example"><span class="grammar-incorrect">&#x274C; I love my parents, Batman and Superman.</span> (Wait... are your parents Batman and Superman?)</p>
            <p class="problem-text" style="margin-top: 6px;"><strong>In this class, we always use the Oxford comma.</strong></p>
        </div>

        <div class="grammar-rule">
            <div class="rule-label">Important: Only for 3 or More</div>
            <p class="problem-text">You do <strong>NOT</strong> need a comma when listing only two items.</p>
            <p class="grammar-example"><span class="grammar-correct">&#x2705; The Upper Peninsula and Lower Peninsula make up Michigan.</span> (only 2 — no comma needed)</p>
            <p class="grammar-example"><span class="grammar-correct">&#x2705; Spring<strong>,</strong> summer<strong>,</strong> fall<strong>,</strong> and winter are the four seasons.</span> (4 items — commas needed)</p>
        </div>
    </div>

    <div class="subsection-pill ela">Practice</div>
    <p class="problem-text" style="margin-bottom: 12px;"><strong>Directions (1-4):</strong> Add commas where they belong in each sentence. Rewrite the sentence correctly. If the sentence is already correct, write "correct."</p>

    <div class="question">
        <p class="problem-text"><span class="g-number">1</span> "The Anishinaabe harvested wild rice berries and maple sugar."</p>
        <textarea class="answer-textarea" data-section="grammar" data-rubric-type="sentence-rewrite" data-rubric-keywords="rice,berries,maple,sugar,comma" data-rubric-structure="has-commas" data-rubric-min-words="5" placeholder="Rewrite with correct commas..." rows="1"></textarea>
    </div>
    <div class="question">
        <p class="problem-text"><span class="g-number">2</span> "Michigan borders Lake Superior Lake Michigan Lake Huron and Lake Erie."</p>
        <textarea class="answer-textarea" data-section="grammar" data-rubric-type="sentence-rewrite" data-rubric-keywords="Superior,Michigan,Huron,Erie,comma" data-rubric-structure="has-commas" data-rubric-min-words="5" placeholder="Rewrite with correct commas..." rows="1"></textarea>
    </div>
    <div class="question">
        <p class="problem-text"><span class="g-number">3</span> "In winter the Anishinaabe told stories rested and prepared tools."</p>
        <textarea class="answer-textarea" data-section="grammar" data-rubric-type="sentence-rewrite" data-rubric-keywords="stories,rested,prepared,tools,comma" data-rubric-structure="has-commas" data-rubric-min-words="5" placeholder="Rewrite with correct commas..." rows="1"></textarea>
    </div>
    <div class="question">
        <p class="problem-text"><span class="g-number">4</span> "We studied place value and expanded form in math class."</p>
        <textarea class="answer-textarea" data-section="grammar" data-rubric-type="sentence-rewrite" data-rubric-keywords="correct,two items,no comma" data-rubric-min-words="1" placeholder="Rewrite with commas, or write 'correct'..." rows="1"></textarea>
    </div>

    <p class="problem-text" style="margin-bottom: 12px; margin-top: 16px;"><strong>Directions (5-6):</strong> Write your own sentences that include a list of three or more items. Remember to use commas correctly, including the Oxford comma.</p>

    <div class="question">
        <p class="problem-text"><span class="g-number">5</span> Write a sentence that lists three foods you enjoy eating.</p>
        <textarea class="answer-textarea" data-section="grammar" data-rubric-type="sentence-rewrite" data-rubric-keywords="and,comma" data-rubric-structure="has-commas,has-subject,has-verb,ends-punctuation" data-rubric-min-words="5" placeholder="Write a sentence with a list of 3 foods..." rows="1"></textarea>
    </div>
    <div class="question">
        <p class="problem-text"><span class="g-number">6</span> Write a sentence that lists four things you might see in Michigan.</p>
        <textarea class="answer-textarea" data-section="grammar" data-rubric-type="sentence-rewrite" data-rubric-keywords="and,comma,Michigan" data-rubric-structure="has-commas,has-subject,has-verb,ends-punctuation" data-rubric-min-words="5" placeholder="Write a sentence with a list of 4 Michigan things..." rows="1"></textarea>
    </div>

    <div class="subsection-pill ela">Writing: Edit Your Draft</div>
    <p class="problem-text"><strong>This week's writing project:</strong> You are writing an <strong>informational paragraph</strong> about Michigan. You brainstormed on Monday, drafted on Tuesday, and revised on Wednesday.</p>
    <p class="problem-text"><strong>Today's step:</strong> Edit. Go back to your draft from yesterday. Use the checklist below to find and fix any errors.</p>

    <div class="goal-box" style="border-color: var(--ela-primary); background: #F5F3FF;">
        <p class="problem-text" style="margin-bottom: 8px;"><strong>Editing Checklist</strong></p>
        <label class="paper-checkbox" onclick="event.stopPropagation()"><input type="checkbox" data-section="grammar"><span>Every sentence starts with a capital letter.</span></label>
        <label class="paper-checkbox" onclick="event.stopPropagation()"><input type="checkbox" data-section="grammar"><span>Every sentence ends with punctuation.</span></label>
        <label class="paper-checkbox" onclick="event.stopPropagation()"><input type="checkbox" data-section="grammar"><span>All proper nouns are capitalized (Michigan, Great Lakes, Anishinaabe).</span></label>
        <label class="paper-checkbox" onclick="event.stopPropagation()"><input type="checkbox" data-section="grammar"><span>I used commas in any lists of three or more items.</span></label>
        <label class="paper-checkbox" onclick="event.stopPropagation()"><input type="checkbox" data-section="grammar"><span>I spelled all words correctly.</span></label>
        <label class="paper-checkbox" onclick="event.stopPropagation()"><input type="checkbox" data-section="grammar"><span>My sentences are complete (not fragments).</span></label>
    </div>

    <p class="problem-text" style="margin-top: 12px;">How many corrections did you make? <input type="text" class="answer-input short" data-section="grammar" placeholder="#"></p>

    <p class="problem-text">Pick one sentence you improved. Write the <strong>before</strong> and <strong>after</strong>:</p>
    <div class="question">
        <p class="problem-text"><strong>Before:</strong></p>
        <textarea class="answer-textarea" data-section="grammar" data-rubric-type="sentence-rewrite" data-rubric-min-words="3" placeholder="Write the original sentence..." rows="1"></textarea>
    </div>
    <div class="question">
        <p class="problem-text"><strong>After:</strong></p>
        <textarea class="answer-textarea" data-section="grammar" data-rubric-type="sentence-rewrite" data-rubric-min-words="3" placeholder="Write the corrected sentence..." rows="1"></textarea>
    </div>

    <button class="review-btn" onclick="reviewSection('grammar')">&#x1F4CB; Review My Writing Work</button>
    <label class="paper-checkbox" onclick="togglePaper(this)"><input type="checkbox" data-section="grammar" data-paper="true"><span>Completed on paper</span></label>

    <div class="section-complete" id="grammar-complete">
        <div class="emoji">&#x270D;&#xFE0F;</div>
        <div class="msg">Language Arts Complete! +60 XP</div>
    </div>
</div>

<!-- ============================================ -->
<!-- BLOCK 5: SOCIAL STUDIES -->
<!-- ============================================ -->
<div class="subject-section" id="section-social" data-xp="70">
    <div class="subject-banner banner-social">
        <div class="icon">&#x1F30D;</div>
        <div class="title-group"><h2>Social Studies: The Anishinaabe</h2></div>
        <div class="time-badge">40 min</div>
    </div>

    <div class="goal-box">
        <strong>Today's Goal:</strong> Learn about the Anishinaabe Seasonal Round — how the Three Fires people moved with the seasons to gather food and resources. Understand how their way of life reflected deep knowledge of the natural world.
    </div>

    <div class="passage-box" style="border-color: var(--social-primary);">
        <div class="passage-header" style="background: var(--social-light); border-color: var(--social-primary);">
            <span class="passage-title" style="color: var(--social-dark);">The Seasonal Round</span>
            <span class="passage-meta" style="background: var(--social-medium); color: var(--social-dark);">Social Studies Reading</span>
        </div>
        <div class="passage-body">
            <p style="text-indent: 0;">In your reading passage today, you learned that the Anishinaabe people followed the Seasonal Round — a cycle of activities that matched the rhythms of nature. But why did they move with the seasons? The answer is simple and brilliant: different foods and resources are available at different times of the year. Instead of staying in one place and hoping for the best, the Anishinaabe traveled to where the food was, exactly when it was ready.</p>
            <p>This was not wandering. The Seasonal Round was carefully planned. Families returned to the same maple groves, fishing camps, and wild rice lakes year after year. They knew exactly when the sugar maples would start flowing in spring, when the walleye would run in the rivers, and when the manoomin would ripen in the fall. This knowledge was passed from grandparents to grandchildren through stories, songs, and hands-on teaching.</p>
            <p>The Seasonal Round also shaped Anishinaabe communities. In spring and summer, smaller family groups spread out to fish, garden, and gather. In fall, larger groups came together for the wild rice harvest, which required many hands. In winter, extended families gathered in sheltered woodland camps, where elders shared stories that carried the history and wisdom of the people. Every season had its purpose, its work, and its teachings.</p>
            <p>Today, many Anishinaabe people continue seasonal traditions. Tribal communities in Michigan still harvest wild rice, tap maple trees, and fish using traditional methods. The Seasonal Round is not just history — it is a living practice that connects Anishinaabe people to their ancestors and to the land.</p>
        </div>
    </div>

    <div class="subsection-pill social">Anishinaabe Seasonal Vocabulary</div>
    <table class="pv-chart" style="margin-top: 8px;">
        <tr>
            <th style="background: var(--social-primary);">English</th>
            <th style="background: var(--social-primary);">Anishinaabemowin</th>
            <th style="background: var(--social-primary);">Pronunciation</th>
            <th style="background: var(--social-primary);">Key Activities</th>
        </tr>
        <tr>
            <td><strong>Spring</strong></td>
            <td>Ziigwan</td>
            <td>ZEE-gwahn</td>
            <td style="text-align: left;">Maple sugaring, moving to sugar camps</td>
        </tr>
        <tr>
            <td><strong>Summer</strong></td>
            <td>Niibin</td>
            <td>NEE-bin</td>
            <td style="text-align: left;">Fishing, gardening, gathering berries</td>
        </tr>
        <tr>
            <td><strong>Fall</strong></td>
            <td>Dagwaagin</td>
            <td>duh-GWAH-gin</td>
            <td style="text-align: left;">Wild rice harvest, hunting</td>
        </tr>
        <tr>
            <td><strong>Winter</strong></td>
            <td>Biboon</td>
            <td>bih-BOON</td>
            <td style="text-align: left;">Storytelling, tool-making, resting</td>
        </tr>
    </table>

    <div class="subsection-pill social">Activity: Create a Seasonal Round Chart</div>
    <p class="problem-text"><strong>Directions:</strong> The Seasonal Round is often shown as a circle because the cycle repeats every year. In each section below, write what the Anishinaabe did during that season and what resources were available. Use information from both today's reading passage and the social studies reading above.</p>

    <table class="pv-chart" style="margin-top: 12px;">
        <tr>
            <th style="background: var(--social-primary); width: 50%;">Spring / Ziigwan</th>
            <th style="background: var(--social-primary); width: 50%;">Summer / Niibin</th>
        </tr>
        <tr>
            <td style="vertical-align: top; text-align: left; padding: 12px;">
                <p class="problem-text" style="font-size: 11px; color: #999; margin-bottom: 4px;"><em>Activities:</em></p>
                <textarea class="answer-textarea" data-section="social" data-rubric-type="fact-list" data-rubric-keywords="maple,sugar,camp,sap,tree" data-rubric-min-words="3" placeholder="What did they do in spring?" rows="2" style="font-size:13px;"></textarea>
                <p class="problem-text" style="font-size: 11px; color: #999; margin-bottom: 4px; margin-top: 6px;"><em>Resources:</em></p>
                <textarea class="answer-textarea" data-section="social" data-rubric-type="fact-list" data-rubric-keywords="maple,syrup,sugar,sap" data-rubric-min-words="2" placeholder="What resources?" rows="1" style="font-size:13px;"></textarea>
            </td>
            <td style="vertical-align: top; text-align: left; padding: 12px;">
                <p class="problem-text" style="font-size: 11px; color: #999; margin-bottom: 4px;"><em>Activities:</em></p>
                <textarea class="answer-textarea" data-section="social" data-rubric-type="fact-list" data-rubric-keywords="fish,garden,berries,gather" data-rubric-min-words="3" placeholder="What did they do in summer?" rows="2" style="font-size:13px;"></textarea>
                <p class="problem-text" style="font-size: 11px; color: #999; margin-bottom: 4px; margin-top: 6px;"><em>Resources:</em></p>
                <textarea class="answer-textarea" data-section="social" data-rubric-type="fact-list" data-rubric-keywords="fish,berries,vegetables,garden" data-rubric-min-words="2" placeholder="What resources?" rows="1" style="font-size:13px;"></textarea>
            </td>
        </tr>
        <tr>
            <th style="background: var(--social-primary); width: 50%;">Fall / Dagwaagin</th>
            <th style="background: var(--social-primary); width: 50%;">Winter / Biboon</th>
        </tr>
        <tr>
            <td style="vertical-align: top; text-align: left; padding: 12px;">
                <p class="problem-text" style="font-size: 11px; color: #999; margin-bottom: 4px;"><em>Activities:</em></p>
                <textarea class="answer-textarea" data-section="social" data-rubric-type="fact-list" data-rubric-keywords="rice,harvest,hunt,manoomin" data-rubric-min-words="3" placeholder="What did they do in fall?" rows="2" style="font-size:13px;"></textarea>
                <p class="problem-text" style="font-size: 11px; color: #999; margin-bottom: 4px; margin-top: 6px;"><em>Resources:</em></p>
                <textarea class="answer-textarea" data-section="social" data-rubric-type="fact-list" data-rubric-keywords="wild rice,game,meat" data-rubric-min-words="2" placeholder="What resources?" rows="1" style="font-size:13px;"></textarea>
            </td>
            <td style="vertical-align: top; text-align: left; padding: 12px;">
                <p class="problem-text" style="font-size: 11px; color: #999; margin-bottom: 4px;"><em>Activities:</em></p>
                <textarea class="answer-textarea" data-section="social" data-rubric-type="fact-list" data-rubric-keywords="stories,storytelling,tools,rest" data-rubric-min-words="3" placeholder="What did they do in winter?" rows="2" style="font-size:13px;"></textarea>
                <p class="problem-text" style="font-size: 11px; color: #999; margin-bottom: 4px; margin-top: 6px;"><em>Resources:</em></p>
                <textarea class="answer-textarea" data-section="social" data-rubric-type="fact-list" data-rubric-keywords="stored food,wisdom,stories" data-rubric-min-words="2" placeholder="What resources?" rows="1" style="font-size:13px;"></textarea>
            </td>
        </tr>
    </table>

    <div class="subsection-pill social">Discussion Question</div>
    <div class="question">
        <p class="problem-text">How is the Anishinaabe way of living with the seasons different from how most people live today? What can we learn from it?</p>
        <textarea class="answer-textarea" data-section="social" data-track-words="true" data-rubric-type="compare-contrast" data-rubric-keywords="Anishinaabe,seasons,today,different,move,stay,food,nature,learn,knowledge,land,grocery,store" data-rubric-min-words="15" data-rubric-structure="names-both" placeholder="Compare the Anishinaabe way of life to how we live today..." rows="4"></textarea>
        <div class="word-count">0 words</div>
    </div>

    <button class="review-btn" onclick="reviewSection('social')" style="border-color:var(--social-primary);background:var(--social-light);color:var(--social-dark);">&#x1F4CB; Review My Social Studies Work</button>
    <label class="paper-checkbox" onclick="togglePaper(this)"><input type="checkbox" data-section="social" data-paper="true"><span>Completed on paper</span></label>

    <div class="section-complete" id="social-complete">
        <div class="emoji">&#x1F30D;</div>
        <div class="msg">Social Studies Complete! +70 XP</div>
    </div>
</div>

<!-- ============================================ -->
<!-- READING LOG -->
<!-- ============================================ -->
<div class="subject-section" id="section-readinglog" data-xp="30">
    <div class="subject-banner" style="background: #F8FAFC; border-color: #94A3B8;">
        <div class="icon">&#x1F4D6;</div>
        <div class="title-group"><h2 style="color: #334155;">Independent Reading Log</h2></div>
        <div class="time-badge" style="color: #475569;">20 min</div>
    </div>

    <div class="goal-box">
        <strong>Today's Goal:</strong> Read a book you enjoy for 20 minutes. Then tell us what happened!
    </div>

    <p class="problem-text">Read independently for at least 20 minutes today. Use the timer below, then fill in your log when you're done.</p>

    <div class="timer-bar">
        <div class="timer-display" id="timerDisplay">20:00</div>
        <button class="timer-btn" id="timerStartBtn" onclick="toggleTimer()">Start</button>
        <button class="timer-btn" onclick="resetTimer()">Reset</button>
    </div>

    <table class="reading-log-table">
        <tr>
            <th style="width: 30%;">Book Title</th>
            <th style="width: 20%;">Pages Read</th>
            <th style="width: 50%;">One sentence about what happened</th>
        </tr>
        <tr>
            <td><input type="text" id="bookTitleInput" data-section="readinglog" placeholder="Book title..." list="bookTitleHistory" autocomplete="off"></td>
            <td><input type="text" id="bookPagesInput" data-section="readinglog" placeholder="Pages..."></td>
            <td><textarea data-section="readinglog" placeholder="What happened in your reading today?" rows="2" style="font-family:'Patrick Hand',cursive;font-size:16px;width:100%;border:2px solid #e2e8f0;border-radius:6px;padding:6px 8px;outline:none;resize:vertical;"></textarea></td>
        </tr>
    </table>
    <datalist id="bookTitleHistory"></datalist>

    <div class="section-complete" id="readinglog-complete">
        <div class="emoji">&#x1F4D6;</div>
        <div class="msg">Reading Log Complete! +30 XP</div>
    </div>
</div>

<!-- Page Navigation Footer -->
<div class="page-nav-footer" id="pageNavFooter">
    <button class="page-nav-btn prev-btn" id="prevPageBtn" onclick="prevPage()">&larr; Previous</button>
    <span class="page-indicator" id="pageIndicator">1 of 6</span>
    <button class="page-nav-btn next-btn" id="nextPageBtn" onclick="nextPage()">Next &rarr;</button>
</div>

</div><!-- end main-content -->

<script>
// ==========================================
// CONFIG
// ==========================================
const DAY_ID = 'w1-thursday';
const PROFILES_KEY = 'rootaccess-profiles';
const ACTIVE_PROFILE_KEY = 'rootaccess-active-profile';
let STORAGE_KEY = 'rootaccess-' + DAY_ID; // updated after profile loads
let activeProfileId = null;
let totalXP = 0;
const sectionXPAwarded = {};

// ==========================================
// PROFILE HELPERS
// ==========================================
async function getActiveProfile() {
    activeProfileId = await localforage.getItem(ACTIVE_PROFILE_KEY);
    if (activeProfileId) {
        STORAGE_KEY = 'rootaccess-' + activeProfileId + '-' + DAY_ID;
    } else {
        STORAGE_KEY = 'rootaccess-' + DAY_ID;
    }
    return activeProfileId;
}

async function getProfileName() {
    if (!activeProfileId) return '';
    const profiles = (await localforage.getItem(PROFILES_KEY)) || [];
    const profile = profiles.find(p => p.id === activeProfileId);
    return profile ? profile.name : '';
}

// ==========================================
// SAVE / LOAD
// ==========================================
async function saveAll() {
    const data = {};
    data.studentName = document.getElementById('studentName').value;
    data.totalXP = totalXP;
    data.sectionXPAwarded = sectionXPAwarded;
    const inputs = document.querySelectorAll('input[data-section], textarea[data-section]');
    inputs.forEach((el, i) => { data['input-' + i] = el.value; });
    const sfQuestions = document.querySelectorAll('.sf-toggle');
    sfQuestions.forEach((toggle, i) => {
        const selected = toggle.querySelector('.selected');
        if (selected) data['sf-' + i] = selected.dataset.val;
    });
    data.timerSeconds = timerSeconds;
    data.currentPage = currentPage;
    // Save paper checkbox states
    document.querySelectorAll('input[data-paper]').forEach(cb => {
        data['paper-' + cb.dataset.section] = cb.checked;
    });
    await localforage.setItem(STORAGE_KEY, data);
    const status = document.getElementById('saveStatus');
    status.classList.add('show');
    setTimeout(() => status.classList.remove('show'), 1500);
}

async function loadAll() {
    const data = await localforage.getItem(STORAGE_KEY);
    if (!data) return;
    if (data.studentName) document.getElementById('studentName').value = data.studentName;
    if (data.totalXP) { totalXP = data.totalXP; document.getElementById('xpTotal').textContent = totalXP; }
    if (data.sectionXPAwarded) Object.assign(sectionXPAwarded, data.sectionXPAwarded);
    const inputs = document.querySelectorAll('input[data-section], textarea[data-section]');
    inputs.forEach((el, i) => {
        if (data['input-' + i]) {
            el.value = data['input-' + i];
            if (el.tagName === 'TEXTAREA' && el.value) el.classList.add('has-content');
        }
    });
    const sfQuestions = document.querySelectorAll('.sf-toggle');
    sfQuestions.forEach((toggle, i) => {
        if (data['sf-' + i]) {
            const btn = toggle.querySelector(`button[data-val="${data['sf-' + i]}"]`);
            if (btn) {
                btn.classList.add('selected');
                if (data['sf-' + i] === 'F') {
                    const ta = toggle.closest('.question').querySelector('textarea');
                    if (ta) ta.style.display = '';
                }
            }
        }
    });
    if (data.timerSeconds !== undefined) { timerSeconds = data.timerSeconds; updateTimerDisplay(); }
    // Restore current page
    if (data.currentPage && PAGE_ORDER.includes(data.currentPage)) {
        showPage(data.currentPage);
    }
    // Restore paper checkbox states
    document.querySelectorAll('input[data-paper]').forEach(cb => {
        if (data['paper-' + cb.dataset.section]) {
            cb.checked = true;
            cb.closest('.paper-checkbox').classList.add('checked');
        }
    });
    // Check spelling inputs
    document.querySelectorAll('input[data-spell]').forEach(checkSpellingInput);
    updateProgress();
    updateWordCounts();
    await loadHighlights();
}

// ==========================================
// XP SYSTEM
// ==========================================
function awardXP(sectionId) {
    if (sectionXPAwarded[sectionId]) return;
    const sectionEl = document.getElementById('section-' + sectionId);
    if (!sectionEl) return;
    let xp = parseInt(sectionEl.dataset.xp) || 0;
    if (xp === 0) return;
    // Half XP if any input in this section was helped
    const helpedInputs = sectionEl.querySelectorAll('[data-helped="true"]');
    const wasHelped = helpedInputs.length > 0;
    if (wasHelped) xp = Math.round(xp / 2);
    sectionXPAwarded[sectionId] = true;
    totalXP += xp;
    document.getElementById('xpTotal').textContent = totalXP;
    trackEvent('section_complete', { section: sectionId, xp: xp });
    // Toast
    const toast = document.getElementById('xpToast');
    document.getElementById('xpToastAmount').textContent = '+' + xp;
    if (wasHelped) toast.classList.add('half');
    else toast.classList.remove('half');
    toast.classList.add('show');
    setTimeout(() => { toast.classList.remove('show', 'half'); }, 2500);
    saveAll();
}

// ==========================================
// PROGRESS TRACKING
// ==========================================
function updateProgress() {
    const allInputs = document.querySelectorAll('input[data-section], textarea[data-section]');
    let filled = 0, total = allInputs.length;
    allInputs.forEach(el => { if (el.value.trim().length > 0) filled++; });
    const sfToggles = document.querySelectorAll('.sf-toggle');
    total += sfToggles.length;
    sfToggles.forEach(toggle => { if (toggle.querySelector('.selected')) filled++; });
    const pct = Math.round((filled / total) * 100);
    document.getElementById('progressBar').style.width = pct + '%';
    document.getElementById('progressText').textContent = pct + '%';
    updateSectionStatus();
    // Check for 100% completion
    if (pct === 100 && !window._celebrationShown) { window._celebrationShown = true; showCelebration(); }
}

function updateSectionStatus() {
    const sections = ['warmup', 'reading', 'math', 'grammar', 'social', 'readinglog'];
    sections.forEach(sec => {
        const sectionEl = document.getElementById('section-' + sec);
        if (!sectionEl) return;
        const inputs = sectionEl.querySelectorAll('input[data-section], textarea[data-section]');
        const sfToggles = sectionEl.querySelectorAll('.sf-toggle');
        let filled = 0, total = inputs.length + sfToggles.length;
        inputs.forEach(el => { if (el.value.trim()) filled++; });
        sfToggles.forEach(t => { if (t.querySelector('.selected')) filled++; });
        const btn = document.querySelector(`.section-nav button[data-section="${sec}"]`);
        const completeEl = document.getElementById(sec + '-complete');
        if (total > 0 && filled >= total) {
            if (btn) btn.classList.add('completed');
            if (completeEl) completeEl.classList.add('show');
            awardXP(sec);
            // Save book to history when reading log is completed
            if (sec === 'readinglog') {
                var bt = document.getElementById('bookTitleInput');
                var bp = document.getElementById('bookPagesInput');
                if (bt && bp) saveBookToHistory(bt.value, bp.value);
            }
        } else {
            if (btn) btn.classList.remove('completed');
            if (completeEl) completeEl.classList.remove('show');
        }
    });
}

// ==========================================
// CELEBRATION + CONFETTI
// ==========================================
function showCelebration() {
    const name = document.getElementById('studentName').value || 'student';
    document.getElementById('celebrationName').textContent = 'Amazing work, ' + name + '!';
    document.getElementById('celebrationXP').textContent = totalXP + ' XP Earned!';
    document.getElementById('celebrationOverlay').classList.add('show');
    launchConfetti();
    playChime();
}
function closeCelebration() {
    document.getElementById('celebrationOverlay').classList.remove('show');
}

function launchConfetti() {
    const canvas = document.getElementById('confettiCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    const colors = ['#2563EB','#7C3AED','#059669','#EA580C','#F59E0B','#EC4899','#0891B2'];
    const pieces = [];
    for (let i = 0; i < 150; i++) {
        pieces.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height - canvas.height,
            w: Math.random() * 10 + 5,
            h: Math.random() * 6 + 3,
            color: colors[Math.floor(Math.random() * colors.length)],
            vy: Math.random() * 3 + 2,
            vx: (Math.random() - 0.5) * 2,
            rot: Math.random() * 360,
            vr: (Math.random() - 0.5) * 8
        });
    }
    let frame = 0;
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        pieces.forEach(p => {
            p.y += p.vy;
            p.x += p.vx;
            p.rot += p.vr;
            ctx.save();
            ctx.translate(p.x, p.y);
            ctx.rotate(p.rot * Math.PI / 180);
            ctx.fillStyle = p.color;
            ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
            ctx.restore();
        });
        frame++;
        if (frame < 180) requestAnimationFrame(draw);
        else ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
    draw();
}

// ==========================================
// AUDIO (chime + speech)
// ==========================================
function playChime() {
    try {
        const ac = new (window.AudioContext || window.webkitAudioContext)();
        [523.25, 659.25, 783.99].forEach((freq, i) => {
            const osc = ac.createOscillator();
            const gain = ac.createGain();
            osc.type = 'sine';
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.3, ac.currentTime + i * 0.15);
            gain.gain.exponentialRampToValueAtTime(0.01, ac.currentTime + i * 0.15 + 0.5);
            osc.connect(gain);
            gain.connect(ac.destination);
            osc.start(ac.currentTime + i * 0.15);
            osc.stop(ac.currentTime + i * 0.15 + 0.5);
        });
    } catch(e) {}
}

function playTimerChime() {
    try {
        const ac = new (window.AudioContext || window.webkitAudioContext)();
        [440, 554.37, 659.25, 880].forEach((freq, i) => {
            const osc = ac.createOscillator();
            const gain = ac.createGain();
            osc.type = 'triangle';
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(0.25, ac.currentTime + i * 0.2);
            gain.gain.exponentialRampToValueAtTime(0.01, ac.currentTime + i * 0.2 + 0.4);
            osc.connect(gain);
            gain.connect(ac.destination);
            osc.start(ac.currentTime + i * 0.2);
            osc.stop(ac.currentTime + i * 0.2 + 0.4);
        });
    } catch(e) {}
}

// ==========================================
// VOICE SELECTION
// ==========================================
let preferredVoice = null;

function pickBestVoice() {
    const voices = window.speechSynthesis.getVoices();
    if (!voices.length) return null;
    // Ranked preference: natural/premium English voices
    const preferred = [
        'Samantha', 'Karen', 'Daniel', 'Moira',          // macOS natural
        'Google US English', 'Google UK English Female',   // Chrome
        'Microsoft Zira', 'Microsoft David',               // Windows
        'Alex', 'Victoria', 'Tessa'                        // macOS fallbacks
    ];
    for (const name of preferred) {
        const match = voices.find(v => v.name.includes(name) && v.lang.startsWith('en'));
        if (match) return match;
    }
    // Fallback: any English voice
    return voices.find(v => v.lang.startsWith('en')) || voices[0];
}

// Voices load async — retry until we get them
let voicesReady = false;
function loadVoices() {
    preferredVoice = pickBestVoice();
    if (preferredVoice) {
        voicesReady = true;
        console.log('[Root Access] Voice selected:', preferredVoice.name, '(' + preferredVoice.lang + ')');
    }
}
if ('speechSynthesis' in window) {
    loadVoices();
    window.speechSynthesis.onvoiceschanged = loadVoices;
    // Some browsers need a nudge
    setTimeout(loadVoices, 100);
    setTimeout(loadVoices, 500);
}

function createUtterance(text, rate) {
    if (!preferredVoice) loadVoices();
    const utt = new SpeechSynthesisUtterance(text);
    if (preferredVoice) utt.voice = preferredVoice;
    utt.rate = rate || 0.95;
    utt.pitch = 1.0;
    return utt;
}

// ==========================================
// READ ALOUD
// ==========================================
let isReading = false;
function toggleReadAloud() {
    const btn = document.getElementById('readAloudBtn');
    if (isReading) {
        window.speechSynthesis.cancel();
        isReading = false;
        btn.classList.remove('playing');
        btn.innerHTML = '&#x1F50A; Read Aloud';
        document.querySelectorAll('.passage-body p.reading-highlight').forEach(p => p.classList.remove('reading-highlight'));
        return;
    }
    const paragraphs = document.querySelectorAll('#passageBody > p');
    isReading = true;
    btn.classList.add('playing');
    btn.innerHTML = '&#x23F9; Stop';
    let idx = 0;
    function readNext() {
        if (idx >= paragraphs.length || !isReading) {
            isReading = false;
            btn.classList.remove('playing');
            btn.innerHTML = '&#x1F50A; Read Aloud';
            paragraphs.forEach(p => p.classList.remove('reading-highlight'));
            return;
        }
        paragraphs.forEach(p => p.classList.remove('reading-highlight'));
        paragraphs[idx].classList.add('reading-highlight');
        const utt = createUtterance(paragraphs[idx].textContent, 0.92);
        utt.onend = () => { idx++; readNext(); };
        window.speechSynthesis.speak(utt);
    }
    readNext();
}

// ==========================================
// TEXT HIGHLIGHTING TOOL
// ==========================================
let activeHLColor = null;
let eraserMode = false;

function setHighlightColor(color) {
    eraserMode = false;
    document.getElementById('hlEraser').classList.remove('active');
    const passage = document.getElementById('passageBody');
    passage.classList.remove('eraser-mode');

    if (activeHLColor === color) {
        // Deselect
        activeHLColor = null;
        document.querySelectorAll('.hl-btn').forEach(b => b.classList.remove('active'));
        passage.classList.remove('hl-active');
        passage.style.removeProperty('--hl-sel-color');
        return;
    }
    activeHLColor = color;
    document.querySelectorAll('.hl-btn').forEach(b => b.classList.remove('active'));
    document.querySelector(`.hl-btn[data-hl-color="${color}"]`).classList.add('active');
    passage.classList.add('hl-active');

    const colors = { yellow: '#FDE68A', green: '#A7F3D0', pink: '#FBCFE8' };
    passage.style.setProperty('--hl-sel-color', colors[color]);
}

function toggleEraser() {
    activeHLColor = null;
    document.querySelectorAll('.hl-btn').forEach(b => b.classList.remove('active'));
    const passage = document.getElementById('passageBody');
    passage.classList.remove('hl-active');
    passage.style.removeProperty('--hl-sel-color');

    eraserMode = !eraserMode;
    document.getElementById('hlEraser').classList.toggle('active', eraserMode);
    passage.classList.toggle('eraser-mode', eraserMode);
}

function applyHighlight() {
    if (!activeHLColor) return;
    const sel = window.getSelection();
    if (!sel.rangeCount || sel.isCollapsed) return;
    const range = sel.getRangeAt(0);

    const passage = document.getElementById('passageBody');
    if (!passage.contains(range.commonAncestorContainer)) return;

    // Don't highlight inside vocab tooltips
    const ancestor = range.commonAncestorContainer.nodeType === 3
        ? range.commonAncestorContainer.parentNode : range.commonAncestorContainer;
    if (ancestor.closest && ancestor.closest('.vocab-tooltip')) return;
    // Also skip if start or end is inside a tooltip
    const startNode = range.startContainer.nodeType === 3 ? range.startContainer.parentNode : range.startContainer;
    const endNode = range.endContainer.nodeType === 3 ? range.endContainer.parentNode : range.endContainer;
    if ((startNode.closest && startNode.closest('.vocab-tooltip')) ||
        (endNode.closest && endNode.closest('.vocab-tooltip'))) return;

    try {
        // Check if selection spans multiple elements
        const fragment = range.extractContents();
        const mark = document.createElement('mark');
        mark.className = 'hl-' + activeHLColor;
        mark.appendChild(fragment);
        range.insertNode(mark);
        // Merge adjacent same-color marks
        mergeAdjacentMarks(passage);
    } catch(e) {
        // Fallback: wrap what we can
        try {
            const mark = document.createElement('mark');
            mark.className = 'hl-' + activeHLColor;
            range.surroundContents(mark);
        } catch(e2) { /* selection too complex, skip */ }
    }
    sel.removeAllRanges();
    updateHLCount();
    saveHighlights();
}

function mergeAdjacentMarks(container) {
    const marks = container.querySelectorAll('mark');
    marks.forEach(m => {
        const next = m.nextSibling;
        if (next && next.nodeName === 'MARK' && next.className === m.className) {
            while (next.firstChild) m.appendChild(next.firstChild);
            next.remove();
        }
    });
}

function removeHighlight(mark) {
    const parent = mark.parentNode;
    while (mark.firstChild) parent.insertBefore(mark.firstChild, mark);
    parent.removeChild(mark);
    parent.normalize(); // merge adjacent text nodes
    updateHLCount();
    saveHighlights();
}

function updateHLCount() {
    const passage = document.getElementById('passageBody');
    const yellow = passage.querySelectorAll('mark.hl-yellow').length;
    const green = passage.querySelectorAll('mark.hl-green').length;
    const pink = passage.querySelectorAll('mark.hl-pink').length;
    const total = yellow + green + pink;
    const el = document.getElementById('hlCount');
    if (total === 0) {
        el.textContent = '';
    } else {
        el.innerHTML = '<strong>' + total + '</strong> highlight' + (total !== 1 ? 's' : '');
    }
}

async function saveHighlights() {
    const passage = document.getElementById('passageBody');
    const key = STORAGE_KEY + '-highlights';
    await localforage.setItem(key, passage.innerHTML);
}

async function loadHighlights() {
    const key = STORAGE_KEY + '-highlights';
    const saved = await localforage.getItem(key);
    if (saved) {
        document.getElementById('passageBody').innerHTML = saved;
        updateHLCount();
    }
}

// Listen for mouseup on passage to apply highlight
document.getElementById('passageBody').addEventListener('mouseup', function(e) {
    // Eraser mode: clicking a mark removes it
    if (eraserMode && e.target.closest('mark[class^="hl-"]')) {
        removeHighlight(e.target.closest('mark[class^="hl-"]'));
        return;
    }
    // Short delay so selection is finalized
    setTimeout(applyHighlight, 10);
});

// Touch support for mobile highlighting
document.getElementById('passageBody').addEventListener('touchend', function(e) {
    if (eraserMode && e.target.closest('mark[class^="hl-"]')) {
        removeHighlight(e.target.closest('mark[class^="hl-"]'));
        return;
    }
    setTimeout(applyHighlight, 50);
});

// Load highlights on page load (called from loadAll)

// ==========================================
// VIEW PASSAGE POPUP / DRAWER
// ==========================================
let passagePopup = null;
let popupPollInterval = null;

function openPassagePopup() {
    // Mobile: use drawer instead
    if (window.innerWidth < 768) {
        openPassageDrawer();
        return;
    }
    // If popup already open, just focus it
    if (passagePopup && !passagePopup.closed) {
        passagePopup.focus();
        return;
    }
    const w = Math.round(screen.availWidth / 4);
    const h = screen.availHeight;
    const l = screen.availWidth - w;
    const features = 'width=' + w + ',height=' + h + ',left=' + l + ',top=0,scrollbars=yes,resizable=yes';
    passagePopup = window.open('', 'rootaccess-passage', features);
    if (!passagePopup || passagePopup.closed) {
        alert('Your browser blocked the popup. Please allow popups for this page, then try again.');
        return;
    }
    writePopupContent(passagePopup);
    document.getElementById('viewPassageBtn').classList.add('popup-open');
    // Poll for popup close
    popupPollInterval = setInterval(function() {
        if (!passagePopup || passagePopup.closed) {
            clearInterval(popupPollInterval);
            popupPollInterval = null;
            passagePopup = null;
            document.getElementById('viewPassageBtn').classList.remove('popup-open');
        }
    }, 500);
}

function writePopupContent(popup) {
    var passageHTML = document.getElementById('passageBody').innerHTML;
    // Pull title + meta from the existing page so future days auto-adapt
    var passageTitle = (document.querySelector('.passage-title') || {}).textContent || 'Reading Passage';
    var passageMeta = (document.querySelector('.passage-meta') || {}).innerHTML || '';
    var html = '<!DOCTYPE html><html><head>' +
        '<meta charset="UTF-8">' +
        '<meta name="viewport" content="width=device-width, initial-scale=1.0">' +
        '<title>' + passageTitle + ' — Root Access</title>' +
        '<link rel="preconnect" href="https://fonts.googleapis.com">' +
        '<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>' +
        '<link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@700;800&family=Fredoka:wght@400;500;600&family=Lora:ital,wght@0,400;0,500;0,600;1,400&family=Quicksand:wght@400;500;600&display=swap" rel="stylesheet">' +
        '<style>' +
        '* { box-sizing: border-box; margin: 0; padding: 0; }' +
        ':root { --ela-primary: #7C3AED; --ela-dark: #5B21B6; --ela-light: #F5F3FF; --ela-medium: #DDD6FE; --challenge-primary: #F59E0B; }' +
        'body { font-family: "Quicksand", sans-serif; background: #FAFAFA; }' +
        '.popup-header { position: sticky; top: 0; z-index: 10; background: linear-gradient(135deg, var(--ela-light) 0%, #EDE9FE 100%); padding: 10px 16px; border-bottom: 2.5px solid var(--ela-primary); display: flex; justify-content: space-between; align-items: center; }' +
        '.popup-header .title { font-family: "Baloo 2", cursive; font-size: 16px; font-weight: 700; color: var(--ela-dark); }' +
        '.popup-header .meta { font-family: "Fredoka", sans-serif; font-size: 10px; color: var(--ela-dark); background: var(--ela-medium); padding: 2px 8px; border-radius: 6px; }' +
        '.popup-toolbar { position: sticky; top: 47px; z-index: 9; display: flex; align-items: center; gap: 6px; padding: 6px 16px; background: #F8FAFC; border-bottom: 2px solid var(--ela-primary); flex-wrap: wrap; }' +
        '.popup-toolbar .label { font-family: "Fredoka", sans-serif; font-size: 11px; font-weight: 600; color: var(--ela-dark); margin-right: 2px; }' +
        '.hl-btn { width: 24px; height: 24px; border-radius: 50%; border: 3px solid transparent; cursor: pointer; transition: all 0.2s; }' +
        '.hl-btn:hover { transform: scale(1.15); }' +
        '.hl-btn.active { border-color: #1e293b; box-shadow: 0 0 0 2px white, 0 0 0 4px #1e293b; transform: scale(1.15); }' +
        '.hl-btn-yellow { background: #FDE68A; }' +
        '.hl-btn-green { background: #A7F3D0; }' +
        '.hl-btn-pink { background: #FBCFE8; }' +
        '.hl-btn-eraser { width: 24px; height: 24px; border-radius: 50%; border: 2px solid #cbd5e1; background: white; cursor: pointer; font-size: 12px; display: flex; align-items: center; justify-content: center; margin-left: 2px; }' +
        '.hl-btn-eraser:hover { border-color: #ef4444; background: #fef2f2; }' +
        '.hl-btn-eraser.active { border-color: #ef4444; background: #fef2f2; box-shadow: 0 0 0 2px white, 0 0 0 4px #ef4444; }' +
        '.hl-count { font-family: "Fredoka", sans-serif; font-size: 10px; color: #64748b; margin-left: auto; }' +
        '.hl-count strong { color: var(--ela-dark); }' +
        '.read-aloud-btn { font-family: "Fredoka", sans-serif; font-size: 11px; font-weight: 600; border: 2px solid var(--ela-primary); border-radius: 6px; padding: 2px 8px; background: white; color: var(--ela-dark); cursor: pointer; white-space: nowrap; margin-left: auto; }' +
        '.read-aloud-btn:hover { background: var(--ela-primary); color: white; }' +
        '.read-aloud-btn.playing { background: var(--ela-primary); color: white; }' +
        'mark.hl-yellow { background: #FDE68A; border-radius: 3px; padding: 0 1px; cursor: pointer; }' +
        'mark.hl-green { background: #A7F3D0; border-radius: 3px; padding: 0 1px; cursor: pointer; }' +
        'mark.hl-pink { background: #FBCFE8; border-radius: 3px; padding: 0 1px; cursor: pointer; }' +
        '.passage-body { padding: 16px; font-family: "Lora", Georgia, serif; font-size: 15px; line-height: 1.85; color: #2d2d2d; }' +
        '.passage-body p { margin-bottom: 14px; text-indent: 24px; }' +
        '.passage-body p:first-child { text-indent: 0; }' +
        '.passage-body p.reading-highlight { background: #FEF3C7; border-radius: 4px; margin: -2px -4px; padding: 2px 4px; }' +
        '.passage-body.eraser-mode mark { cursor: crosshair; opacity: 0.7; }' +
        '.passage-body.eraser-mode mark:hover { opacity: 0.4; text-decoration: line-through; }' +
        '.passage-body.hl-active { cursor: text; }' +
        '.passage-body.hl-active::selection, .passage-body.hl-active *::selection { background: var(--hl-sel-color, #FDE68A); }' +
        '.vocab-highlight { background: #FEF3C7; padding: 1px 6px; border-radius: 4px; font-weight: 500; cursor: pointer; position: relative; border-bottom: 2px dashed var(--challenge-primary); }' +
        '.vocab-highlight:hover, .vocab-highlight.tapped { background: #FDE68A; }' +
        '.vocab-tooltip { display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; font-family: "Quicksand", sans-serif; font-size: 12px; padding: 6px 12px; border-radius: 8px; max-width: 260px; white-space: normal; z-index: 50; box-shadow: 0 4px 12px rgba(0,0,0,0.2); margin-bottom: 6px; line-height: 1.4; pointer-events: none; }' +
        '.vocab-highlight:hover .vocab-tooltip, .vocab-highlight.tapped .vocab-tooltip { display: block; }' +
        '.vocab-tooltip::after { content: ""; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); border: 6px solid transparent; border-top-color: #1e293b; }' +
        '</style>' +
        '</head><body>' +
        '<div class="popup-header">' +
        '  <span class="title">' + passageTitle + '</span>' +
        '  <span class="meta">' + passageMeta + '</span>' +
        '</div>' +
        '<div class="popup-toolbar">' +
        '  <span class="label">Highlighter:</span>' +
        '  <button class="hl-btn hl-btn-yellow" data-hl-color="yellow" onclick="setColor(\'yellow\')" title="Main ideas"></button>' +
        '  <button class="hl-btn hl-btn-green" data-hl-color="green" onclick="setColor(\'green\')" title="Details"></button>' +
        '  <button class="hl-btn hl-btn-pink" data-hl-color="pink" onclick="setColor(\'pink\')" title="Questions"></button>' +
        '  <button class="hl-btn-eraser" id="popupEraser" onclick="toggleEraser()" title="Erase">&#x2715;</button>' +
        '  <span class="hl-count" id="popupHlCount"></span>' +
        '  <button class="read-aloud-btn" id="popupReadBtn" onclick="toggleRead()">&#x1F50A; Read Aloud</button>' +
        '</div>' +
        '<div class="passage-body" id="popupPassage">' + passageHTML + '</div>' +
        '<script>' +
        'var STORAGE_KEY = "' + STORAGE_KEY + '-highlights";' +
        'var activeColor = null, eraserOn = false, reading = false;' +
        // setColor
        'function setColor(c) {' +
        '  eraserOn = false; document.getElementById("popupEraser").classList.remove("active");' +
        '  var p = document.getElementById("popupPassage"); p.classList.remove("eraser-mode");' +
        '  if (activeColor === c) { activeColor = null; document.querySelectorAll(".hl-btn").forEach(function(b){b.classList.remove("active")}); p.classList.remove("hl-active"); p.style.removeProperty("--hl-sel-color"); return; }' +
        '  activeColor = c; document.querySelectorAll(".hl-btn").forEach(function(b){b.classList.remove("active")});' +
        '  document.querySelector(".hl-btn[data-hl-color=\\""+c+"\\"]").classList.add("active");' +
        '  p.classList.add("hl-active");' +
        '  var colors = {yellow:"#FDE68A", green:"#A7F3D0", pink:"#FBCFE8"};' +
        '  p.style.setProperty("--hl-sel-color", colors[c]);' +
        '}' +
        // toggleEraser
        'function toggleEraser() {' +
        '  activeColor = null; document.querySelectorAll(".hl-btn").forEach(function(b){b.classList.remove("active")});' +
        '  var p = document.getElementById("popupPassage"); p.classList.remove("hl-active"); p.style.removeProperty("--hl-sel-color");' +
        '  eraserOn = !eraserOn; document.getElementById("popupEraser").classList.toggle("active", eraserOn); p.classList.toggle("eraser-mode", eraserOn);' +
        '}' +
        // applyHL
        'function applyHL() {' +
        '  if (!activeColor) return; var sel = window.getSelection(); if (!sel.rangeCount || sel.isCollapsed) return;' +
        '  var range = sel.getRangeAt(0); var p = document.getElementById("popupPassage"); if (!p.contains(range.commonAncestorContainer)) return;' +
        '  var anc = range.commonAncestorContainer.nodeType===3 ? range.commonAncestorContainer.parentNode : range.commonAncestorContainer;' +
        '  if (anc.closest && anc.closest(".vocab-tooltip")) return;' +
        '  var sn = range.startContainer.nodeType===3 ? range.startContainer.parentNode : range.startContainer;' +
        '  var en = range.endContainer.nodeType===3 ? range.endContainer.parentNode : range.endContainer;' +
        '  if ((sn.closest && sn.closest(".vocab-tooltip")) || (en.closest && en.closest(".vocab-tooltip"))) return;' +
        '  try { var f = range.extractContents(); var m = document.createElement("mark"); m.className = "hl-" + activeColor; m.appendChild(f); range.insertNode(m); mergeMark(p); } catch(e) { try { var m2 = document.createElement("mark"); m2.className = "hl-" + activeColor; range.surroundContents(m2); } catch(e2){} }' +
        '  sel.removeAllRanges(); countHL(); saveToStorage();' +
        '}' +
        // removeHL
        'function removeHL(mark) {' +
        '  var par = mark.parentNode; while(mark.firstChild) par.insertBefore(mark.firstChild, mark); par.removeChild(mark); par.normalize(); countHL(); saveToStorage();' +
        '}' +
        // mergeMark
        'function mergeMark(c) {' +
        '  c.querySelectorAll("mark").forEach(function(m) { var n = m.nextSibling; if (n && n.nodeName==="MARK" && n.className===m.className) { while(n.firstChild) m.appendChild(n.firstChild); n.remove(); } });' +
        '}' +
        // countHL
        'function countHL() {' +
        '  var p = document.getElementById("popupPassage");' +
        '  var t = p.querySelectorAll("mark.hl-yellow").length + p.querySelectorAll("mark.hl-green").length + p.querySelectorAll("mark.hl-pink").length;' +
        '  var el = document.getElementById("popupHlCount");' +
        '  el.innerHTML = t === 0 ? "" : "<strong>" + t + "</strong> highlight" + (t!==1?"s":"");' +
        '}' +
        // saveToStorage — write via opener's localforage for IndexedDB persistence
        'function saveToStorage() {' +
        '  var html = document.getElementById("popupPassage").innerHTML;' +
        '  try { if (window.opener && !window.opener.closed && window.opener.localforage) { window.opener.localforage.setItem(STORAGE_KEY, html).then(function() { window.opener._onPopupHighlightChange(); }); } } catch(e) {}' +
        '}' +
        // loadFromStorage — read via opener's localforage
        'function loadFromStorage() {' +
        '  try { if (window.opener && window.opener.localforage) { window.opener.localforage.getItem(STORAGE_KEY).then(function(saved) { if (saved) { document.getElementById("popupPassage").innerHTML = saved; countHL(); } }); } } catch(e) {}' +
        '}' +
        // Read aloud
        'function toggleRead() {' +
        '  var btn = document.getElementById("popupReadBtn");' +
        '  if (reading) { window.speechSynthesis.cancel(); reading = false; btn.classList.remove("playing"); btn.innerHTML = "&#x1F50A; Read Aloud"; document.querySelectorAll(".passage-body p.reading-highlight").forEach(function(p){p.classList.remove("reading-highlight")}); return; }' +
        '  var paras = document.querySelectorAll("#popupPassage > p"); reading = true; btn.classList.add("playing"); btn.innerHTML = "&#x23F9; Stop";' +
        '  var idx = 0;' +
        '  function readNext() {' +
        '    if (idx >= paras.length || !reading) { reading = false; btn.classList.remove("playing"); btn.innerHTML = "&#x1F50A; Read Aloud"; paras.forEach(function(p){p.classList.remove("reading-highlight")}); return; }' +
        '    paras.forEach(function(p){p.classList.remove("reading-highlight")}); paras[idx].classList.add("reading-highlight");' +
        '    var utt = new SpeechSynthesisUtterance(paras[idx].textContent); utt.rate = 0.92; utt.pitch = 1.0;' +
        '    utt.onend = function() { idx++; readNext(); }; window.speechSynthesis.speak(utt);' +
        '  }' +
        '  readNext();' +
        '}' +
        // Mouse/touch events
        'document.getElementById("popupPassage").addEventListener("mouseup", function(e) {' +
        '  if (eraserOn && e.target.closest("mark[class^=\\"hl-\\"]")) { removeHL(e.target.closest("mark[class^=\\"hl-\\"]")); return; }' +
        '  setTimeout(applyHL, 10);' +
        '});' +
        'document.getElementById("popupPassage").addEventListener("touchend", function(e) {' +
        '  if (eraserOn && e.target.closest("mark[class^=\\"hl-\\"]")) { removeHL(e.target.closest("mark[class^=\\"hl-\\"]")); return; }' +
        '  setTimeout(applyHL, 50);' +
        '});' +
        // Vocab tooltip tap support
        'document.addEventListener("click", function(e) {' +
        '  var vh = e.target.closest(".vocab-highlight");' +
        '  if (vh) { document.querySelectorAll(".vocab-highlight.tapped").forEach(function(el) { if (el !== vh) el.classList.remove("tapped"); }); vh.classList.toggle("tapped"); }' +
        '  else { document.querySelectorAll(".vocab-highlight.tapped").forEach(function(el) { el.classList.remove("tapped"); }); }' +
        '});' +
        // Init count
        'countHL();' +
        '<\/script>' +
        '</body></html>';
    popup.document.open();
    popup.document.write(html);
    popup.document.close();
    // Expose loadFromStorage for direct calls from main page
    popup.loadFromStorage = async function() {
        if (popup.document && popup.document.getElementById('popupPassage')) {
            var saved = await localforage.getItem(STORAGE_KEY + '-highlights');
            if (saved) {
                popup.document.getElementById('popupPassage').innerHTML = saved;
                if (typeof popup.countHL === 'function') popup.countHL();
            }
        }
    };
}

// Called by popup after it saves highlights
window._onPopupHighlightChange = function() {
    loadHighlights();
};

// Sync main page highlights to popup
var _origSaveHighlights = saveHighlights;
saveHighlights = async function() {
    await _origSaveHighlights();
    try {
        if (passagePopup && !passagePopup.closed && typeof passagePopup.loadFromStorage === 'function') {
            passagePopup.loadFromStorage();
        }
    } catch(e) {}
};

// === MOBILE DRAWER ===
function openPassageDrawer() {
    var drawer = document.getElementById('drawerPassageBody');
    drawer.innerHTML = document.getElementById('passageBody').innerHTML;
    // Set title from the page's passage header
    var titleEl = document.getElementById('drawerPassageTitle');
    var srcTitle = document.querySelector('.passage-title');
    if (titleEl && srcTitle) titleEl.textContent = srcTitle.textContent;
    var overlay = document.getElementById('passageDrawerOverlay');
    overlay.classList.add('open');
    document.body.style.overflow = 'hidden';
}

function closePassageDrawer() {
    document.getElementById('passageDrawerOverlay').classList.remove('open');
    document.body.style.overflow = '';
}

// Close drawer when clicking backdrop (not inside drawer)
document.getElementById('passageDrawerOverlay').addEventListener('click', function(e) {
    if (e.target === this) closePassageDrawer();
});

// ==========================================
// READING LOG — BOOK HISTORY + LAST PAGE
// ==========================================
// Book history is per-profile so siblings have separate reading logs
function getBookHistoryKey() {
    return activeProfileId ? 'rootaccess-' + activeProfileId + '-book-history' : 'rootaccess-book-history';
}

async function getBookHistory() {
    try {
        return (await localforage.getItem(getBookHistoryKey())) || [];
    } catch(e) { return []; }
}

async function populateBookDatalist() {
    var dl = document.getElementById('bookTitleHistory');
    if (!dl) return;
    dl.innerHTML = '';
    var history = await getBookHistory();
    history.forEach(function(entry) {
        var opt = document.createElement('option');
        opt.value = entry.title;
        opt.label = entry.lastPage ? 'Last page: ' + entry.lastPage : '';
        dl.appendChild(opt);
    });
}

async function saveBookToHistory(title, pages) {
    if (!title || !title.trim()) return;
    title = title.trim();
    var history = await getBookHistory();
    // Find existing entry or create new
    var idx = history.findIndex(function(e) { return e.title.toLowerCase() === title.toLowerCase(); });
    if (idx >= 0) {
        history[idx].lastPage = pages || history[idx].lastPage;
        history[idx].lastUsed = Date.now();
        // Move to front
        var entry = history.splice(idx, 1)[0];
        history.unshift(entry);
    } else {
        history.unshift({ title: title, lastPage: pages || '', lastUsed: Date.now() });
    }
    // Keep max 20 books
    if (history.length > 20) history = history.slice(0, 20);
    await localforage.setItem(getBookHistoryKey(), history);
    await populateBookDatalist();
}

// When book title changes, auto-fill last page if empty
document.getElementById('bookTitleInput').addEventListener('change', async function() {
    var title = this.value.trim();
    if (!title) return;
    var history = await getBookHistory();
    var match = history.find(function(e) { return e.title.toLowerCase() === title.toLowerCase(); });
    var pagesInput = document.getElementById('bookPagesInput');
    if (match && match.lastPage && !pagesInput.value.trim()) {
        // Parse last page to suggest starting page
        var lastPage = match.lastPage;
        var parts = lastPage.match(/(\d+)\s*[-–]\s*(\d+)/);
        if (parts) {
            // e.g. "12-25" → suggest starting at 26
            pagesInput.value = (parseInt(parts[2]) + 1) + '-';
            pagesInput.placeholder = 'Start from page ' + (parseInt(parts[2]) + 1);
        } else {
            var num = parseInt(lastPage);
            if (!isNaN(num)) {
                pagesInput.value = (num + 1) + '-';
                pagesInput.placeholder = 'Start from page ' + (num + 1);
            }
        }
        pagesInput.focus();
    }
    saveAll();
});

// Save book on pages blur
document.getElementById('bookPagesInput').addEventListener('blur', function() {
    var title = document.getElementById('bookTitleInput').value;
    var pages = this.value;
    if (title) saveBookToHistory(title, pages);
});

// Initialize datalist on load
populateBookDatalist();

// ==========================================
// AUTO-SAVE + WORD COUNT
// ==========================================
document.addEventListener('input', function(e) {
    if (e.target.matches('input[data-section], textarea[data-section]')) {
        if (e.target.tagName === 'TEXTAREA') {
            e.target.classList.toggle('has-content', !!e.target.value.trim());
            if (e.target.dataset.trackWords) updateWordCount(e.target);
        }
        // Spelling auto-check
        if (e.target.dataset.spell) checkSpellingInput(e.target);
        clearTimeout(window._saveTimeout);
        window._saveTimeout = setTimeout(() => { saveAll(); updateProgress(); }, 500);
    }
});

function updateWordCounts() {
    document.querySelectorAll('textarea[data-track-words]').forEach(updateWordCount);
}
function updateWordCount(textarea) {
    const wc = textarea.nextElementSibling;
    if (!wc || !wc.classList.contains('word-count')) return;
    const words = textarea.value.trim().split(/\s+/).filter(w => w.length > 0).length;
    wc.textContent = words + ' word' + (words !== 1 ? 's' : '');
    wc.classList.toggle('good', words >= 5);
}

// ==========================================
// SPELLING AUTO-CHECK
// ==========================================
function checkSpellingInput(input) {
    const correct = input.dataset.spell;
    if (!correct || !input.value.trim()) {
        input.classList.remove('correct', 'incorrect', 'retype-mode');
        return;
    }
    // In retype mode — check if they typed the correct word
    if (input.dataset.retypeMode === 'true') {
        if (input.value.trim().toLowerCase() === correct.toLowerCase()) {
            input.classList.remove('incorrect', 'retype-mode');
            input.classList.add('correct');
            input.dataset.retypeMode = 'false';
            const hint = input.closest('.spelling-practice-item').querySelector('.retype-hint');
            if (hint) hint.remove();
            saveAll(); updateProgress();
        }
        return;
    }
    if (input.value.trim().toLowerCase() === correct.toLowerCase()) {
        input.classList.remove('incorrect');
        input.classList.add('correct');
    } else {
        input.classList.remove('correct');
        input.classList.add('incorrect');
    }
}

// Track spelling attempts on blur — enter retype mode after 2 wrong
document.addEventListener('blur', function(e) {
    if (!e.target.dataset.spell || !e.target.value.trim()) return;
    if (e.target.classList.contains('correct') || e.target.dataset.retypeMode === 'true') return;
    // Only count as a new attempt if the student actually changed their answer
    const lastChecked = e.target.dataset.lastChecked || '';
    const currentVal = e.target.value.trim();
    if (currentVal === lastChecked) return;
    e.target.dataset.lastChecked = currentVal;
    const attempts = parseInt(e.target.dataset.attempts || 0) + 1;
    e.target.dataset.attempts = attempts;
    if (attempts >= 2) {
        enterRetypeMode(e.target, e.target.dataset.spell, 'Spell this word');
    }
}, true);

// ==========================================
// PLACE VALUE AUTO-ADVANCE
// ==========================================
document.addEventListener('input', function(e) {
    if (e.target.matches('.pv-input') && e.target.value.length >= 1) {
        const row = e.target.closest('tr');
        const cells = Array.from(row.querySelectorAll('.pv-input'));
        const idx = cells.indexOf(e.target);
        if (idx < cells.length - 1) cells[idx + 1].focus();
    }
});

// ==========================================
// PAGE-BASED NAVIGATION
// ==========================================
const PAGE_ORDER = ['warmup', 'reading', 'math', 'grammar', 'social', 'readinglog'];
let currentPage = 'warmup';

function showPage(target) {
    if (!PAGE_ORDER.includes(target)) return;
    currentPage = target;

    // Cancel any ongoing speech synthesis
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        isReading = false;
        const readBtn = document.getElementById('readAloudBtn');
        if (readBtn) { readBtn.classList.remove('playing'); readBtn.innerHTML = '&#x1F50A; Read Aloud'; }
        document.querySelectorAll('.passage-body p.reading-highlight').forEach(p => p.classList.remove('reading-highlight'));
    }

    // Hide all sections, show target
    PAGE_ORDER.forEach(sec => {
        const el = document.getElementById('section-' + sec);
        if (el) el.classList.toggle('active-page', sec === target);
    });

    // Day header: visible only on warmup page
    const dayHeader = document.querySelector('.day-header');
    if (dayHeader) dayHeader.style.display = (target === 'warmup') ? '' : 'none';

    // Update nav buttons
    document.querySelectorAll('.section-nav button').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.section === target && !btn.classList.contains('completed'));
    });

    // Update page indicator
    const idx = PAGE_ORDER.indexOf(target);
    document.getElementById('pageIndicator').textContent = (idx + 1) + ' of ' + PAGE_ORDER.length;

    // Update prev/next buttons
    document.getElementById('prevPageBtn').disabled = (idx === 0);
    document.getElementById('nextPageBtn').disabled = (idx === PAGE_ORDER.length - 1);

    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'instant' });

    // Save
    clearTimeout(window._saveTimeout);
    window._saveTimeout = setTimeout(saveAll, 300);
}

function nextPage() {
    const idx = PAGE_ORDER.indexOf(currentPage);
    if (idx < PAGE_ORDER.length - 1) showPage(PAGE_ORDER[idx + 1]);
}

function prevPage() {
    const idx = PAGE_ORDER.indexOf(currentPage);
    if (idx > 0) showPage(PAGE_ORDER[idx - 1]);
}

// ==========================================
// VOCAB TOOLTIP TAP-TO-TOGGLE
// ==========================================
document.addEventListener('click', function(e) {
    const vh = e.target.closest('.vocab-highlight');
    // Close all others first
    document.querySelectorAll('.vocab-highlight.tapped').forEach(el => { if (el !== vh) el.classList.remove('tapped'); });
    if (vh) vh.classList.toggle('tapped');
});

// ==========================================
// RETYPE MODE (reveal then retype)
// ==========================================
function enterRetypeMode(input, correctAnswer, label) {
    input.value = '';
    input.classList.remove('correct', 'incorrect');
    input.classList.add('retype-mode');
    input.dataset.retypeMode = 'true';
    input.dataset.helped = 'true';
    input.placeholder = 'Type it here...';

    // Remove any old feedback
    const oldFb = input.parentNode.querySelector('.feedback');
    if (oldFb) oldFb.style.display = 'none';

    // Add retype hint
    let hint = input.parentNode.querySelector('.retype-hint');
    if (!hint) {
        hint = document.createElement('div');
        hint.className = 'retype-hint';
        input.parentNode.insertBefore(hint, input.nextSibling);
    }
    hint.innerHTML = '\uD83D\uDC41\uFE0F ' + (label || 'Type this answer') + ': <strong>' + correctAnswer + '</strong>';
    input.focus();
}

// Auto-verify retype inputs on every keystroke
document.addEventListener('input', function(e) {
    if (e.target.dataset.retypeMode !== 'true') return;
    const correct = e.target.dataset.answer || e.target.dataset.spell;
    if (!correct) return;
    const normalize = s => s.toString().toLowerCase().replace(/[,\s]/g, '').trim();
    if (normalize(e.target.value) === normalize(correct)) {
        e.target.classList.remove('retype-mode', 'incorrect');
        e.target.classList.add('correct');
        e.target.dataset.retypeMode = 'false';
        e.target.placeholder = '';
        const hint = e.target.parentNode.querySelector('.retype-hint') || (e.target.closest('.spelling-practice-item') && e.target.closest('.spelling-practice-item').querySelector('.retype-hint'));
        if (hint) hint.remove();
        saveAll(); updateProgress();
    }
});

// ==========================================
// ANSWER CHECKING
// ==========================================
function normalizeAnswer(str) {
    return str.toString().toLowerCase().replace(/[,\s]/g, '').trim();
}

function checkAnswer(input) {
    const correct = input.dataset.answer;
    if (!correct) return null;
    const userVal = normalizeAnswer(input.value);
    const correctVal = normalizeAnswer(correct);
    if (input.dataset.altAnswers) {
        const alts = input.dataset.altAnswers.split('|').map(a => normalizeAnswer(a));
        if (alts.includes(userVal)) return true;
    }
    return userVal === correctVal;
}

function showFeedback(el, isCorrect, message) {
    el.className = 'feedback';
    el.classList.add(isCorrect ? 'correct' : 'incorrect');
    el.textContent = message || (isCorrect ? 'Correct!' : 'Not quite — try again!');
}

// Generic section checker (replaces hardcoded slice approach)
function checkSection(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    const inputs = container.querySelectorAll('input[data-answer]');
    let correct = 0, total = 0;
    inputs.forEach(input => {
        // Skip inputs already completed via retype
        if (input.dataset.retypeMode === 'true') { total++; return; }
        if (input.dataset.retypeMode === 'false' && input.classList.contains('correct')) { correct++; total++; return; }

        const result = checkAnswer(input);
        input.className = input.className.replace(/ correct| incorrect| retype-mode/g, '');
        if (result === true) { input.classList.add('correct'); correct++; }
        else if (result === false) {
            // Only count as a new attempt if the student actually changed their answer
            const lastChecked = input.dataset.lastChecked || '';
            const currentVal = input.value.trim();
            if (currentVal !== lastChecked) {
                const attempts = parseInt(input.dataset.attempts || 0) + 1;
                input.dataset.attempts = attempts;
                if (attempts >= 2) {
                    enterRetypeMode(input, input.dataset.answer, 'Type this answer');
                } else {
                    input.classList.add('incorrect');
                    let fb = input.nextElementSibling;
                    if (!fb || !fb.classList.contains('feedback')) {
                        fb = document.createElement('div');
                        fb.className = 'feedback incorrect';
                        input.parentNode.insertBefore(fb, input.nextSibling);
                    }
                    fb.className = 'feedback incorrect';
                    fb.style.display = 'block';
                    fb.textContent = 'Not quite — try again!';
                }
            } else {
                // Same wrong answer, just re-show the incorrect state without burning an attempt
                input.classList.add('incorrect');
            }
            input.dataset.lastChecked = currentVal;
        }
        if (result !== null) total++;
    });
    const fb = document.getElementById(containerId + '-fb');
    if (fb && total > 0) showFeedback(fb, correct === total, correct + ' of ' + total + ' correct!');
    saveAll();
}

// Warm-up math check
function checkWarmupMath() {
    const section = document.getElementById('section-warmup');
    const inputs = section.querySelectorAll('.question > p > input[data-answer]');
    inputs.forEach((input, i) => {
        // Skip inputs already in or completed via retype
        if (input.dataset.retypeMode === 'true') return;
        if (input.dataset.retypeMode === 'false' && input.classList.contains('correct')) return;

        const result = checkAnswer(input);
        input.className = input.className.replace(/ correct| incorrect| retype-mode/g, '');
        const fb = document.getElementById('warmup-q' + (i+1) + '-fb');
        if (result === true) {
            input.classList.add('correct');
            if (fb) showFeedback(fb, true, 'Correct!');
        } else if (result === false) {
            // Only count as a new attempt if the student actually changed their answer
            const lastChecked = input.dataset.lastChecked || '';
            const currentVal = input.value.trim();
            if (currentVal !== lastChecked) {
                const attempts = parseInt(input.dataset.attempts || 0) + 1;
                input.dataset.attempts = attempts;
                if (attempts >= 2) {
                    if (fb) fb.style.display = 'none';
                    enterRetypeMode(input, input.dataset.answer, 'Type this answer');
                } else {
                    input.classList.add('incorrect');
                    if (fb) showFeedback(fb, false, 'Try again! Think carefully.');
                }
            } else {
                input.classList.add('incorrect');
            }
            input.dataset.lastChecked = currentVal;
        }
    });
    saveAll();
}

function checkFixSentence() {
    const input = document.getElementById('fix-sentence-input');
    const answer = input.value.trim();
    const results = document.getElementById('fix-sentence-results');

    if (!answer) {
        results.innerHTML = '<div class="fix-result-item missed"><span class="fix-icon">✏️</span><span>Write your corrected sentence first, then click Check!</span></div>';
        return;
    }

    const correctSentence = 'Michigan is bordered by four of the five Great Lakes and has two peninsulas.';
    let issues = [];
    let fixes = 0;
    const totalOriginalErrors = 5;

    // ---- CHECK 1: michigan → Michigan ----
    if (/Michigan/.test(answer)) {
        fixes++;
        issues.push({ status: 'fixed', msg: 'You capitalized "Michigan" correctly!', rule: 'Michigan is a proper noun (name of a state) — always capitalize.' });
    } else if (/michigan/i.test(answer)) {
        const match = answer.match(/michigan/i)[0];
        issues.push({ status: 'missed', msg: 'You wrote "<span class="fix-wrong">' + match + '</span>" — should be "<span class="fix-right">Michigan</span>" (capital M).', rule: 'Michigan is a proper noun (name of a state) — always capitalize.' });
    } else {
        issues.push({ status: 'missed', msg: 'The word "Michigan" is missing from your sentence.', rule: 'The original sentence is about Michigan — make sure to include it!' });
    }

    // ---- CHECK 2: borderd → bordered ----
    if (/bordered/i.test(answer)) {
        fixes++;
        issues.push({ status: 'fixed', msg: 'You spelled "bordered" correctly!', rule: 'border + ed = bordered (just add -ed).' });
    } else if (/borderd/i.test(answer)) {
        issues.push({ status: 'missed', msg: 'You still wrote "<span class="fix-wrong">borderd</span>" — it should be "<span class="fix-right">bordered</span>".', rule: 'border + ed = bordered. The -ed ending keeps the full base word.' });
    } else if (/border[a-z]*/i.test(answer)) {
        const match = answer.match(/border[a-z]*/i)[0];
        issues.push({ status: 'missed', msg: 'You wrote "<span class="fix-wrong">' + match + '</span>" — the correct spelling is "<span class="fix-right">bordered</span>".', rule: 'border + ed = bordered. The -ed ending keeps the full base word.' });
    } else {
        issues.push({ status: 'missed', msg: 'The word "bordered" is missing. The original said "borderd" — the fix is "<span class="fix-right">bordered</span>".', rule: 'border + ed = bordered.' });
    }

    // ---- CHECK 3: grate → Great ----
    if (/Great/.test(answer)) {
        fixes++;
        issues.push({ status: 'fixed', msg: 'You fixed "grate" to "Great" — nice!', rule: '"Grate" means a metal grid. "Great" means large or important. They\'re homophones (sound alike, different meaning).' });
    } else if (/grate/i.test(answer)) {
        const match = answer.match(/grate/i)[0];
        issues.push({ status: 'missed', msg: 'You still wrote "<span class="fix-wrong">' + match + '</span>" — should be "<span class="fix-right">Great</span>".', rule: '"Grate" means a metal grid or to shred cheese. "Great" means large or important. They sound the same but mean different things!' });
    } else if (/great/i.test(answer) && !/Great/.test(answer)) {
        issues.push({ status: 'missed', msg: 'You fixed "grate" to "great" but forgot the capital G — should be "<span class="fix-right">Great</span>".', rule: '"Great Lakes" is a proper noun — "Great" needs a capital G.' });
    } else {
        issues.push({ status: 'missed', msg: 'The word "Great" is missing. The original had "grate" — a homophone error.', rule: '"Grate" and "Great" sound the same but mean different things. The fix is "Great" (capital G).' });
    }

    // ---- CHECK 4: lakes → Lakes ----
    if (/Lakes/.test(answer)) {
        fixes++;
        issues.push({ status: 'fixed', msg: 'You capitalized "Lakes" correctly!', rule: '"Great Lakes" is a proper noun (a specific name) — both words get capital letters.' });
    } else if (/lakes/i.test(answer)) {
        issues.push({ status: 'missed', msg: 'You wrote "<span class="fix-wrong">lakes</span>" with a lowercase "l" — should be "<span class="fix-right">Lakes</span>" (capital L).', rule: '"Great Lakes" is a proper noun. In proper nouns with multiple words, capitalize each important word.' });
    } else {
        issues.push({ status: 'missed', msg: 'The word "Lakes" is missing from your sentence.', rule: '"Great Lakes" is a proper noun — both words need to be included and capitalized.' });
    }

    // ---- CHECK 5: to → two ----
    if (/\btwo\b/i.test(answer)) {
        fixes++;
        issues.push({ status: 'fixed', msg: 'You used the correct "two"!', rule: '"Two" = the number 2. "To" = direction/preposition. "Too" = also or excessive.' });
    } else if (/\b2\b/.test(answer)) {
        fixes++;
        issues.push({ status: 'fixed', msg: 'You understood "to" should be the number — nice catch! But in writing, spell out numbers under 10: "<span class="fix-right">two</span>" instead of "2".', rule: 'Writing rule: spell out numbers zero through nine. Use digits for 10 and above.' });
    } else if (/has\s+to\b/i.test(answer)) {
        issues.push({ status: 'missed', msg: 'You still wrote "has <span class="fix-wrong">to</span> peninsulas" — should be "has <span class="fix-right">two</span> peninsulas".', rule: '"Two" = the number 2. "To" = direction ("go to school"). "Too" = also. These are homophones!' });
    } else if (/\btoo\b/i.test(answer) && !/\btwo\b/i.test(answer)) {
        issues.push({ status: 'missed', msg: 'You wrote "<span class="fix-wrong">too</span>" — close! But "too" means "also." The number is "<span class="fix-right">two</span>".', rule: '"Two" = the number 2. "To" = direction. "Too" = also or excessive.' });
    } else {
        issues.push({ status: 'missed', msg: 'The word "two" (the number) seems to be missing.', rule: 'The original used "to" (a preposition) instead of "two" (the number 2).' });
    }

    // ---- BONUS CHECKS: things beyond the original 5 errors ----
    let bonusIssues = [];

    // Ending punctuation
    if (!answer.endsWith('.')) {
        if (answer.endsWith('!') || answer.endsWith('?')) {
            bonusIssues.push({ status: 'warn', msg: 'Your sentence ends with "' + answer.slice(-1) + '" — this is a statement, so it should end with a period.', rule: 'Statements end with a period. Questions end with "?" and exclamations with "!".' });
        } else {
            bonusIssues.push({ status: 'warn', msg: 'Your sentence is missing a period at the end.', rule: 'Every sentence needs ending punctuation. Statements end with a period (.).' });
        }
    }

    // Check for "peninsulas" spelling
    if (/peninsula/i.test(answer) && !/peninsulas/i.test(answer)) {
        bonusIssues.push({ status: 'warn', msg: 'You wrote "peninsula" — it should be "<span class="fix-right">peninsulas</span>" (plural, because Michigan has two!).', rule: 'Add -s to make most nouns plural.' });
    } else if (/pennins|penins[uo]la[^s]|penisula|peninsla|penninsula/i.test(answer)) {
        const match = answer.match(/pen[a-z]+/i)[0];
        bonusIssues.push({ status: 'warn', msg: 'Check the spelling: you wrote "<span class="fix-wrong">' + match + '</span>" — correct spelling is "<span class="fix-right">peninsulas</span>".', rule: 'A peninsula is land surrounded by water on three sides. pen·in·su·la.' });
    }

    // Capital letter at start
    if (!/^[A-Z]/.test(answer.trim())) {
        bonusIssues.push({ status: 'warn', msg: 'Your sentence doesn\'t start with a capital letter.', rule: 'Every sentence must begin with a capital letter.' });
    }

    // Check for digits instead of spelled-out numbers (excluding "2" which is handled above)
    const digitMap = { '4': 'four', '5': 'five' };
    Object.keys(digitMap).forEach(digit => {
        if (new RegExp('\\b' + digit + '\\b').test(answer)) {
            bonusIssues.push({ status: 'warn', msg: 'You used the digit "' + digit + '" — in writing, spell it out: "<span class="fix-right">' + digitMap[digit] + '</span>".', rule: 'Writing rule: spell out numbers zero through nine. Use digits for 10 and above (like 50 or 100).' });
        }
    });

    // Extra/missing words check
    const correctWords = correctSentence.replace(/[.!?]/g, '').toLowerCase().split(/\s+/);
    const studentWords = answer.replace(/[.!?]/g, '').toLowerCase().split(/\s+/);
    if (studentWords.length > correctWords.length + 2) {
        bonusIssues.push({ status: 'warn', msg: 'Your sentence has more words than expected (' + studentWords.length + ' vs. ' + correctWords.length + '). Make sure you didn\'t add extra words.', rule: 'When fixing a sentence, only fix the errors — don\'t add or remove words unless needed.' });
    } else if (studentWords.length < correctWords.length - 2) {
        bonusIssues.push({ status: 'warn', msg: 'Your sentence seems shorter than expected (' + studentWords.length + ' vs. ' + correctWords.length + ' words). Make sure you included the full sentence.', rule: 'Rewrite the entire sentence with corrections, not just the fixed words.' });
    }

    // ---- BUILD OUTPUT ----
    let html = '<div style="font-family: Fredoka, sans-serif; font-size: 13px; font-weight: 600; color: #6B7280; text-transform: uppercase; margin-bottom: 8px;">The 5 Original Errors</div>';

    issues.forEach(issue => {
        html += '<div class="fix-result-item ' + (issue.status === 'fixed' ? 'found' : 'missed') + '">' +
            '<span class="fix-icon">' + (issue.status === 'fixed' ? '✅' : '❌') + '</span>' +
            '<span>' + issue.msg + '<span class="fix-rule">' + issue.rule + '</span></span></div>';
    });

    // Bonus issues
    if (bonusIssues.length > 0) {
        html += '<div style="font-family: Fredoka, sans-serif; font-size: 13px; font-weight: 600; color: var(--challenge-dark); text-transform: uppercase; margin: 14px 0 8px;">Other Things to Watch</div>';
        bonusIssues.forEach(issue => {
            html += '<div class="fix-result-item missed" style="background: #FFFBEB; border-color: var(--challenge-medium);">' +
                '<span class="fix-icon">⚠️</span>' +
                '<span>' + issue.msg + '<span class="fix-rule">' + issue.rule + '</span></span></div>';
        });
    }

    // Score
    let scoreClass, scoreMsg;
    const totalIssues = fixes + bonusIssues.length;
    if (fixes === 5 && bonusIssues.length === 0) {
        scoreClass = 'perfect';
        scoreMsg = '🌟 Perfect! You found all 5 errors and your sentence is clean!';
    } else if (fixes === 5) {
        scoreClass = 'good';
        scoreMsg = '👏 You found all 5 original errors! But check the warnings above.';
    } else if (fixes >= 3) {
        scoreClass = 'good';
        scoreMsg = '👏 You found ' + fixes + ' of 5 errors. Review the ones you missed!';
    } else {
        scoreClass = 'needs-work';
        scoreMsg = 'You found ' + fixes + ' of 5 errors. Read each explanation — you\'ll nail it next time!';
    }
    html += '<div class="fix-score ' + scoreClass + '">' + scoreMsg + '</div>';

    // Always show the correct sentence for reference
    html += '<div style="font-family: Quicksand, sans-serif; font-size: 14px; color: #374151; background: #F9FAFB; border: 1.5px solid #E5E7EB; border-radius: 10px; padding: 10px 14px; margin-top: 10px;">' +
        '<strong>Correct sentence:</strong> Michigan is bordered by four of the five Great Lakes and has two peninsulas.</div>';

    results.innerHTML = html;
    saveAll();
}

// Grammar Check (textarea-based exercises)
function checkGrammar() {
    const section = document.getElementById('section-grammar');
    const textareas = section.querySelectorAll('textarea[data-section="grammar"]');
    let filled = 0;
    textareas.forEach(ta => { if (ta.value.trim().length > 0) filled++; });
    const fb = document.getElementById('grammar-fb');
    showFeedback(fb, filled === textareas.length, filled + ' of ' + textareas.length + ' answers written!');
    saveAll();
}

// ==========================================
// SPELLING TTS
// ==========================================
function speakWord(el) {
    // Get the full word text, ignoring inner span markup
    const word = el.textContent.trim().replace(/\s+/g, '');
    if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel();
        const utt = createUtterance(word, 0.85);
        window.speechSynthesis.speak(utt);
        el.style.transform = 'scale(1.1)';
        el.style.background = 'var(--warmup-light)';
        el.style.borderColor = 'var(--warmup-primary)';
        setTimeout(() => { el.style.transform = ''; el.style.background = ''; el.style.borderColor = ''; }, 600);
    }
}

// ==========================================
// TIMER
// ==========================================
let timerSeconds = 20 * 60;
let timerInterval = null;
let timerRunning = false;

function updateTimerDisplay() {
    const mins = Math.floor(timerSeconds / 60);
    const secs = timerSeconds % 60;
    document.getElementById('timerDisplay').textContent = mins.toString().padStart(2,'0') + ':' + secs.toString().padStart(2,'0');
}

function toggleTimer() {
    const btn = document.getElementById('timerStartBtn');
    if (timerRunning) {
        clearInterval(timerInterval);
        timerRunning = false;
        btn.textContent = 'Resume';
        btn.classList.remove('active');
    } else {
        timerRunning = true;
        btn.textContent = 'Pause';
        btn.classList.add('active');
        timerInterval = setInterval(() => {
            if (timerSeconds > 0) {
                timerSeconds--;
                updateTimerDisplay();
            } else {
                clearInterval(timerInterval);
                timerRunning = false;
                btn.textContent = 'Done!';
                btn.classList.remove('active');
                document.getElementById('timerDisplay').style.color = 'var(--correct)';
                document.getElementById('timerDisplay').textContent = "Time's up!";
                playTimerChime();
            }
        }, 1000);
    }
    saveAll();
}

function resetTimer() {
    clearInterval(timerInterval);
    timerRunning = false;
    timerSeconds = 20 * 60;
    updateTimerDisplay();
    document.getElementById('timerDisplay').style.color = '';
    document.getElementById('timerStartBtn').textContent = 'Start';
    document.getElementById('timerStartBtn').classList.remove('active');
    saveAll();
}

// ==========================================
// PRINT MODE
// ==========================================
function togglePrintToolbar() {
    const tb = document.getElementById('printToolbar');
    const isShowing = tb.style.display === 'none';
    tb.style.display = isShowing ? 'flex' : 'none';
    document.body.style.paddingBottom = isShowing ? '70px' : '';
    if (isShowing) {
        document.body.classList.add('print-blank');
    } else {
        document.body.classList.remove('print-blank', 'print-portfolio');
    }
}

function printExperiment() {
    document.body.classList.remove('print-blank', 'print-portfolio');
    document.body.classList.add('print-blank');
    const tb = document.getElementById('printToolbar');
    tb.style.display = 'flex';
    document.body.style.paddingBottom = '70px';
    document.querySelectorAll('.print-mode-btn').forEach(b => b.classList.remove('active'));
    tb.querySelector('.print-mode-btn').classList.add('active');
    window.print();
}

function setPrintMode(mode, btn) {
    document.body.classList.remove('print-blank', 'print-portfolio');
    document.body.classList.add('print-' + mode);
    document.querySelectorAll('.print-mode-btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
}

function togglePaper(label) {
    const cb = label.querySelector('input');
    setTimeout(() => {
        if (cb.checked) label.classList.add('checked');
        else label.classList.remove('checked');
        saveAll();
    }, 0);
}

// ==========================================
// RUBRIC ENGINE — Client-side assessment
// ==========================================
const RUBRIC_HISTORY_KEY = () => (activeProfileId ? 'rootaccess-' + activeProfileId + '-rubric-history' : 'rootaccess-rubric-history');

function assessField(el) {
    const type = el.dataset.rubricType;
    if (!type) return null;
    const val = (el.value || el.textContent || '').trim();
    if (!val) return { level: 'empty', score: 0, feedback: '' };

    const words = val.split(/\s+/).filter(w => w.length > 0);
    const wordCount = words.length;
    const minWords = parseInt(el.dataset.rubricMinWords) || 0;
    const keywordsStr = el.dataset.rubricKeywords || '';
    const keywords = keywordsStr ? keywordsStr.split(',').map(k => k.trim()) : [];
    const requiredVocabStr = el.dataset.rubricRequiredVocab || '';
    const requiredVocab = requiredVocabStr ? requiredVocabStr.split(',').map(v => v.trim()) : [];
    const structureStr = el.dataset.rubricStructure || '';
    const structures = structureStr ? structureStr.split(',').map(s => s.trim()) : [];
    const lowerVal = val.toLowerCase();

    let score = 0;
    let maxScore = 0;
    let feedback = [];
    let strengths = [];

    // Word count check
    if (minWords > 0) {
        maxScore += 2;
        if (wordCount >= minWords) { score += 2; strengths.push('Good length!'); }
        else if (wordCount >= Math.ceil(minWords * 0.6)) { score += 1; feedback.push('Try adding a bit more detail — aim for at least ' + minWords + ' words.'); }
        else { feedback.push('Your answer is pretty short. Try to write at least ' + minWords + ' words for a complete response.'); }
    }

    // Keyword matching
    if (keywords.length > 0) {
        maxScore += 3;
        let matched = 0;
        keywords.forEach(kw => { if (lowerVal.includes(kw.toLowerCase())) matched++; });
        const kwRatio = matched / keywords.length;
        if (kwRatio >= 0.4) { score += 3; strengths.push('Great use of key details!'); }
        else if (kwRatio >= 0.2) { score += 2; feedback.push('You\'re on the right track. Try including more specific details from the text.'); }
        else if (matched > 0) { score += 1; feedback.push('You mentioned some key ideas. Look back at the passage for more details to include.'); }
        else { feedback.push('Try to use specific words and details from the passage in your answer.'); }
    }

    // Required vocabulary
    if (requiredVocab.length > 0) {
        maxScore += 2;
        let vocabFound = 0;
        let vocabMissing = [];
        requiredVocab.forEach(v => {
            if (lowerVal.includes(v.toLowerCase())) vocabFound++;
            else vocabMissing.push(v);
        });
        if (vocabFound === requiredVocab.length) { score += 2; strengths.push('You used all the required vocabulary!'); }
        else if (vocabFound > 0) { score += 1; feedback.push('Don\'t forget to use these vocabulary words: ' + vocabMissing.join(', ')); }
        else { feedback.push('Remember to include these vocabulary words in your answer: ' + requiredVocab.join(', ')); }
    }

    // Structure checks
    if (structures.length > 0) {
        maxScore += 2;
        let structScore = 0;
        structures.forEach(s => {
            if (s === 'has-subject' && /^[A-Z]/.test(val) && words.length >= 3) structScore++;
            else if (s === 'has-verb') structScore++; // simplified
            else if (s === 'ends-punctuation' && /[.!?]$/.test(val)) structScore++;
            else if (s === 'names-both') {
                const hasLP = lowerVal.includes('lower') || lowerVal.includes('lp');
                const hasUP = lowerVal.includes('upper') || lowerVal.includes('up');
                if (hasLP && hasUP) { structScore++; strengths.push('You compared both peninsulas!'); }
                else { feedback.push('Make sure to mention BOTH the Lower and Upper Peninsula.'); }
            }
            else if (s === 'what-tested' && (lowerVal.includes('tested') || lowerVal.includes('experiment') || lowerVal.includes('ramp'))) structScore++;
            else if (s === 'what-happened' && (lowerVal.includes('found') || lowerVal.includes('happened') || lowerVal.includes('result') || lowerVal.includes('more') || lowerVal.includes('higher'))) structScore++;
            else if (s === 'what-it-means' && (lowerVal.includes('shows') || lowerVal.includes('means') || lowerVal.includes('proves') || lowerVal.includes('because') || lowerVal.includes('therefore'))) structScore++;
        });
        if (structScore >= structures.length * 0.7) { score += 2; }
        else if (structScore > 0) { score += 1; }
    }

    // Type-specific checks
    if (type === 'exact-match') {
        const answer = (el.dataset.rubricAnswer || '').toLowerCase().replace(/\s/g, '');
        const altStr = el.dataset.rubricAlt || '';
        const alts = altStr ? altStr.split('|').map(a => a.toLowerCase().replace(/\s/g, '')) : [];
        const cleaned = lowerVal.replace(/\s/g, '');
        if (cleaned === answer || alts.includes(cleaned)) {
            return { level: 'mastery', score: 5, feedback: '', strengths: ['Correct!'] };
        } else {
            return { level: 'developing', score: 1, feedback: ['Check your answer — make sure each digit is in the right place value.'], strengths: [] };
        }
    }

    // Determine mastery level
    if (maxScore === 0) maxScore = 1;
    const pct = score / maxScore;
    let level;
    if (pct >= 0.8) level = 'mastery';
    else if (pct >= 0.5) level = 'proficient';
    else if (pct >= 0.25) level = 'developing';
    else level = 'beginning';

    return { level, score, maxScore, feedback, strengths, wordCount };
}

function getLevelLabel(level) {
    const labels = {
        mastery: { text: 'Excellent Work!', color: '#059669', icon: '\u2B50' },
        proficient: { text: 'Good Job!', color: '#2563EB', icon: '\uD83D\uDC4D' },
        developing: { text: 'Getting There!', color: '#F59E0B', icon: '\uD83D\uDCAA' },
        beginning: { text: 'Keep Going!', color: '#EA580C', icon: '\u270D\uFE0F' },
        empty: { text: 'Not answered yet', color: '#94A3B8', icon: '\u2014' }
    };
    return labels[level] || labels.beginning;
}

async function reviewSection(sectionName) {
    const section = document.getElementById('section-' + sectionName);
    if (!section) return;

    const rubricFields = section.querySelectorAll('[data-rubric-type]');
    if (rubricFields.length === 0) return;

    // Remove any previous review
    section.querySelectorAll('.rubric-result').forEach(el => el.remove());

    let sectionResults = [];

    rubricFields.forEach(field => {
        const result = assessField(field);
        if (!result) return;
        sectionResults.push(result);

        const label = getLevelLabel(result.level);
        const div = document.createElement('div');
        div.className = 'rubric-result rubric-' + result.level;
        let html = '<div class="rubric-header"><span class="rubric-icon">' + label.icon + '</span><span class="rubric-level" style="color:' + label.color + ';">' + label.text + '</span></div>';

        if (result.strengths && result.strengths.length > 0) {
            html += '<div class="rubric-strengths">' + result.strengths.join(' ') + '</div>';
        }
        if (result.feedback && result.feedback.length > 0) {
            html += '<div class="rubric-tips">' + result.feedback.join(' ') + '</div>';
        }
        div.innerHTML = html;
        field.parentNode.insertBefore(div, field.nextSibling);
    });

    // Track rubric review event
    trackEvent('rubric_review', { section: sectionName, results: sectionResults.length });

    // Save assessment history for trend tracking
    const history = (await localforage.getItem(RUBRIC_HISTORY_KEY())) || {};
    const dayKey = STORAGE_KEY;
    if (!history[dayKey]) history[dayKey] = {};
    history[dayKey][sectionName] = {
        timestamp: Date.now(),
        results: sectionResults.map(r => ({ level: r.level, score: r.score, maxScore: r.maxScore }))
    };
    await localforage.setItem(RUBRIC_HISTORY_KEY(), history);

    // Show section-level encouragement
    showSectionEncouragement(section, sectionResults, sectionName, history);
}

async function showSectionEncouragement(section, results, sectionName, history) {
    // Remove old encouragement
    section.querySelectorAll('.section-encouragement').forEach(el => el.remove());

    const masteryCount = results.filter(r => r.level === 'mastery').length;
    const proficientCount = results.filter(r => r.level === 'proficient').length;
    const emptyCount = results.filter(r => r.level === 'empty').length;
    const total = results.length;

    if (emptyCount === total) return; // nothing to show

    let msg = '';
    let msgClass = '';

    if (masteryCount === total) {
        msg = '\uD83C\uDF1F Amazing! You nailed every question in this section!';
        msgClass = 'encourage-mastery';
    } else if (masteryCount + proficientCount >= total * 0.7) {
        msg = '\uD83D\uDCAA Strong work! You\'re showing real understanding. Check the tips above to push even further.';
        msgClass = 'encourage-good';
    } else if (emptyCount > total / 2) {
        msg = '\u270D\uFE0F Looks like some questions are still blank. Give them a try — you might know more than you think!';
        msgClass = 'encourage-start';
    } else {
        msg = '\uD83D\uDE80 You\'re building your skills! Read the tips above and try revising your answers.';
        msgClass = 'encourage-growing';
    }

    // Check for improvement over time
    const dayKey = STORAGE_KEY;
    const prev = history[dayKey] && history[dayKey][sectionName + '-prev'];
    if (prev) {
        const prevMastery = prev.results.filter(r => r.level === 'mastery').length;
        if (masteryCount > prevMastery) {
            msg += ' You improved since last time — keep it up!';
        }
    }
    // Store current as "prev" for next review
    if (history[dayKey] && history[dayKey][sectionName]) {
        history[dayKey][sectionName + '-prev'] = history[dayKey][sectionName];
        await localforage.setItem(RUBRIC_HISTORY_KEY(), history);
    }

    const div = document.createElement('div');
    div.className = 'section-encouragement ' + msgClass;
    div.innerHTML = msg;

    const completeEl = section.querySelector('.section-complete');
    if (completeEl) section.insertBefore(div, completeEl);
    else section.appendChild(div);
}

// ==========================================
// OCR SCANNER
// ==========================================
let ocrTargetField = null;
let ocrWorker = null;

function openOCRModal(targetTextarea) {
    ocrTargetField = targetTextarea;
    document.getElementById('ocrModal').classList.add('open');
    document.getElementById('ocrPreview').style.display = 'none';
    document.getElementById('ocrProgress').classList.remove('show');
    document.getElementById('ocrResultArea').classList.remove('show');
    document.getElementById('ocrSaveBtn').style.display = 'none';
    document.getElementById('ocrRetakeBtn').style.display = 'none';
    document.getElementById('ocrCaptureArea').style.display = '';
    document.getElementById('ocrUpgradeHint').style.display = 'none';
    document.getElementById('ocrFileInput').value = '';
}

function closeOCRModal() {
    document.getElementById('ocrModal').classList.remove('open');
    ocrTargetField = null;
}

function retakeOCR() {
    document.getElementById('ocrPreview').style.display = 'none';
    document.getElementById('ocrResultArea').classList.remove('show');
    document.getElementById('ocrSaveBtn').style.display = 'none';
    document.getElementById('ocrRetakeBtn').style.display = 'none';
    document.getElementById('ocrCaptureArea').style.display = '';
    document.getElementById('ocrProgress').classList.remove('show');
    document.getElementById('ocrUpgradeHint').style.display = 'none';
    document.getElementById('ocrFileInput').value = '';
}

async function handleOCRFile(input) {
    if (!input.files || !input.files[0]) return;
    const file = input.files[0];

    // Show preview
    const preview = document.getElementById('ocrPreview');
    const reader = new FileReader();
    reader.onload = function(e) {
        preview.innerHTML = '<img src="' + e.target.result + '" alt="Scanned image">';
        preview.style.display = 'block';
        runOCR(e.target.result);
    };
    reader.readAsDataURL(file);

    document.getElementById('ocrCaptureArea').style.display = 'none';
}

async function runOCR(imageDataUrl) {
    const progress = document.getElementById('ocrProgress');
    const progressFill = document.getElementById('ocrProgressFill');
    const progressText = document.getElementById('ocrProgressText');
    progress.classList.add('show');
    progressFill.style.width = '10%';
    progressText.textContent = 'Loading OCR engine...';

    try {
        // Use Tesseract.js v5 API
        progressFill.style.width = '30%';
        progressText.textContent = 'Recognizing text...';

        const result = await Tesseract.recognize(imageDataUrl, 'eng', {
            logger: m => {
                if (m.status === 'recognizing text') {
                    const pct = Math.round(30 + (m.progress * 60));
                    progressFill.style.width = pct + '%';
                    progressText.textContent = 'Recognizing text... ' + Math.round(m.progress * 100) + '%';
                }
            }
        });

        progressFill.style.width = '100%';
        progressText.textContent = 'Done!';

        const text = result.data.text.trim();
        const confidence = Math.round(result.data.confidence);

        document.getElementById('ocrResultText').value = text;
        document.getElementById('ocrConfidence').textContent = 'Confidence: ' + confidence + '%';

        // Show upgrade hint if confidence is low
        if (confidence < 70) {
            document.getElementById('ocrUpgradeHint').style.display = 'block';
        }

        document.getElementById('ocrResultArea').classList.add('show');
        document.getElementById('ocrSaveBtn').style.display = '';
        document.getElementById('ocrRetakeBtn').style.display = '';

        setTimeout(() => { progress.classList.remove('show'); }, 800);

        trackEvent('ocr_scan', { confidence: confidence, textLength: text.length });

    } catch (err) {
        progressText.textContent = 'OCR failed — try a clearer photo.';
        progressFill.style.width = '0%';
        document.getElementById('ocrRetakeBtn').style.display = '';
    }
}

function saveOCRResult() {
    const text = document.getElementById('ocrResultText').value;
    if (ocrTargetField && text) {
        ocrTargetField.value = text;
        ocrTargetField.classList.add('has-content');
        ocrTargetField.dispatchEvent(new Event('input'));
        saveAll();
    }
    closeOCRModal();
}

// Add scan buttons to paper-checkbox labels
function addScanButtons() {
    document.querySelectorAll('.paper-checkbox').forEach(label => {
        if (label.querySelector('.scan-btn')) return;
        const section = label.querySelector('input').dataset.section;
        const btn = document.createElement('button');
        btn.className = 'scan-btn';
        btn.textContent = '\uD83D\uDCF7 Scan';
        btn.onclick = function(e) {
            e.preventDefault();
            e.stopPropagation();
            // Find the first textarea in this section
            const sectionEl = document.getElementById('section-' + section);
            if (sectionEl) {
                const ta = sectionEl.querySelector('textarea.answer-textarea');
                if (ta) openOCRModal(ta);
            }
        };
        label.appendChild(btn);
    });
}

// ==========================================
// ANALYTICS
// ==========================================
const ANALYTICS_KEY = 'rootaccess-analytics';

async function trackEvent(eventName, data) {
    const events = (await localforage.getItem(ANALYTICS_KEY)) || [];
    events.push({
        event: eventName,
        data: data || {},
        timestamp: Date.now(),
        profile: activeProfileId || 'none',
        day: DAY_ID
    });
    if (events.length > 500) events.splice(0, events.length - 500);
    await localforage.setItem(ANALYTICS_KEY, events);
}

// ==========================================
// INIT
// ==========================================
// Register service worker for PWA + offline + iOS data persistence
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').catch(() => {});
}

window.addEventListener('DOMContentLoaded', async () => {
    try {
        // ?reset=true clears all data for a clean demo
        if (new URLSearchParams(window.location.search).get('reset') === 'true') {
            try { await localforage.clear(); } catch(e) { console.warn('localforage clear failed:', e); }
            try { localStorage.clear(); } catch(e) {}
            window.history.replaceState({}, '', window.location.pathname);
            console.log('All data cleared.');
        }
        // Load active profile first — sets STORAGE_KEY
        await getActiveProfile();
        const profileName = await getProfileName();
        if (profileName) {
            const nameInput = document.getElementById('studentName');
            nameInput.value = profileName;
            nameInput.readOnly = true;
            nameInput.style.opacity = '0.8';
            nameInput.title = 'Set from profile — switch student on the Hub';
        }
    } catch(e) { console.warn('Profile load:', e); }
    // Show default page before loading saved state
    showPage('warmup');
    try {
        await loadAll();
        updateProgress();
        await populateBookDatalist();
        await trackEvent('page_view', { page: DAY_ID });
        addScanButtons();
    } catch(e) { console.warn('Init load:', e); }
});
</script>
</body>
</html>
